<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç®¡ç†åå° - äº‘ç«¯è‡ªä¹ å®¤</title>
    <link rel="stylesheet" href="/css/variables.css">
    <link rel="stylesheet" href="/css/components.css">
    <style>
        body {
            background: var(--color-card-bg);
        }

        .page-container {
            min-height: 100vh;
            padding: var(--space-4);
            padding-bottom: var(--space-6);
        }

        /* é¡¶éƒ¨æ  */
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-5);
            padding: var(--space-4);
            background: var(--gradient-primary);
            border-radius: var(--radius-xl);
            color: #fff;
        }

        .admin-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
        }

        .admin-subtitle {
            font-size: var(--font-size-sm);
            opacity: 0.9;
            margin-top: 4px;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: #fff;
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-full);
            font-size: var(--font-size-sm);
            cursor: pointer;
        }

        /* Tab å¯¼èˆª */
        .tab-nav {
            display: flex;
            background: #fff;
            border-radius: var(--radius-lg);
            padding: 4px;
            margin-bottom: var(--space-5);
            box-shadow: var(--shadow-sm);
        }

        .tab-item {
            flex: 1;
            padding: var(--space-3);
            text-align: center;
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-secondary);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .tab-item.active {
            background: var(--color-primary);
            color: #fff;
        }

        /* æ¦‚è§ˆå¡ç‰‡ */
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-3);
            margin-bottom: var(--space-5);
        }

        .overview-card {
            background: #fff;
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            box-shadow: var(--shadow-sm);
        }

        .overview-icon {
            font-size: 24px;
            margin-bottom: var(--space-2);
        }

        .overview-value {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-text-dark);
        }

        .overview-label {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
            margin-top: 4px;
        }

        /* æ•°æ®è¡¨æ ¼ */
        .data-section {
            background: #fff;
            border-radius: var(--radius-xl);
            padding: var(--space-5);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-5);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
        }

        .section-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-dark);
        }

        .refresh-btn {
            background: var(--color-card-bg);
            border: none;
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* ç”¨æˆ·/åº§ä½åˆ—è¡¨ */
        .list-item {
            display: flex;
            align-items: center;
            padding: var(--space-3);
            border-bottom: 1px solid var(--color-divider);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .list-item:hover {
            background: var(--color-card-bg);
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--color-primary-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-right: var(--space-3);
        }

        .list-info {
            flex: 1;
        }

        .list-name {
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-dark);
        }

        .list-meta {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
            margin-top: 2px;
        }

        .list-stats {
            display: flex;
            gap: var(--space-3);
            margin-top: var(--space-2);
        }

        .stat-item {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
        }

        .stat-item .value {
            font-weight: var(--font-weight-semibold);
            color: var(--color-primary);
        }

        .list-actions {
            display: flex;
            gap: var(--space-2);
        }

        .action-btn-sm {
            padding: 6px 12px;
            border-radius: var(--radius-md);
            border: none;
            font-size: var(--font-size-xs);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .action-btn-sm.primary {
            background: var(--color-primary-bg);
            color: var(--color-primary);
        }

        .action-btn-sm.danger {
            background: var(--color-error-bg);
            color: var(--color-error);
        }

        .action-btn-sm.success {
            background: var(--color-success-bg);
            color: var(--color-success);
        }

        .action-btn-sm.warning {
            background: var(--color-warning-bg);
            color: var(--color-warning);
        }

        /* çŠ¶æ€æ ‡ç­¾ */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
        }

        .status-badge.active {
            background: var(--color-success-bg);
            color: var(--color-success);
        }

        .status-badge.disabled {
            background: var(--color-error-bg);
            color: var(--color-error);
        }

        .status-badge.admin {
            background: var(--color-primary-bg);
            color: var(--color-primary);
        }

        /* æ’è¡Œæ¦œ */
        .ranking-item {
            display: flex;
            align-items: center;
            padding: var(--space-3);
            border-bottom: 1px solid var(--color-divider);
        }

        .ranking-rank {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--color-card-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-bold);
            margin-right: var(--space-3);
        }

        .ranking-rank.top-1 { background: #FFD700; color: #fff; }
        .ranking-rank.top-2 { background: #C0C0C0; color: #fff; }
        .ranking-rank.top-3 { background: #CD7F32; color: #fff; }

        .ranking-info {
            flex: 1;
        }

        .ranking-duration {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            color: var(--color-primary);
        }

        /* æ— æƒé™æç¤º */
        .no-access {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            text-align: center;
        }

        .no-access-icon {
            font-size: 64px;
            margin-bottom: var(--space-4);
        }

        .no-access-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-text-dark);
            margin-bottom: var(--space-2);
        }

        .no-access-desc {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            margin-bottom: var(--space-6);
        }

        /* Tab å†…å®¹ */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading {
            text-align: center;
            padding: var(--space-10);
            color: var(--color-text-secondary);
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: var(--space-4) var(--space-6);
            border-radius: var(--radius-lg);
            font-size: var(--font-size-sm);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
            z-index: var(--z-toast);
        }

        .toast.show {
            opacity: 1;
            visibility: visible;
        }

        /* ç”¨æˆ·è¯¦æƒ…å¼¹çª— */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: #fff;
            border-radius: var(--radius-xl);
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            padding: var(--space-5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-3);
            border-bottom: 1px solid var(--color-divider);
        }

        .modal-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-bold);
            color: var(--color-text-dark);
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--color-card-bg);
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
        }

        .detail-section {
            margin-bottom: var(--space-4);
        }

        .detail-section-title {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-secondary);
            margin-bottom: var(--space-2);
            padding-bottom: var(--space-1);
            border-bottom: 1px solid var(--color-divider);
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-3);
        }

        .detail-item {
            background: var(--color-card-bg);
            padding: var(--space-3);
            border-radius: var(--radius-md);
        }

        .detail-label {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
        }

        .detail-value {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-bold);
            color: var(--color-text-dark);
            margin-top: 2px;
        }

        .detail-value.highlight {
            color: var(--color-primary);
        }

        .chart-container {
            height: 150px;
            background: var(--color-card-bg);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            display: flex;
            align-items: flex-end;
            gap: 4px;
        }

        .chart-bar {
            flex: 1;
            background: var(--color-primary);
            border-radius: var(--radius-sm) var(--radius-sm) 0 0;
            min-height: 4px;
            transition: height 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- æ— æƒé™é¡µé¢ -->
    <div class="page-container" id="noAccessPage" style="display: none;">
        <div class="no-access">
            <div class="no-access-icon">ğŸ”’</div>
            <h1 class="no-access-title">æ— è®¿é—®æƒé™</h1>
            <p class="no-access-desc">æ‚¨æ²¡æœ‰ç®¡ç†å‘˜æƒé™ï¼Œæ— æ³•è®¿é—®æ­¤é¡µé¢</p>
            <a href="/index.html" class="btn btn-primary">è¿”å›é¦–é¡µ</a>
        </div>
    </div>

    <!-- ç®¡ç†åå°ä¸»é¡µé¢ -->
    <div class="page-container" id="adminPage" style="display: none;">
        <!-- é¡¶éƒ¨æ  -->
        <div class="admin-header">
            <div>
                <h1 class="admin-title">ç®¡ç†åå°</h1>
                <p class="admin-subtitle">æ¬¢è¿ï¼Œ<span id="adminName">ç®¡ç†å‘˜</span></p>
            </div>
            <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
        </div>

        <!-- Tab å¯¼èˆª -->
        <div class="tab-nav">
            <div class="tab-item active" data-tab="overview" onclick="switchTab('overview')">æ¦‚è§ˆ</div>
            <div class="tab-item" data-tab="seats" onclick="switchTab('seats')">åº§ä½</div>
            <div class="tab-item" data-tab="users" onclick="switchTab('users')">ç”¨æˆ·</div>
            <div class="tab-item" data-tab="ranking" onclick="switchTab('ranking')">æ’è¡Œ</div>
        </div>

        <!-- æ¦‚è§ˆ Tab -->
        <div class="tab-content active" id="tab-overview">
            <div class="overview-grid">
                <div class="overview-card">
                    <div class="overview-icon">ğŸ‘¥</div>
                    <div class="overview-value" id="todayActiveUsers">-</div>
                    <div class="overview-label">ä»Šæ—¥æ´»è·ƒç”¨æˆ·</div>
                </div>
                <div class="overview-card">
                    <div class="overview-icon">â±ï¸</div>
                    <div class="overview-value" id="todayTotalHours">-</div>
                    <div class="overview-label">ä»Šæ—¥å­¦ä¹ æ—¶é•¿</div>
                </div>
                <div class="overview-card">
                    <div class="overview-icon">ğŸ¯</div>
                    <div class="overview-value" id="todayFocusCount">-</div>
                    <div class="overview-label">ä»Šæ—¥ä¸“æ³¨æ¬¡æ•°</div>
                </div>
                <div class="overview-card">
                    <div class="overview-icon">ğŸ’º</div>
                    <div class="overview-value" id="currentOccupied">-</div>
                    <div class="overview-label">å½“å‰åœ¨åº§</div>
                </div>
            </div>

            <!-- å¿«æ·æ“ä½œ -->
            <div class="data-section">
                <div class="section-header">
                    <h2 class="section-title">å¿«æ·æ“ä½œ</h2>
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-3);">
                    <button class="action-btn-sm primary" style="padding: var(--space-4);" onclick="switchTab('seats')">
                        ğŸª‘ åº§ä½ç®¡ç†
                    </button>
                    <button class="action-btn-sm success" style="padding: var(--space-4);" onclick="switchTab('users')">
                        ğŸ‘¤ ç”¨æˆ·ç®¡ç†
                    </button>
                    <button class="action-btn-sm warning" style="padding: var(--space-4);" onclick="switchTab('ranking')">
                        ğŸ† æ’è¡Œæ¦œ
                    </button>
                    <button class="action-btn-sm danger" style="padding: var(--space-4);" onclick="refreshAll()">
                        ğŸ”„ åˆ·æ–°æ•°æ®
                    </button>
                </div>
            </div>
        </div>

        <!-- åº§ä½ç®¡ç† Tab -->
        <div class="tab-content" id="tab-seats">
            <div class="data-section">
                <div class="section-header">
                    <h2 class="section-title">åº§ä½åˆ—è¡¨</h2>
                    <button class="refresh-btn" onclick="loadSeats()">ğŸ”„ åˆ·æ–°</button>
                </div>
                <div id="seatsList" class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- ç”¨æˆ·ç®¡ç† Tab -->
        <div class="tab-content" id="tab-users">
            <div class="data-section">
                <div class="section-header">
                    <h2 class="section-title">ç”¨æˆ·åˆ—è¡¨</h2>
                    <button class="refresh-btn" onclick="loadUsers()">ğŸ”„ åˆ·æ–°</button>
                </div>
                <div id="usersList" class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- æ’è¡Œæ¦œ Tab -->
        <div class="tab-content" id="tab-ranking">
            <div class="data-section">
                <div class="section-header">
                    <h2 class="section-title">å­¦ä¹ æ—¶é•¿æ’è¡Œ</h2>
                    <button class="refresh-btn" onclick="loadRanking()">ğŸ”„ åˆ·æ–°</button>
                </div>
                <div id="rankingList" class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- ç”¨æˆ·è¯¦æƒ…å¼¹çª— -->
    <div class="modal-overlay" id="userDetailModal" onclick="closeUserDetail(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">ç”¨æˆ·è¯¦æƒ…</h3>
                <button class="modal-close" onclick="closeUserDetail()">&times;</button>
            </div>
            <div id="userDetailContent">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            checkAdminAccess();
        });

        // æ£€æŸ¥ç®¡ç†å‘˜æƒé™
        async function checkAdminAccess() {
            try {
                const res = await fetch('/api/admin/check');
                const data = await res.json();
                
                if (data.success && data.isAdmin) {
                    document.getElementById('adminPage').style.display = 'block';
                    document.getElementById('adminName').textContent = data.username;
                    loadOverview();
                    loadSeats();
                    loadUsers();
                    loadRanking();
                } else {
                    document.getElementById('noAccessPage').style.display = 'block';
                }
            } catch (err) {
                console.error('æƒé™æ£€æŸ¥å¤±è´¥:', err);
                document.getElementById('noAccessPage').style.display = 'block';
            }
        }

        // åˆ‡æ¢ Tab
        function switchTab(tabId) {
            document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            
            document.querySelector(`.tab-item[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }

        // åŠ è½½æ¦‚è§ˆæ•°æ®
        async function loadOverview() {
            try {
                const res = await fetch('/api/admin/stats/overview');
                const data = await res.json();
                console.log('æ¦‚è§ˆæ•°æ®:', data);
                
                if (data.success) {
                    document.getElementById('todayActiveUsers').textContent = data.activeUsers || 0;
                    document.getElementById('todayTotalHours').textContent = formatHours(data.totalDuration || 0);
                    document.getElementById('todayFocusCount').textContent = data.focusCount || 0;
                    document.getElementById('currentOccupied').textContent = data.occupiedSeats || 0;
                } else {
                    console.error('æ¦‚è§ˆæ•°æ®åŠ è½½å¤±è´¥:', data.message);
                    // æ˜¾ç¤ºé”™è¯¯æç¤º
                    document.getElementById('todayActiveUsers').textContent = '0';
                    document.getElementById('todayTotalHours').textContent = '0h';
                    document.getElementById('todayFocusCount').textContent = '0';
                    document.getElementById('currentOccupied').textContent = '0';
                }
            } catch (err) {
                console.error('åŠ è½½æ¦‚è§ˆå¤±è´¥:', err);
                document.getElementById('todayActiveUsers').textContent = 'é”™è¯¯';
                document.getElementById('todayTotalHours').textContent = 'é”™è¯¯';
                document.getElementById('todayFocusCount').textContent = 'é”™è¯¯';
                document.getElementById('currentOccupied').textContent = 'é”™è¯¯';
            }
        }

        // åŠ è½½åº§ä½åˆ—è¡¨
        async function loadSeats() {
            try {
                const res = await fetch('/api/admin/seats');
                const data = await res.json();
                
                if (data.success) {
                    renderSeats(data.seats);
                } else {
                    document.getElementById('seatsList').innerHTML = '<p>åŠ è½½å¤±è´¥</p>';
                }
            } catch (err) {
                console.error('åŠ è½½åº§ä½å¤±è´¥:', err);
                document.getElementById('seatsList').innerHTML = '<p>ç½‘ç»œé”™è¯¯</p>';
            }
        }

        // æ¸²æŸ“åº§ä½åˆ—è¡¨
        function renderSeats(seats) {
            if (!seats || seats.length === 0) {
                document.getElementById('seatsList').innerHTML = '<p>æš‚æ— åº§ä½æ•°æ®</p>';
                return;
            }

            const statusMap = {
                'available': { icon: 'ğŸ’º', text: 'ç©ºé—²', class: 'success' },
                'occupied': { icon: 'ğŸ‘¤', text: 'ä½¿ç”¨ä¸­', class: 'warning' },
                'maintenance': { icon: 'ğŸ”§', text: 'ç»´æŠ¤ä¸­', class: 'danger' }
            };

            document.getElementById('seatsList').innerHTML = seats.map(item => {
                // åç«¯è¿”å›æ ¼å¼: { seat: {...}, currentUser: "xxx" }
                const seat = item.seat || item;
                const currentUser = item.currentUser;
                const status = seat.status || 'available';
                const seatNumber = seat.seatNumber || seat.seat_number || 'æœªçŸ¥';
                const powerOn = seat.powerOn === 1 || seat.powerOn === true || seat.power_on === 1;
                const seatId = seat.id;
                
                const info = statusMap[status] || statusMap['available'];
                return `
                    <div class="list-item">
                        <div class="list-avatar">${info.icon}</div>
                        <div class="list-info">
                            <div class="list-name">${escapeHtml(seatNumber)}</div>
                            <div class="list-meta">
                                ç”µæº: ${powerOn ? 'ğŸŸ¢ å·²é€šç”µ' : 'âšª å·²æ–­ç”µ'}
                                ${currentUser ? ` | ç”¨æˆ·: ${escapeHtml(currentUser)}` : ''}
                            </div>
                        </div>
                        <div class="list-actions">
                            ${status === 'occupied' ? 
                                `<button class="action-btn-sm danger" onclick="releaseSeat(${seatId})">å¼ºåˆ¶é‡Šæ”¾</button>` : 
                                ''}
                            ${status === 'maintenance' ?
                                `<button class="action-btn-sm success" onclick="setMaintenance(${seatId}, false)">æ¢å¤æ­£å¸¸</button>` :
                                `<button class="action-btn-sm warning" onclick="setMaintenance(${seatId}, true)">è®¾ä¸ºç»´æŠ¤</button>`}
                            <button class="action-btn-sm ${powerOn ? 'danger' : 'primary'}" onclick="togglePower(${seatId}, ${!powerOn})">
                                ${powerOn ? 'æ–­ç”µ' : 'é€šç”µ'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // åŠ è½½ç”¨æˆ·åˆ—è¡¨ï¼ˆå¸¦ç»Ÿè®¡æ•°æ®ï¼‰
        async function loadUsers() {
            try {
                const res = await fetch('/api/admin/users?withStats=true');
                const data = await res.json();
                
                if (data.success) {
                    renderUsers(data.users);
                } else {
                    document.getElementById('usersList').innerHTML = '<p>åŠ è½½å¤±è´¥</p>';
                }
            } catch (err) {
                console.error('åŠ è½½ç”¨æˆ·å¤±è´¥:', err);
                document.getElementById('usersList').innerHTML = '<p>ç½‘ç»œé”™è¯¯</p>';
            }
        }

        // æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨
        function renderUsers(users) {
            if (!users || users.length === 0) {
                document.getElementById('usersList').innerHTML = '<p>æš‚æ— ç”¨æˆ·æ•°æ®</p>';
                return;
            }

            document.getElementById('usersList').innerHTML = users.map(user => `
                <div class="list-item" onclick="showUserDetail(${user.id})">
                    <div class="list-avatar">${user.status === 0 ? 'ğŸš«' : 'ğŸ‘¤'}</div>
                    <div class="list-info">
                        <div class="list-name">
                            ${escapeHtml(user.username || user.nickname || 'æœªå‘½å')}
                            ${user.role === 'admin' ? '<span class="status-badge admin">ç®¡ç†å‘˜</span>' : ''}
                            ${user.status === 0 ? '<span class="status-badge disabled">å·²ç¦ç”¨</span>' : ''}
                        </div>
                        <div class="list-stats">
                            <span class="stat-item">ä»Šæ—¥: <span class="value">${user.todayFocusCount || 0}</span>æ¬¡ / <span class="value">${formatHours(user.todayDuration || 0)}</span></span>
                            <span class="stat-item">æœ¬æœˆ: <span class="value">${user.monthFocusCount || 0}</span>æ¬¡</span>
                        </div>
                        <div class="list-meta">
                            æ€»å­¦ä¹ : ${formatHours(user.totalDuration || 0)} | æ‰«ç è¿›é—¨: ${user.totalAccessCount || 0}æ¬¡ | åˆ›å»º: ${formatDate(user.createdAt)}
                        </div>
                    </div>
                    <div class="list-actions" onclick="event.stopPropagation()">
                        ${user.status === 1 ?
                            `<button class="action-btn-sm danger" onclick="toggleUserStatus(${user.id}, 0)">ç¦ç”¨</button>` :
                            `<button class="action-btn-sm success" onclick="toggleUserStatus(${user.id}, 1)">å¯ç”¨</button>`}
                    </div>
                </div>
            `).join('');
        }
        
        // HTMLè½¬ä¹‰å‡½æ•°ï¼Œé˜²æ­¢XSSæ”»å‡»
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ˜¾ç¤ºç”¨æˆ·è¯¦æƒ…å¼¹çª—
        async function showUserDetail(userId) {
            document.getElementById('userDetailModal').classList.add('show');
            document.getElementById('userDetailContent').innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            
            try {
                const res = await fetch(`/api/admin/users/${userId}/detail`);
                const data = await res.json();
                
                if (data.success) {
                    renderUserDetail(data.user);
                } else {
                    document.getElementById('userDetailContent').innerHTML = '<p>åŠ è½½å¤±è´¥</p>';
                }
            } catch (err) {
                console.error('åŠ è½½ç”¨æˆ·è¯¦æƒ…å¤±è´¥:', err);
                document.getElementById('userDetailContent').innerHTML = '<p>ç½‘ç»œé”™è¯¯</p>';
            }
        }

        // æ¸²æŸ“ç”¨æˆ·è¯¦æƒ…
        function renderUserDetail(user) {
            document.getElementById('modalTitle').textContent = `${user.nickname || user.username} çš„è¯¦ç»†æ•°æ®`;
            
            // è®¡ç®—å›¾è¡¨æ•°æ®
            const dailyStats = user.dailyStats || [];
            const maxDuration = Math.max(...dailyStats.map(d => d.duration || 0), 1);
            
            document.getElementById('userDetailContent').innerHTML = `
                <!-- åŸºæœ¬ä¿¡æ¯ -->
                <div class="detail-section">
                    <div class="detail-section-title">ğŸ“‹ åŸºæœ¬ä¿¡æ¯</div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">ç”¨æˆ·å</div>
                            <div class="detail-value">${user.username}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">è§’è‰²</div>
                            <div class="detail-value">${user.role === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">çŠ¶æ€</div>
                            <div class="detail-value">${user.status === 1 ? 'âœ… æ­£å¸¸' : 'ğŸš« å·²ç¦ç”¨'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">è¿ç»­å­¦ä¹ </div>
                            <div class="detail-value highlight">${user.streakDays || 0}å¤©</div>
                        </div>
                    </div>
                </div>

                <!-- ä»Šæ—¥æ•°æ® -->
                <div class="detail-section">
                    <div class="detail-section-title">ğŸ“… ä»Šæ—¥æ•°æ®</div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">ä¸“æ³¨æ¬¡æ•°</div>
                            <div class="detail-value highlight">${user.todayFocusCount || 0}æ¬¡</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">å­¦ä¹ æ—¶é•¿</div>
                            <div class="detail-value highlight">${formatHours(user.todayDuration || 0)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">æ‰«ç è¿›é—¨</div>
                            <div class="detail-value">${user.todayAccessCount || 0}æ¬¡</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">è·å¾—ç»éªŒ</div>
                            <div class="detail-value">${user.todayExpEarned || 0}</div>
                        </div>
                    </div>
                </div>

                <!-- æœ¬å‘¨æ•°æ® -->
                <div class="detail-section">
                    <div class="detail-section-title">ğŸ“Š æœ¬å‘¨æ•°æ® (æœ€è¿‘7å¤©)</div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">ä¸“æ³¨æ¬¡æ•°</div>
                            <div class="detail-value">${user.weekFocusCount || 0}æ¬¡</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">å­¦ä¹ æ—¶é•¿</div>
                            <div class="detail-value">${formatHours(user.weekDuration || 0)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">æ‰«ç è¿›é—¨</div>
                            <div class="detail-value">${user.weekAccessCount || 0}æ¬¡</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">è·å¾—ç»éªŒ</div>
                            <div class="detail-value">${user.weekExpEarned || 0}</div>
                        </div>
                    </div>
                    <div class="chart-container" style="margin-top: var(--space-3);">
                        ${dailyStats.map(day => `
                            <div class="chart-bar" style="height: ${Math.max(((day.duration || 0) / maxDuration) * 100, 5)}%;" title="${day.date}: ${formatHours(day.duration || 0)}"></div>
                        `).join('')}
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 10px; color: var(--color-text-secondary); margin-top: 4px;">
                        ${dailyStats.map(day => `<span>${day.date.slice(5)}</span>`).join('')}
                    </div>
                </div>

                <!-- æœ¬æœˆæ•°æ® -->
                <div class="detail-section">
                    <div class="detail-section-title">ğŸ“† æœ¬æœˆæ•°æ®</div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">ä¸“æ³¨æ¬¡æ•°</div>
                            <div class="detail-value">${user.monthFocusCount || 0}æ¬¡</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">å­¦ä¹ æ—¶é•¿</div>
                            <div class="detail-value">${formatHours(user.monthDuration || 0)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">æ‰«ç è¿›é—¨</div>
                            <div class="detail-value">${user.monthAccessCount || 0}æ¬¡</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">è·å¾—ç»éªŒ</div>
                            <div class="detail-value">${user.monthExpEarned || 0}</div>
                        </div>
                    </div>
                </div>

                <!-- æ€»è®¡æ•°æ® -->
                <div class="detail-section">
                    <div class="detail-section-title">ğŸ† ç´¯è®¡æ•°æ®</div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">æ€»ä¸“æ³¨æ¬¡æ•°</div>
                            <div class="detail-value highlight">${user.totalFocusCount || 0}æ¬¡</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">æ€»å­¦ä¹ æ—¶é•¿</div>
                            <div class="detail-value highlight">${formatHours(user.totalDuration || 0)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">æ€»æ‰«ç è¿›é—¨</div>
                            <div class="detail-value">${user.totalAccessCount || 0}æ¬¡</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">æ€»è·å¾—ç»éªŒ</div>
                            <div class="detail-value">${user.totalExpEarned || 0}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">åº§ä½è®¢å•æ•°</div>
                            <div class="detail-value">${user.totalOrders || 0}å•</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">å®Œæˆè®¢å•æ•°</div>
                            <div class="detail-value">${user.completedOrders || 0}å•</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // å…³é—­ç”¨æˆ·è¯¦æƒ…å¼¹çª—
        function closeUserDetail(event) {
            if (!event || event.target === event.currentTarget) {
                document.getElementById('userDetailModal').classList.remove('show');
            }
        }

        // åŠ è½½æ’è¡Œæ¦œ
        async function loadRanking() {
            try {
                const res = await fetch('/api/admin/stats/ranking?limit=10');
                const data = await res.json();
                
                if (data.success) {
                    renderRanking(data.ranking);
                } else {
                    document.getElementById('rankingList').innerHTML = '<p>åŠ è½½å¤±è´¥</p>';
                }
            } catch (err) {
                console.error('åŠ è½½æ’è¡Œæ¦œå¤±è´¥:', err);
                document.getElementById('rankingList').innerHTML = '<p>ç½‘ç»œé”™è¯¯</p>';
            }
        }

        // æ¸²æŸ“æ’è¡Œæ¦œ
        function renderRanking(ranking) {
            if (!ranking || ranking.length === 0) {
                document.getElementById('rankingList').innerHTML = '<p>æš‚æ— æ’è¡Œæ•°æ®</p>';
                return;
            }

            document.getElementById('rankingList').innerHTML = ranking.map((item, index) => `
                <div class="ranking-item">
                    <div class="ranking-rank ${index < 3 ? 'top-' + (index + 1) : ''}">${index + 1}</div>
                    <div class="ranking-info">
                        <div class="list-name">${item.username}</div>
                        <div class="list-meta">${item.focusCount || 0} æ¬¡ä¸“æ³¨</div>
                    </div>
                    <div class="ranking-duration">${formatHours(item.totalDuration || 0)}</div>
                </div>
            `).join('');
        }

        // å¼ºåˆ¶é‡Šæ”¾åº§ä½
        async function releaseSeat(id) {
            if (!confirm('ç¡®å®šè¦å¼ºåˆ¶é‡Šæ”¾è¯¥åº§ä½å—ï¼Ÿ')) return;
            
            try {
                const res = await fetch(`/api/admin/seats/${id}/release`, { method: 'POST' });
                const data = await res.json();
                
                if (data.success) {
                    showToast('åº§ä½å·²é‡Šæ”¾');
                    loadSeats();
                    loadOverview();
                } else {
                    showToast(data.message || 'æ“ä½œå¤±è´¥');
                }
            } catch (err) {
                showToast('ç½‘ç»œé”™è¯¯');
            }
        }

        // è®¾ç½®ç»´æŠ¤çŠ¶æ€
        async function setMaintenance(id, maintenance) {
            try {
                const res = await fetch(`/api/admin/seats/${id}/maintenance`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ maintenance })
                });
                const data = await res.json();
                
                if (data.success) {
                    showToast(maintenance ? 'å·²è®¾ä¸ºç»´æŠ¤ä¸­' : 'å·²æ¢å¤æ­£å¸¸');
                    loadSeats();
                } else {
                    showToast(data.message || 'æ“ä½œå¤±è´¥');
                }
            } catch (err) {
                showToast('ç½‘ç»œé”™è¯¯');
            }
        }

        // æ§åˆ¶ç”µæº
        async function togglePower(id, powerOn) {
            try {
                const res = await fetch(`/api/admin/seats/${id}/power`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ powerOn })
                });
                const data = await res.json();
                
                if (data.success) {
                    showToast(powerOn ? 'å·²é€šç”µ' : 'å·²æ–­ç”µ');
                    loadSeats();
                } else {
                    showToast(data.message || 'æ“ä½œå¤±è´¥');
                }
            } catch (err) {
                showToast('ç½‘ç»œé”™è¯¯');
            }
        }

        // åˆ‡æ¢ç”¨æˆ·çŠ¶æ€
        async function toggleUserStatus(id, status) {
            try {
                const res = await fetch(`/api/admin/users/${id}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                const data = await res.json();
                
                if (data.success) {
                    showToast(status === 1 ? 'ç”¨æˆ·å·²å¯ç”¨' : 'ç”¨æˆ·å·²ç¦ç”¨');
                    loadUsers();
                } else {
                    showToast(data.message || 'æ“ä½œå¤±è´¥');
                }
            } catch (err) {
                showToast('ç½‘ç»œé”™è¯¯');
            }
        }

        // åˆ·æ–°æ‰€æœ‰æ•°æ®
        function refreshAll() {
            loadOverview();
            loadSeats();
            loadUsers();
            loadRanking();
            showToast('æ•°æ®å·²åˆ·æ–°');
        }

        // é€€å‡ºç™»å½•
        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/login.html';
            } catch (err) {
                window.location.href = '/login.html';
            }
        }

        // æ ¼å¼åŒ–æ—¶é•¿
        function formatHours(seconds) {
            if (!seconds) return '0h';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            if (hours > 0) {
                return `${hours}h${minutes > 0 ? minutes + 'm' : ''}`;
            }
            return `${minutes}m`;
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return `${date.getMonth() + 1}/${date.getDate()}`;
        }

        // æ˜¾ç¤º Toast
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }
    </script>
</body>
</html>
