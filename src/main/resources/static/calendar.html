<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä»Šæ—¥å­¦ä¹ æ€»ç»“ - äº‘ç«¯è‡ªä¹ å®¤</title>
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/components.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: var(--font-family);
            background: linear-gradient(135deg, #E8F4FD 0%, #F0E6FA 100%);
            min-height: 100vh;
            padding-bottom: 40px;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            padding: 0 var(--space-4);
            box-shadow: var(--shadow-sm);
            z-index: 100;
        }

        .back-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--color-card-bg);
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .back-btn:hover {
            background: var(--color-primary-light);
        }

        .top-title {
            flex: 1;
            text-align: center;
            font-size: 17px;
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .top-action {
            width: 36px;
        }

        /* å†…å®¹åŒºåŸŸ */
        .content {
            margin-top: 56px;
            padding: var(--space-4);
        }

        /* æ—¥æœŸå¤´éƒ¨ */
        .date-header {
            text-align: center;
            margin-bottom: var(--space-5);
            padding: var(--space-4);
        }

        .date-main {
            font-size: 28px;
            font-weight: 700;
            color: var(--color-text-primary);
            margin-bottom: var(--space-1);
        }

        .date-sub {
            font-size: 14px;
            color: var(--color-text-secondary);
        }

        /* ç•ªèŒ„æ”¶è·å¡ç‰‡ */
        .tomato-card {
            background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
            border-radius: var(--radius-2xl);
            padding: var(--space-6);
            color: white;
            text-align: center;
            margin-bottom: var(--space-4);
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.3);
            position: relative;
            overflow: hidden;
        }

        .tomato-card::before {
            content: 'ğŸ…';
            position: absolute;
            top: -20px;
            right: -20px;
            font-size: 100px;
            opacity: 0.15;
        }

        .tomato-icon {
            font-size: 64px;
            margin-bottom: var(--space-3);
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .tomato-count {
            font-size: 56px;
            font-weight: 800;
            line-height: 1;
            margin-bottom: var(--space-2);
            text-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .tomato-label {
            font-size: 16px;
            opacity: 0.9;
        }

        /* ç»Ÿè®¡ç½‘æ ¼ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .stat-card {
            background: white;
            border-radius: var(--radius-xl);
            padding: var(--space-5);
            text-align: center;
            box-shadow: var(--shadow-md);
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-icon {
            font-size: 36px;
            margin-bottom: var(--space-3);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: var(--space-1);
        }

        .stat-label {
            font-size: 13px;
            color: var(--color-text-secondary);
        }

        .stat-unit {
            font-size: 14px;
            font-weight: normal;
            color: var(--color-text-secondary);
        }

        /* å­¦ä¹ æ—¶æ®µåˆ†å¸ƒ */
        .time-distribution {
            background: white;
            border-radius: var(--radius-xl);
            padding: var(--space-5);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-4);
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: var(--space-4);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .section-title-icon {
            font-size: 20px;
        }

        .time-bar-container {
            margin-bottom: var(--space-4);
        }

        .time-bar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-2);
        }

        .time-period {
            font-size: 14px;
            font-weight: 500;
            color: var(--color-text-primary);
        }

        .time-duration {
            font-size: 13px;
            color: var(--color-text-secondary);
        }

        .time-bar {
            height: 12px;
            background: var(--color-background-secondary);
            border-radius: var(--radius-full);
            overflow: hidden;
        }

        .time-bar-fill {
            height: 100%;
            border-radius: var(--radius-full);
            transition: width 0.8s ease;
        }

        .time-bar-fill.morning {
            background: linear-gradient(90deg, #FFD93D, #FF9A3C);
        }

        .time-bar-fill.afternoon {
            background: linear-gradient(90deg, #6BCB77, #4D96FF);
        }

        .time-bar-fill.evening {
            background: linear-gradient(90deg, #9B59B6, #3498DB);
        }

        .time-bar-fill.night {
            background: linear-gradient(90deg, #2C3E50, #4834D4);
        }

        /* ä¸“æ³¨è®°å½•åˆ—è¡¨ */
        .focus-records {
            background: white;
            border-radius: var(--radius-xl);
            padding: var(--space-5);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-4);
        }

        .record-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .record-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-2);
            background: var(--color-background-secondary);
            transition: all 0.2s;
        }

        .record-item:hover {
            background: var(--color-primary-light);
        }

        .record-item:last-child {
            margin-bottom: 0;
        }

        .record-time-badge {
            min-width: 60px;
            padding: var(--space-1) var(--space-2);
            background: var(--color-primary);
            color: white;
            border-radius: var(--radius-md);
            font-size: 12px;
            font-weight: 500;
            text-align: center;
        }

        .record-info {
            flex: 1;
        }

        .record-duration-text {
            font-size: 14px;
            font-weight: 500;
            color: var(--color-text-primary);
        }

        .record-type {
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        .record-exp {
            font-size: 13px;
            font-weight: 600;
            color: var(--color-success);
        }

        /* é¼“åŠ±å¡ç‰‡ */
        .encourage-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: var(--radius-2xl);
            padding: var(--space-6);
            color: white;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .encourage-card::before {
            content: 'âœ¨';
            position: absolute;
            top: 10px;
            left: 20px;
            font-size: 40px;
            opacity: 0.3;
        }

        .encourage-card::after {
            content: 'ğŸŒŸ';
            position: absolute;
            bottom: 10px;
            right: 20px;
            font-size: 40px;
            opacity: 0.3;
        }

        .encourage-icon {
            font-size: 48px;
            margin-bottom: var(--space-3);
        }

        .encourage-text {
            font-size: 18px;
            font-weight: 600;
            line-height: 1.6;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: var(--space-8);
            color: var(--color-text-secondary);
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: var(--space-4);
        }

        .empty-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: var(--space-2);
        }

        .empty-desc {
            font-size: 14px;
            margin-bottom: var(--space-4);
        }

        .start-btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-6);
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: var(--radius-full);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(124, 58, 237, 0.4);
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: var(--space-3) var(--space-5);
            border-radius: var(--radius-full);
            font-size: 14px;
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: var(--space-8);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--color-border);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="top-bar">
        <button class="back-btn" onclick="goBack()">â†</button>
        <span class="top-title">ä»Šæ—¥å­¦ä¹ æ€»ç»“ ğŸ“Š</span>
        <div class="top-action"></div>
    </div>

    <!-- å†…å®¹åŒºåŸŸ -->
    <div class="content" id="mainContent">
        <div class="loading">
            <div class="loading-spinner"></div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // ä»Šæ—¥å­¦ä¹ æ•°æ®
        let todayData = {
            tomatoCount: 0,
            totalDuration: 0,  // ç§’
            focusCount: 0,
            expEarned: 0,
            records: [],       // ä¸“æ³¨è®°å½•åˆ—è¡¨
            timePeriods: {
                morning: 0,    // 6:00-12:00
                afternoon: 0,  // 12:00-18:00
                evening: 0,    // 18:00-22:00
                night: 0       // 22:00-6:00
            }
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadTodayData();
        });

        async function loadTodayData() {
            try {
                // è·å–ä»Šæ—¥ä¸“æ³¨è®°å½•
                const res = await fetch('/api/focus/today/details');
                const data = await res.json();
                
                if (data.success) {
                    todayData.tomatoCount = data.tomatoCount || 0;
                    todayData.totalDuration = data.totalDuration || 0;
                    todayData.focusCount = data.focusCount || 0;
                    todayData.expEarned = data.expEarned || 0;
                    todayData.records = data.records || [];
                    
                    // è®¡ç®—æ—¶æ®µåˆ†å¸ƒï¼ˆåªç»Ÿè®¡>=10åˆ†é’Ÿçš„è®°å½•ï¼‰
                    calculateTimePeriods(data.records || []);
                }
                
                renderPage();
            } catch (err) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', err);
                // ä½¿ç”¨æœ¬åœ°å­˜å‚¨çš„æ•°æ®ä½œä¸ºå¤‡ç”¨
                loadFromLocalStorage();
                renderPage();
            }
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('todayFocusData');
            if (saved) {
                const data = JSON.parse(saved);
                const today = new Date().toDateString();
                if (data.date === today) {
                    todayData = { ...todayData, ...data };
                }
            }
        }

        function calculateTimePeriods(records) {
            todayData.timePeriods = {
                morning: 0,
                afternoon: 0,
                evening: 0,
                night: 0
            };

            records.forEach(record => {
                // åªç»Ÿè®¡è¶…è¿‡10åˆ†é’Ÿçš„è®°å½•
                if (record.duration < 600) return; // 600ç§’ = 10åˆ†é’Ÿ
                
                const hour = new Date(record.startTime).getHours();
                const duration = record.duration;

                if (hour >= 6 && hour < 12) {
                    todayData.timePeriods.morning += duration;
                } else if (hour >= 12 && hour < 18) {
                    todayData.timePeriods.afternoon += duration;
                } else if (hour >= 18 && hour < 22) {
                    todayData.timePeriods.evening += duration;
                } else {
                    todayData.timePeriods.night += duration;
                }
            });
        }

        function renderPage() {
            const content = document.getElementById('mainContent');
            
            // è·å–ä»Šæ—¥æ—¥æœŸ
            const today = new Date();
            const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
            const dateStr = `${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥`;
            const weekStr = weekdays[today.getDay()];

            // å¦‚æœä»Šå¤©æ²¡æœ‰å­¦ä¹ è®°å½•
            if (todayData.focusCount === 0) {
                content.innerHTML = `
                    <div class="date-header">
                        <div class="date-main">${dateStr}</div>
                        <div class="date-sub">${weekStr}</div>
                    </div>
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“š</div>
                        <div class="empty-title">ä»Šå¤©è¿˜æ²¡æœ‰å­¦ä¹ è®°å½•</div>
                        <div class="empty-desc">å¼€å§‹ä¸“æ³¨ï¼Œæ”¶è·ä½ çš„ç¬¬ä¸€ä¸ªç•ªèŒ„å§ï¼</div>
                        <button class="start-btn" onclick="goToFocus()">
                            <span>ğŸ…</span>
                            <span>å¼€å§‹ä¸“æ³¨</span>
                        </button>
                    </div>
                `;
                return;
            }

            // è®¡ç®—æ€»æ—¶é•¿ï¼ˆåˆ†é’Ÿå’Œå°æ—¶ï¼‰
            const totalMinutes = Math.floor(todayData.totalDuration / 60);
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            const durationText = hours > 0 ? `${hours}å°æ—¶${minutes}åˆ†é’Ÿ` : `${minutes}åˆ†é’Ÿ`;

            // è®¡ç®—æ—¶æ®µåˆ†å¸ƒæœ€å¤§å€¼
            const maxPeriod = Math.max(
                todayData.timePeriods.morning,
                todayData.timePeriods.afternoon,
                todayData.timePeriods.evening,
                todayData.timePeriods.night
            );

            // ç”Ÿæˆæ—¶æ®µåˆ†å¸ƒHTML
            let timeDistributionHtml = '';
            const periods = [
                { key: 'morning', name: 'ä¸Šåˆ', time: '6:00 - 12:00', class: 'morning' },
                { key: 'afternoon', name: 'ä¸‹åˆ', time: '12:00 - 18:00', class: 'afternoon' },
                { key: 'evening', name: 'å‚æ™š', time: '18:00 - 22:00', class: 'evening' },
                { key: 'night', name: 'æ·±å¤œ', time: '22:00 - 6:00', class: 'night' }
            ];

            let hasAnyPeriod = false;
            periods.forEach(period => {
                const duration = todayData.timePeriods[period.key];
                if (duration > 0) {
                    hasAnyPeriod = true;
                    const percent = maxPeriod > 0 ? (duration / maxPeriod) * 100 : 0;
                    const mins = Math.floor(duration / 60);
                    timeDistributionHtml += `
                        <div class="time-bar-container">
                            <div class="time-bar-header">
                                <span class="time-period">${period.name} (${period.time})</span>
                                <span class="time-duration">${mins}åˆ†é’Ÿ</span>
                            </div>
                            <div class="time-bar">
                                <div class="time-bar-fill ${period.class}" style="width: ${percent}%"></div>
                            </div>
                        </div>
                    `;
                }
            });

            // ç”Ÿæˆä¸“æ³¨è®°å½•HTMLï¼ˆåªæ˜¾ç¤º>=10åˆ†é’Ÿçš„è®°å½•ï¼‰
            let recordsHtml = '';
            const significantRecords = todayData.records.filter(r => r.duration >= 600);
            
            if (significantRecords.length > 0) {
                significantRecords.forEach(record => {
                    const time = new Date(record.startTime);
                    const timeStr = `${String(time.getHours()).padStart(2, '0')}:${String(time.getMinutes()).padStart(2, '0')}`;
                    const mins = Math.floor(record.duration / 60);
                    const exp = record.exp || Math.floor(mins * (record.type === 'pomodoro' ? 1.5 : 1));
                    const typeText = record.type === 'pomodoro' ? 'ğŸ… ç•ªèŒ„é’Ÿ' : 'â±ï¸ è‡ªç”±ä¸“æ³¨';
                    
                    recordsHtml += `
                        <div class="record-item">
                            <div class="record-time-badge">${timeStr}</div>
                            <div class="record-info">
                                <div class="record-duration-text">ä¸“æ³¨ ${mins} åˆ†é’Ÿ</div>
                                <div class="record-type">${typeText}</div>
                            </div>
                            <div class="record-exp">+${exp} EXP</div>
                        </div>
                    `;
                });
            }

            // ç”Ÿæˆé¼“åŠ±è¯­
            let encourageText = '';
            if (todayData.tomatoCount >= 8) {
                encourageText = 'ä»Šå¤©è¶…çº§é«˜äº§ï¼ä½ å°±æ˜¯å­¦ä¹ æœºå™¨ï¼ğŸš€';
            } else if (todayData.tomatoCount >= 4) {
                encourageText = 'å¤ªæ£’äº†ï¼ä¿æŒè¿™ä¸ªèŠ‚å¥ï¼Œä½ æ­£åœ¨å˜å¾—æ›´å¼ºï¼ğŸ’ª';
            } else if (todayData.tomatoCount >= 1) {
                encourageText = 'å¾ˆå¥½çš„å¼€å§‹ï¼æ¯ä¸€åˆ†é’Ÿçš„åŠªåŠ›éƒ½åœ¨ç§¯ç´¯ï¼âœ¨';
            } else if (totalMinutes >= 60) {
                encourageText = 'ä¸“æ³¨äº†ä¸€ä¸ªå¤šå°æ—¶ï¼ŒåšæŒå°±æ˜¯èƒœåˆ©ï¼ğŸ¯';
            } else if (totalMinutes >= 30) {
                encourageText = 'åŠå°æ—¶çš„ä¸“æ³¨ï¼Œå€¼å¾—é¼“åŠ±ï¼ç»§ç»­åŠ æ²¹ï¼ğŸŒŸ';
            } else {
                encourageText = 'æ¯ä¸€æ­¥éƒ½ç®—æ•°ï¼Œæ˜å¤©ä¼šæ›´å¥½ï¼ğŸ’–';
            }

            content.innerHTML = `
                <!-- æ—¥æœŸå¤´éƒ¨ -->
                <div class="date-header">
                    <div class="date-main">${dateStr}</div>
                    <div class="date-sub">${weekStr}</div>
                </div>

                <!-- ç•ªèŒ„æ”¶è·å¡ç‰‡ -->
                <div class="tomato-card">
                    <div class="tomato-icon">ğŸ…</div>
                    <div class="tomato-count">${todayData.tomatoCount}</div>
                    <div class="tomato-label">ä»Šæ—¥æ”¶è·ç•ªèŒ„</div>
                </div>

                <!-- ç»Ÿè®¡ç½‘æ ¼ -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">â±ï¸</div>
                        <div class="stat-value">${hours > 0 ? hours : totalMinutes}<span class="stat-unit">${hours > 0 ? 'å°æ—¶' : 'åˆ†é’Ÿ'}</span></div>
                        <div class="stat-label">å­¦ä¹ æ—¶é•¿</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ¯</div>
                        <div class="stat-value">${todayData.focusCount}<span class="stat-unit">æ¬¡</span></div>
                        <div class="stat-label">ä¸“æ³¨æ¬¡æ•°</div>
                    </div>
                </div>

                <!-- å­¦ä¹ æ—¶æ®µåˆ†å¸ƒ -->
                ${hasAnyPeriod ? `
                <div class="time-distribution">
                    <div class="section-title">
                        <span class="section-title-icon">ğŸ“ˆ</span>
                        ä¸»è¦å­¦ä¹ æ—¶æ®µ
                    </div>
                    ${timeDistributionHtml}
                    <div style="font-size: 12px; color: var(--color-text-tertiary); margin-top: var(--space-2); text-align: center;">
                        ä»…ç»Ÿè®¡è¶…è¿‡10åˆ†é’Ÿçš„ä¸“æ³¨è®°å½•
                    </div>
                </div>
                ` : ''}

                <!-- ä¸“æ³¨è®°å½•åˆ—è¡¨ -->
                ${significantRecords.length > 0 ? `
                <div class="focus-records">
                    <div class="section-title">
                        <span class="section-title-icon">ğŸ“</span>
                        ä»Šæ—¥ä¸“æ³¨è®°å½•
                    </div>
                    <div class="record-list">
                        ${recordsHtml}
                    </div>
                </div>
                ` : ''}

                <!-- é¼“åŠ±å¡ç‰‡ -->
                <div class="encourage-card">
                    <div class="encourage-icon">${todayData.tomatoCount >= 4 ? 'ğŸ†' : 'ğŸ’ª'}</div>
                    <div class="encourage-text">${encourageText}</div>
                </div>
            `;
        }

        function goToFocus() {
            window.location.href = '/focus.html';
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        function goBack() {
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = '/study.html';
            }
        }
    </script>
</body>
</html>
