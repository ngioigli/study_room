<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ·±åº¦ä¸“æ³¨ - äº‘ç«¯è‡ªä¹ å®¤</title>
    <link rel="stylesheet" href="/css/variables.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/pet-sprites.css">
    <style>
        body, html {
            height: 100%;
            overflow: hidden;
            background: var(--gradient-focus);
        }

        /* åŠ¨æ€èƒŒæ™¯ */
        .focus-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            transition: filter 1s ease;
        }

        body.focus-mode .focus-background {
            filter: brightness(0.92);
        }

        /* äº‘æœµ */
        .cloud {
            position: absolute;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            animation: cloud-float 60s infinite linear;
            pointer-events: none;
        }

        .cloud::after, .cloud::before {
            content: '';
            position: absolute;
            background: inherit;
            border-radius: inherit;
        }

        .cloud-1 {
            width: 100px;
            height: 40px;
            top: 15%;
            left: -10%;
        }
        .cloud-1::after { width: 50px; height: 50px; top: -25px; left: 15px; }
        .cloud-1::before { width: 40px; height: 40px; top: -15px; left: 45px; }

        .cloud-2 {
            width: 150px;
            height: 60px;
            top: 65%;
            left: -20%;
            animation-duration: 80s;
            opacity: 0.4;
        }
        .cloud-2::after { width: 70px; height: 70px; top: -35px; left: 25px; }
        .cloud-2::before { width: 60px; height: 60px; top: -25px; left: 70px; }

        @keyframes cloud-float {
            from { left: -20%; }
            to { left: 120%; }
        }

        /* é¡¶éƒ¨çŠ¶æ€æ  */
        .top-status-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: var(--space-4);
            padding-top: calc(var(--safe-area-top) + var(--space-4));
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            z-index: 50;
        }

        .stats-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: var(--radius-xl);
            padding: var(--space-3) var(--space-5);
            box-shadow: var(--shadow-card);
            display: flex;
            align-items: center;
            gap: var(--space-5);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
            line-height: 1.2;
        }

        .stat-label {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
            margin-top: 2px;
        }

        .stat-divider {
            width: 1px;
            height: 36px;
            background: linear-gradient(to bottom, transparent, var(--color-border), transparent);
        }

        /* ç»éªŒè¿›åº¦æ¡ */
        .exp-bar-section {
            position: fixed;
            top: 90px;
            left: 50%;
            transform: translateX(-50%);
            width: 280px;
            z-index: 40;
            transition: top 0.3s;
        }

        body.pomodoro-mode .exp-bar-section {
            top: 90px;
        }

        .exp-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            padding: 0 4px;
        }

        .exp-level {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-bold);
            color: #fff;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .exp-text {
            font-size: var(--font-size-xs);
            color: rgba(255, 255, 255, 0.9);
        }

        .exp-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: var(--radius-full);
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .exp-bar-fill {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: var(--radius-full);
            transition: width 0.5s ease;
            box-shadow: 0 0 10px rgba(124, 58, 237, 0.5);
        }

        /* ä¸­å¤®è®¡æ—¶å™¨ */
        .timer-container {
            position: fixed;
            top: 38%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            width: 100%;
            z-index: 30;
        }

        .timer-display {
            font-size: min(22vw, 140px);
            font-weight: var(--font-weight-bold);
            font-variant-numeric: tabular-nums;
            color: #fff;
            text-shadow: 0 10px 40px rgba(102, 166, 255, 0.4);
            cursor: pointer;
            transition: transform 0.3s;
            line-height: 1;
        }

        .timer-display:hover {
            transform: scale(1.02);
        }

        .status-text {
            font-size: var(--font-size-lg);
            color: rgba(255, 255, 255, 0.9);
            margin-top: var(--space-3);
            letter-spacing: 2px;
            min-height: 28px;
        }

        /* å®æ—¶ç»éªŒé¢„è§ˆ */
        .exp-preview {
            margin-top: var(--space-4);
            font-size: var(--font-size-sm);
            color: rgba(255, 255, 255, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: var(--space-2);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .exp-preview.visible {
            opacity: 1;
        }

        .exp-preview .exp-icon {
            font-size: 18px;
            animation: pulse 2s infinite;
        }

        /* æ§åˆ¶æŒ‰é’® */
        .timer-controls {
            margin-top: var(--space-8);
            display: flex;
            gap: var(--space-5);
            justify-content: center;
        }

        .ctrl-btn {
            background: rgba(255, 255, 255, 0.25);
            border: 2px solid rgba(255, 255, 255, 0.5);
            color: #fff;
            padding: var(--space-3) var(--space-6);
            border-radius: var(--radius-full);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-bold);
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.2s;
        }

        .ctrl-btn:hover {
            background: #fff;
            color: var(--color-primary);
            border-color: #fff;
        }

        .ctrl-btn:active {
            transform: scale(0.98);
        }

        .ctrl-btn.primary {
            background: #fff;
            color: var(--color-primary);
            border-color: #fff;
        }

        .ctrl-btn.primary:hover {
            background: rgba(255, 255, 255, 0.9);
        }

        /* ç™½å™ªéŸ³ Dock */
        .sound-dock {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: var(--radius-2xl);
            padding: var(--space-3) var(--space-5);
            display: flex;
            align-items: center;
            gap: var(--space-4);
            box-shadow: var(--shadow-lg);
            z-index: 50;
            transition: opacity 0.5s;
            max-width: 90%;
        }

        body.focus-mode .sound-dock {
            opacity: 0.4;
        }

        body.focus-mode .sound-dock:hover {
            opacity: 1;
        }

        .sound-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.2s;
            padding: var(--space-2);
        }

        .sound-item:hover {
            opacity: 1;
            transform: translateY(-2px);
        }

        .sound-item.active {
            opacity: 1;
        }

        .sound-item.active .sound-icon {
            background: #fff;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.6);
        }

        .sound-icon {
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 22px;
            transition: all 0.3s;
        }

        .dock-divider {
            width: 1px;
            height: 36px;
            background: rgba(255, 255, 255, 0.3);
        }

        .volume-wrapper {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .volume-icon {
            font-size: 16px;
            opacity: 0.7;
        }

        .volume-slider {
            width: 70px;
            height: 4px;
            border-radius: 2px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.4);
            outline: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        /* è®¾ç½®æŒ‰é’® */
        .settings-btn {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: var(--radius-xl);
            padding: var(--space-3);
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: var(--shadow-card);
        }

        .settings-btn:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-lg);
        }

        /* ç•ªèŒ„é’Ÿæ¨¡å¼åˆ‡æ¢ - ç§»å…¥è®¾ç½®é¢æ¿ï¼Œéšè—åŸä½ç½® */
        .mode-switcher {
            display: none;
        }

        /* è®¾ç½®é¢æ¿å†…çš„æ¨¡å¼åˆ‡æ¢ */
        .settings-mode-switcher {
            display: flex;
            gap: var(--space-2);
            background: var(--color-card-bg);
            border-radius: var(--radius-lg);
            padding: var(--space-1);
        }

        .settings-mode-btn {
            flex: 1;
            padding: var(--space-3);
            border: none;
            background: transparent;
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .settings-mode-btn.active {
            background: var(--gradient-primary);
            color: #fff;
            box-shadow: 0 2px 8px rgba(124, 58, 237, 0.3);
        }

        .settings-mode-btn:hover:not(.active) {
            background: rgba(124, 58, 237, 0.1);
        }

        /* ç•ªèŒ„é’Ÿä¸“ç”¨æ ·å¼ - è°ƒæ•´ä½ç½®é¿å…é‡å  */
        .pomodoro-info {
            position: fixed;
            top: 140px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: var(--space-3);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-full);
            box-shadow: var(--shadow-card);
            z-index: 35;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .pomodoro-info.visible {
            opacity: 1;
            visibility: visible;
        }

        /* ç•ªèŒ„é’Ÿå¥–åŠ±æç¤º */
        .pomodoro-bonus-hint {
            font-size: var(--font-size-xs);
            color: var(--color-success);
            margin-left: var(--space-2);
        }

        .pomodoro-phase {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            color: var(--color-primary);
        }

        .pomodoro-session {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
        }

        .pomodoro-tomato {
            font-size: 18px;
        }

        /* è®¾ç½®é¢æ¿ */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 380px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: var(--shadow-xl);
            z-index: 100;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .settings-panel.visible {
            right: 0;
        }

        .settings-header {
            padding: var(--space-6) var(--space-5);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-header h3 {
            margin: 0;
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-bold);
            color: var(--color-text-primary);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--color-text-secondary);
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-md);
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: var(--color-background-secondary);
            color: var(--color-text-primary);
        }

        .settings-content {
            padding: var(--space-5);
        }

        .setting-group {
            margin-bottom: var(--space-6);
        }

        .setting-label {
            display: block;
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin-bottom: var(--space-3);
        }

        /* ä¸»é¢˜é€‰é¡¹ */
        .theme-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-3);
        }

        .theme-option {
            height: 80px;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .theme-option span {
            color: white;
            font-weight: var(--font-weight-semibold);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            z-index: 1;
        }

        .theme-option.active {
            border-color: var(--color-primary);
            transform: scale(1.05);
        }

        .theme-option:hover {
            transform: scale(1.02);
        }

        /* å® ç‰©å¿«æ·æ“ä½œ */
        .pet-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-3);
        }

        .action-btn {
            padding: var(--space-3) var(--space-4);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-lg);
            background: white;
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .action-btn:hover:not(:disabled) {
            border-color: var(--color-primary);
            background: var(--color-primary-light);
            transform: translateY(-2px);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .no-pet-hint {
            text-align: center;
            padding: var(--space-4);
            color: var(--color-text-secondary);
        }

        .no-pet-hint a {
            color: var(--color-primary);
            text-decoration: none;
        }

        .no-pet-hint a:hover {
            text-decoration: underline;
        }

        /* ç•ªèŒ„é’Ÿè®¾ç½®æ ·å¼ */
        .pomodoro-settings {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }

        .pomodoro-setting-item {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .setting-item-label {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .duration-options {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-2);
        }

        .duration-btn {
            padding: var(--space-2) var(--space-3);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md);
            background: white;
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .duration-btn:hover {
            border-color: var(--color-primary);
        }

        .duration-btn.active {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: white;
        }

        .duration-btn.small {
            padding: var(--space-1) var(--space-2);
            font-size: var(--font-size-xs);
        }

        /* Toast æ ·å¼è¦†ç›– */
        .focus-toast {
            position: fixed;
            top: 140px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            color: var(--color-text-primary);
            padding: var(--space-3) var(--space-5);
            border-radius: var(--radius-full);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            animation: toast-in 0.3s ease, toast-out 0.3s ease 2.7s forwards;
        }

        /* è¿”å›ç¡®è®¤å¼¹çª— */
        .back-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: var(--space-4);
        }

        .back-modal-overlay.visible {
            display: flex;
        }

        .back-modal {
            background: white;
            border-radius: var(--radius-2xl);
            padding: var(--space-6);
            max-width: 340px;
            width: 100%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modal-in 0.3s ease;
        }

        @keyframes modal-in {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .back-modal-icon {
            font-size: 48px;
            margin-bottom: var(--space-4);
        }

        .back-modal-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-bold);
            color: var(--color-text-primary);
            margin-bottom: var(--space-2);
        }

        .back-modal-desc {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            margin-bottom: var(--space-4);
            line-height: 1.6;
        }

        .back-modal-exp {
            background: var(--color-primary-light);
            border-radius: var(--radius-lg);
            padding: var(--space-3);
            margin-bottom: var(--space-5);
        }

        .back-modal-exp-label {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
            margin-bottom: 4px;
        }

        .back-modal-exp-value {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
        }

        .back-modal-actions {
            display: flex;
            gap: var(--space-3);
        }

        .back-modal-btn {
            flex: 1;
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-xl);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .back-modal-btn.cancel {
            background: var(--color-background-secondary);
            color: var(--color-text-secondary);
        }

        .back-modal-btn.cancel:hover {
            background: var(--color-border);
        }

        .back-modal-btn.confirm {
            background: var(--gradient-primary);
            color: white;
        }

        .back-modal-btn.confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- èƒŒæ™¯ -->
        <div class="focus-background">
            <div class="cloud cloud-1"></div>
            <div class="cloud cloud-2"></div>
        </div>

        <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
        <div class="top-status-bar">
            <a href="javascript:void(0)" class="back-btn" @click="showBackModal">
                <span>â†</span> è¿”å›å°å±‹
            </a>
            
            <div class="stats-card">
                <div class="stat-item">
                    <div class="stat-value">{{ formatDuration(todayStats.totalDuration) }}</div>
                    <div class="stat-label">ä»Šæ—¥å­¦ä¹ </div>
                </div>
                <div class="stat-divider"></div>
                <div class="stat-item">
                    <div class="stat-value">{{ todayStats.focusCount }}</div>
                    <div class="stat-label">ä¸“æ³¨æ¬¡æ•°</div>
                </div>
                <div class="stat-divider"></div>
                <div class="stat-item">
                    <div class="stat-value">{{ todayStats.expEarned }}</div>
                    <div class="stat-label">ä»Šæ—¥ç»éªŒ</div>
                </div>
            </div>

            <button class="settings-btn" @click="showSettings = !showSettings">
                <span>âš™ï¸</span>
            </button>
        </div>

        <!-- æ¨¡å¼åˆ‡æ¢å·²ç§»å…¥è®¾ç½®é¢æ¿ -->

        <!-- ç•ªèŒ„é’Ÿä¿¡æ¯ -->
        <div class="pomodoro-info" :class="{ visible: focusMode === 'pomodoro' }">
            <span class="pomodoro-tomato">ğŸ…</span>
            <span class="pomodoro-phase">{{ pomodoroPhase === 'focus' ? 'ä¸“æ³¨æ—¶é—´' : (pomodoroPhase === 'shortBreak' ? 'çŸ­ä¼‘æ¯' : 'é•¿ä¼‘æ¯') }}</span>
            <span class="pomodoro-session">ç¬¬ {{ pomodoroSession }} ä¸ªç•ªèŒ„</span>
            <span class="pomodoro-bonus-hint">+20%ç»éªŒ</span>
        </div>

        <!-- ç»éªŒè¿›åº¦æ¡ -->
        <div class="exp-bar-section">
            <div class="exp-info">
                <span class="exp-level">Lv.{{ petInfo.level || 1 }}</span>
                <span class="exp-text">{{ expInLevel }} / {{ expToNext }} EXP</span>
            </div>
            <div class="exp-bar">
                <div class="exp-bar-fill" :style="{ width: expPercent + '%' }"></div>
            </div>
        </div>

        <!-- ä¸­å¤®è®¡æ—¶å™¨ -->
        <div class="timer-container">
            <div class="timer-display" @click="toggleTimer">{{ formatTime(secondsElapsed) }}</div>
            <p class="status-text">{{ statusText }}</p>
            
            <div class="exp-preview" :class="{ visible: isRunning || secondsElapsed > 0 }">
                <span class="exp-icon">â­</span>
                <span>æœ¬æ¬¡é¢„è®¡è·å¾— <strong>{{ previewExp }}</strong> ç»éªŒå€¼</span>
            </div>

            <div class="timer-controls">
                <button class="ctrl-btn" :class="{ primary: !isRunning }" @click="toggleTimer">
                    {{ isRunning ? 'æš‚åœ' : (secondsElapsed > 0 ? 'ç»§ç»­' : 'å¼€å§‹è®¡æ—¶') }}
                </button>
                <button class="ctrl-btn" v-show="secondsElapsed > 0" @click="stopTimer">åœæ­¢</button>
            </div>
        </div>

        <!-- æµ®åŠ¨å® ç‰© -->
        <div 
            class="floating-pet" 
            :class="[petState, petDirection]"
            ref="petElement"
            @click="handlePetClick"
        >
            <div class="pet-bubble" :class="{ visible: showBubble }">{{ bubbleText }}</div>
            <div class="pet-sprite">{{ petEmoji }}</div>
            <div class="pet-shadow"></div>
        </div>


        <!-- è®¾ç½®é¢æ¿ -->
        <div class="settings-panel" :class="{ visible: showSettings }">
            <div class="settings-header">
                <h3>ä¸“æ³¨è®¾ç½®</h3>
                <button class="close-btn" @click="showSettings = false">Ã—</button>
            </div>
            
            <div class="settings-content">
                <!-- ä¸“æ³¨æ¨¡å¼åˆ‡æ¢ï¼ˆä»åŸä½ç½®ç§»å…¥ï¼‰ -->
                <div class="setting-group">
                    <label class="setting-label">ä¸“æ³¨æ¨¡å¼</label>
                    <div class="settings-mode-switcher">
                        <button class="settings-mode-btn" :class="{ active: focusMode === 'free' }" @click="switchMode('free')">
                            â±ï¸ è‡ªç”±è®¡æ—¶
                        </button>
                        <button class="settings-mode-btn" :class="{ active: focusMode === 'pomodoro' }" @click="switchMode('pomodoro')">
                            ğŸ… ç•ªèŒ„é’Ÿ <small style="opacity:0.8">+20%</small>
                        </button>
                    </div>
                </div>

                <div class="setting-group">
                    <label class="setting-label">èƒŒæ™¯ä¸»é¢˜</label>
                    <div class="theme-options">
                        <div 
                            class="theme-option" 
                            :class="{ active: currentTheme === 'default' }"
                            @click="changeTheme('default')"
                            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%)"
                        >
                            <span>é»˜è®¤</span>
                        </div>
                        <div 
                            class="theme-option" 
                            :class="{ active: currentTheme === 'sunset' }"
                            @click="changeTheme('sunset')"
                            style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%)"
                        >
                            <span>æ—¥è½</span>
                        </div>
                        <div 
                            class="theme-option" 
                            :class="{ active: currentTheme === 'forest' }"
                            @click="changeTheme('forest')"
                            style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)"
                        >
                            <span>æ£®æ—</span>
                        </div>
                        <div 
                            class="theme-option" 
                            :class="{ active: currentTheme === 'ocean' }"
                            @click="changeTheme('ocean')"
                            style="background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%)"
                        >
                            <span>æµ·æ´‹</span>
                        </div>
                        <div 
                            class="theme-option" 
                            :class="{ active: currentTheme === 'night' }"
                            @click="changeTheme('night')"
                            style="background: linear-gradient(135deg, #2c3e50 0%, #4a6741 100%)"
                        >
                            <span>å¤œæ™š</span>
                        </div>
                        <div 
                            class="theme-option" 
                            :class="{ active: currentTheme === 'cherry' }"
                            @click="changeTheme('cherry')"
                            style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)"
                        >
                            <span>æ¨±èŠ±</span>
                        </div>
                    </div>
                </div>

                <div class="setting-group">
                    <label class="setting-label">å® ç‰©å¿«æ·äº’åŠ¨</label>
                    <div class="pet-actions" v-if="hasPet">
                        <button class="action-btn" @click="quickInteract('feed')" :disabled="cooldowns.feed > 0">
                            ğŸ å–‚é£Ÿ <span v-if="cooldowns.feed > 0">({{ formatCooldown(cooldowns.feed) }})</span>
                        </button>
                        <button class="action-btn" @click="quickInteract('pet')" :disabled="cooldowns.pet > 0">
                            ğŸ¤— æŠšæ‘¸ <span v-if="cooldowns.pet > 0">({{ formatCooldown(cooldowns.pet) }})</span>
                        </button>
                        <button class="action-btn" @click="quickInteract('play')" :disabled="cooldowns.play > 0">
                            ğŸ¾ ç©è€ <span v-if="cooldowns.play > 0">({{ formatCooldown(cooldowns.play) }})</span>
                        </button>
                        <button class="action-btn" @click="quickInteract('talk')">
                            ğŸ’¬ èŠå¤©
                        </button>
                    </div>
                    <div v-else class="no-pet-hint">
                        <p>è¿˜æ²¡æœ‰å® ç‰©ï¼Œ<a href="/pet.html">å»å­µåŒ–ä¸€åªå§ï¼</a></p>
                    </div>
                </div>

                <div class="setting-group">
                    <label class="setting-label">ğŸ… ç•ªèŒ„é’Ÿæ—¶é•¿è®¾ç½®</label>
                    <div class="pomodoro-settings">
                        <div class="pomodoro-setting-item">
                            <span class="setting-item-label">ä¸“æ³¨æ—¶é•¿</span>
                            <div class="duration-options">
                                <button 
                                    class="duration-btn" 
                                    :class="{ active: pomodoroConfig.focusDuration === 25 }"
                                    @click="setPomodoroConfig('focus', 25)">25åˆ†é’Ÿ</button>
                                <button 
                                    class="duration-btn" 
                                    :class="{ active: pomodoroConfig.focusDuration === 30 }"
                                    @click="setPomodoroConfig('focus', 30)">30åˆ†é’Ÿ</button>
                                <button 
                                    class="duration-btn" 
                                    :class="{ active: pomodoroConfig.focusDuration === 45 }"
                                    @click="setPomodoroConfig('focus', 45)">45åˆ†é’Ÿ</button>
                                <button 
                                    class="duration-btn" 
                                    :class="{ active: pomodoroConfig.focusDuration === 60 }"
                                    @click="setPomodoroConfig('focus', 60)">60åˆ†é’Ÿ</button>
                            </div>
                        </div>
                        <div class="pomodoro-setting-item">
                            <span class="setting-item-label">çŸ­ä¼‘æ¯</span>
                            <div class="duration-options">
                                <button 
                                    class="duration-btn small" 
                                    :class="{ active: pomodoroConfig.shortBreakDuration === 5 }"
                                    @click="setPomodoroConfig('short', 5)">5åˆ†é’Ÿ</button>
                                <button 
                                    class="duration-btn small" 
                                    :class="{ active: pomodoroConfig.shortBreakDuration === 10 }"
                                    @click="setPomodoroConfig('short', 10)">10åˆ†é’Ÿ</button>
                            </div>
                        </div>
                        <div class="pomodoro-setting-item">
                            <span class="setting-item-label">é•¿ä¼‘æ¯</span>
                            <div class="duration-options">
                                <button 
                                    class="duration-btn small" 
                                    :class="{ active: pomodoroConfig.longBreakDuration === 15 }"
                                    @click="setPomodoroConfig('long', 15)">15åˆ†é’Ÿ</button>
                                <button 
                                    class="duration-btn small" 
                                    :class="{ active: pomodoroConfig.longBreakDuration === 20 }"
                                    @click="setPomodoroConfig('long', 20)">20åˆ†é’Ÿ</button>
                                <button 
                                    class="duration-btn small" 
                                    :class="{ active: pomodoroConfig.longBreakDuration === 30 }"
                                    @click="setPomodoroConfig('long', 30)">30åˆ†é’Ÿ</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç™½å™ªéŸ³ Dock -->
        <div class="sound-dock">
            <div 
                class="sound-item" 
                :class="{ active: activeSounds.rain }"
                @click="toggleSound('rain')"
            >
                <div class="sound-icon">ğŸŒ§ï¸</div>
            </div>
            <div 
                class="sound-item" 
                :class="{ active: activeSounds.fire }"
                @click="toggleSound('fire')"
            >
                <div class="sound-icon">ğŸ”¥</div>
            </div>
            <div 
                class="sound-item" 
                :class="{ active: activeSounds.forest }"
                @click="toggleSound('forest')"
            >
                <div class="sound-icon">ğŸŒ²</div>
            </div>
            <div 
                class="sound-item" 
                :class="{ active: activeSounds.ocean }"
                @click="toggleSound('ocean')"
            >
                <div class="sound-icon">ğŸŒŠ</div>
            </div>
            <div class="dock-divider"></div>
            <div class="volume-wrapper">
                <span class="volume-icon">ğŸ”ˆ</span>
                <input 
                    type="range" 
                    class="volume-slider" 
                    min="0" 
                    max="1" 
                    step="0.05" 
                    v-model="masterVolume"
                    @input="updateVolume"
                >
            </div>
        </div>

        <!-- è¿”å›ç¡®è®¤å¼¹çª— -->
        <div class="back-modal-overlay" :class="{ visible: showBackConfirm }">
            <div class="back-modal">
                <div class="back-modal-icon">ğŸ </div>
                <div class="back-modal-title">ç¡®å®šè¦è¿”å›å°å±‹å—ï¼Ÿ</div>
                <div class="back-modal-desc" v-if="secondsElapsed > 0">
                    å½“å‰ä¸“æ³¨å°†è¢«ä¿å­˜
                </div>
                <div class="back-modal-desc" v-else>
                    ä½ è¿˜æ²¡æœ‰å¼€å§‹ä¸“æ³¨å“¦~
                </div>
                <div class="back-modal-exp" v-if="secondsElapsed >= 60">
                    <div class="back-modal-exp-label">æœ¬æ¬¡å°†è·å¾—ç»éªŒ</div>
                    <div class="back-modal-exp-value">+{{ previewExp }} EXP</div>
                </div>
                <div class="back-modal-exp" v-else-if="secondsElapsed > 0">
                    <div class="back-modal-exp-label">ä¸“æ³¨ä¸è¶³1åˆ†é’Ÿ</div>
                    <div class="back-modal-exp-value">æ— ç»éªŒ</div>
                </div>
                <div class="back-modal-actions">
                    <button class="back-modal-btn cancel" @click="showBackConfirm = false">ç»§ç»­ä¸“æ³¨</button>
                    <button class="back-modal-btn confirm" @click="confirmBack">ç¡®å®šè¿”å›</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="/js/pet-ai.js"></script>
    <script>
        const { createApp, ref, reactive, computed, onMounted, onUnmounted, watch } = Vue;

        createApp({
            setup() {
                // ==================== çŠ¶æ€ ====================
                const secondsElapsed = ref(0);
                const isRunning = ref(false);
                const isStopping = ref(false); // é˜²æ­¢åœæ­¢æ—¶è§¦å‘ visibilitychange
                const statusText = ref('å‡†å¤‡å¥½äº†å—ï¼Ÿ');
                
                // ç•ªèŒ„é’Ÿæ¨¡å¼çŠ¶æ€
                const focusMode = ref('free'); // 'free' æˆ– 'pomodoro'
                const pomodoroPhase = ref('focus'); // 'focus', 'shortBreak', 'longBreak'
                const pomodoroSession = ref(1);
                const pomodoroTimeLeft = ref(25 * 60); // å‰©ä½™æ—¶é—´ï¼ˆç§’ï¼‰
                const pomodoroConfig = reactive({
                    focusDuration: 25,
                    shortBreakDuration: 5,
                    longBreakDuration: 15,
                    longBreakInterval: 4
                });
                
                const todayStats = reactive({
                    totalDuration: 0,
                    focusCount: 0,
                    expEarned: 0,
                    tomatoCount: 0 // ä»Šæ—¥ç•ªèŒ„æ•°
                });
                
                const petInfo = reactive({
                    type: 'cat',
                    stage: 'baby',
                    level: 1,
                    exp: 0,
                    mood: 100,
                    name: 'å°è›‹è›‹'
                });
                
                // å® ç‰©çŠ¶æ€
                const petElement = ref(null);
                const petState = ref('idle');
                const petDirection = ref('right');
                const showBubble = ref(false);
                const bubbleText = ref('');
                
                // ç™½å™ªéŸ³
                const activeSounds = reactive({
                    rain: false,
                    fire: false,
                    forest: false,
                    ocean: false
                });
                const masterVolume = ref(0.4);
                
                // è®¾ç½®é¢æ¿
                const showSettings = ref(false);
                const currentTheme = ref('default');
                const hasPet = ref(false);
                const cooldowns = reactive({ feed: 0, pet: 0, play: 0 });
                
                // è¿”å›ç¡®è®¤å¼¹çª—
                const showBackConfirm = ref(false);
                
                // éŸ³é¢‘å¯¹è±¡
                const sounds = {};
                
                // è®¡æ—¶å™¨
                let timerId = null;
                let behaviorTimer = null;
                let milestoneChecker = null;
                
                // å® ç‰© AI
                const petAI = new PetBehaviorAI();
                let dragHandler = null;
                
                // ==================== è®¡ç®—å±æ€§ ====================
                const previewExp = computed(() => {
                    const minutes = Math.floor(secondsElapsed.value / 60);
                    if (minutes >= 30) {
                        return Math.floor(minutes * 1.5);
                    }
                    return minutes;
                });
                
                const petEmoji = computed(() => {
                    return petAI.getPetEmoji(petInfo.type, petInfo.stage);
                });
                
                const expInLevel = computed(() => {
                    return petInfo.exp % 100;
                });
                
                const expToNext = computed(() => {
                    return 100;
                });
                
                const expPercent = computed(() => {
                    return (expInLevel.value / expToNext.value) * 100;
                });
                
                // ==================== æ–¹æ³• ====================
                function formatTime(totalSeconds) {
                    // ç•ªèŒ„é’Ÿæ¨¡å¼æ˜¾ç¤ºå€’è®¡æ—¶
                    if (focusMode.value === 'pomodoro') {
                        const m = Math.floor(pomodoroTimeLeft.value / 60).toString().padStart(2, '0');
                        const s = (pomodoroTimeLeft.value % 60).toString().padStart(2, '0');
                        return `${m}:${s}`;
                    }
                    // è‡ªç”±æ¨¡å¼æ˜¾ç¤ºæ­£è®¡æ—¶
                    const m = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
                    const s = (totalSeconds % 60).toString().padStart(2, '0');
                    return `${m}:${s}`;
                }
                
                function formatDuration(seconds) {
                    if (!seconds || seconds < 60) return seconds ? `${seconds}ç§’` : '--';
                    const h = Math.floor(seconds / 3600);
                    const m = Math.floor((seconds % 3600) / 60);
                    if (h > 0) return `${h}h${m}m`;
                    return `${m}åˆ†é’Ÿ`;
                }
                
                // åˆ‡æ¢ä¸“æ³¨æ¨¡å¼
                function switchMode(mode) {
                    if (isRunning.value) {
                        if (!confirm('åˆ‡æ¢æ¨¡å¼å°†é‡ç½®è®¡æ—¶å™¨ï¼Œç¡®å®šå—ï¼Ÿ')) return;
                        stopTimerInternal();
                    }
                    
                    focusMode.value = mode;
                    secondsElapsed.value = 0;
                    
                    if (mode === 'pomodoro') {
                        document.body.classList.add('pomodoro-mode');
                        pomodoroPhase.value = 'focus';
                        pomodoroTimeLeft.value = pomodoroConfig.focusDuration * 60;
                        statusText.value = 'ğŸ… ç•ªèŒ„é’Ÿå‡†å¤‡å°±ç»ª';
                    } else {
                        document.body.classList.remove('pomodoro-mode');
                        statusText.value = 'å‡†å¤‡å¥½äº†å—ï¼Ÿ';
                    }
                }
                
                // ç•ªèŒ„é’Ÿé˜¶æ®µå®Œæˆ
                function completePomodoroPhase() {
                    pauseTimer();
                    
                    if (pomodoroPhase.value === 'focus') {
                        // å®Œæˆä¸€ä¸ªç•ªèŒ„
                        todayStats.tomatoCount++;
                        showPetBubble('ğŸ… å¤ªæ£’äº†ï¼å®Œæˆä¸€ä¸ªç•ªèŒ„ï¼');
                        petState.value = 'playing';
                        
                        // ä¿å­˜ç•ªèŒ„è®°å½•
                        saveFocusRecord(pomodoroConfig.focusDuration * 60, 'pomodoro');
                        
                        // æ’­æ”¾æç¤ºéŸ³
                        playPomodoroSound();
                        
                        // å†³å®šä¸‹ä¸€é˜¶æ®µ
                        if (pomodoroSession.value % pomodoroConfig.longBreakInterval === 0) {
                            pomodoroPhase.value = 'longBreak';
                            pomodoroTimeLeft.value = pomodoroConfig.longBreakDuration * 60;
                            statusText.value = 'â˜• é•¿ä¼‘æ¯æ—¶é—´';
                        } else {
                            pomodoroPhase.value = 'shortBreak';
                            pomodoroTimeLeft.value = pomodoroConfig.shortBreakDuration * 60;
                            statusText.value = 'â˜• çŸ­ä¼‘æ¯æ—¶é—´';
                        }
                        pomodoroSession.value++;
                    } else {
                        // ä¼‘æ¯ç»“æŸ
                        pomodoroPhase.value = 'focus';
                        pomodoroTimeLeft.value = pomodoroConfig.focusDuration * 60;
                        statusText.value = 'ğŸ… å‡†å¤‡å¼€å§‹æ–°ç•ªèŒ„';
                        showPetBubble('ä¼‘æ¯ç»“æŸå•¦~å‡†å¤‡å¥½ç»§ç»­äº†å—ï¼Ÿ');
                        playPomodoroSound();
                    }
                    
                    setTimeout(() => petState.value = 'idle', 2000);
                }
                
                // æ’­æ”¾ç•ªèŒ„é’Ÿæç¤ºéŸ³
                function playPomodoroSound() {
                    try {
                        const audio = new AudioContext();
                        const oscillator = audio.createOscillator();
                        const gain = audio.createGain();
                        
                        oscillator.connect(gain);
                        gain.connect(audio.destination);
                        
                        oscillator.frequency.value = 880;
                        oscillator.type = 'sine';
                        
                        gain.gain.setValueAtTime(0.3, audio.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, audio.currentTime + 0.5);
                        
                        oscillator.start(audio.currentTime);
                        oscillator.stop(audio.currentTime + 0.5);
                    } catch (err) {
                        console.log('æ— æ³•æ’­æ”¾æç¤ºéŸ³');
                    }
                }
                
                function toggleTimer() {
                    if (isRunning.value) {
                        pauseTimer();
                    } else {
                        startTimer();
                    }
                }
                
                function startTimer() {
                    isRunning.value = true;
                    document.body.classList.add('focus-mode');
                    
                    if (focusMode.value === 'pomodoro') {
                        statusText.value = pomodoroPhase.value === 'focus' ? 'ğŸ… ä¸“æ³¨è¿›è¡Œä¸­...' : 'â˜• ä¼‘æ¯ä¸­...';
                    } else {
                        statusText.value = 'ä¸“æ³¨è¿›è¡Œä¸­...';
                    }
                    
                    // å¼€å§‹æ—¶å® ç‰©è¯´è¯
                    if (secondsElapsed.value === 0 && focusMode.value !== 'pomodoro') {
                        showPetBubble(petAI.getRandomDialogue('focus_start'));
                        petAI.resetMilestone();
                    } else if (focusMode.value === 'pomodoro' && pomodoroPhase.value === 'focus') {
                        showPetBubble('ğŸ… ç•ªèŒ„é’Ÿå¼€å§‹ï¼åŠ æ²¹ï¼');
                    }
                    
                    timerId = setInterval(() => {
                        if (focusMode.value === 'pomodoro') {
                            // ç•ªèŒ„é’Ÿå€’è®¡æ—¶
                            pomodoroTimeLeft.value--;
                            secondsElapsed.value++; // åŒæ—¶è®°å½•æ€»æ—¶é—´
                            
                            if (pomodoroTimeLeft.value <= 0) {
                                completePomodoroPhase();
                            } else {
                                document.title = `(${formatTime(secondsElapsed.value)}) ç•ªèŒ„é’Ÿ`;
                            }
                        } else {
                            // è‡ªç”±æ¨¡å¼æ­£è®¡æ—¶
                            secondsElapsed.value++;
                            document.title = `(${formatTime(secondsElapsed.value)}) ä¸“æ³¨ä¸­`;
                            
                            // æ£€æŸ¥é‡Œç¨‹ç¢‘
                            const milestoneMsg = petAI.checkMilestone(secondsElapsed.value);
                            if (milestoneMsg) {
                                showPetBubble(milestoneMsg);
                                petState.value = 'interact';
                                setTimeout(() => {
                                    if (isRunning.value) petState.value = 'idle';
                                }, 1000);
                            }
                        }
                    }, 1000);
                }
                
                function pauseTimer() {
                    clearInterval(timerId);
                    isRunning.value = false;
                    document.body.classList.remove('focus-mode');
                    
                    if (focusMode.value === 'pomodoro') {
                        statusText.value = 'â¸ï¸ æš‚åœä¸­';
                    } else {
                        statusText.value = 'æš‚åœä¸­';
                    }
                    document.title = 'æ·±åº¦ä¸“æ³¨ - äº‘ç«¯è‡ªä¹ å®¤';
                }
                
                function stopTimerInternal() {
                    clearInterval(timerId);
                    isRunning.value = false;
                    document.body.classList.remove('focus-mode');
                    secondsElapsed.value = 0;
                    
                    if (focusMode.value === 'pomodoro') {
                        pomodoroPhase.value = 'focus';
                        pomodoroTimeLeft.value = pomodoroConfig.focusDuration * 60;
                        statusText.value = 'ğŸ… ç•ªèŒ„é’Ÿå‡†å¤‡å°±ç»ª';
                    } else {
                        statusText.value = 'å‡†å¤‡å¥½äº†å—ï¼Ÿ';
                    }
                    
                    document.title = 'æ·±åº¦ä¸“æ³¨ - äº‘ç«¯è‡ªä¹ å®¤';
                    petAI.resetMilestone();
                }
                
                async function stopTimer() {
                    // è®¾ç½®åœæ­¢æ ‡å¿—ï¼Œé˜²æ­¢ visibilitychange è§¦å‘æš‚åœ
                    isStopping.value = true;
                    
                    // å…ˆæ¸…é™¤è®¡æ—¶å™¨
                    clearInterval(timerId);
                    isRunning.value = false;
                    document.body.classList.remove('focus-mode');
                    
                    // ä¿å­˜å½“å‰æ—¶é•¿ï¼Œé¿å…è¢«é‡ç½®
                    const duration = secondsElapsed.value;
                    console.log('åœæ­¢è®¡æ—¶å™¨ï¼Œæ—¶é•¿:', duration, 'ç§’');
                    
                    // ä¿å­˜è®°å½•ï¼ˆéœ€è¦è‡³å°‘1åˆ†é’Ÿï¼‰
                    if (duration >= 60) {
                        if (focusMode.value === 'pomodoro') {
                            // ç•ªèŒ„é’Ÿæ¨¡å¼ä¸‹ï¼Œè®°å½•å®é™…ä¸“æ³¨æ—¶é—´
                            const focusedTime = pomodoroConfig.focusDuration * 60 - pomodoroTimeLeft.value;
                            console.log('ç•ªèŒ„é’Ÿæ¨¡å¼ï¼Œå®é™…ä¸“æ³¨æ—¶é—´:', focusedTime, 'ç§’');
                            if (focusedTime >= 60) {
                                await saveFocusRecord(focusedTime, 'pomodoro');
                            } else {
                                showToast('ä¸“æ³¨ä¸è¶³1åˆ†é’Ÿï¼Œä¸è®°å½•ç»éªŒ');
                            }
                        } else {
                            // è‡ªç”±æ¨¡å¼ï¼Œä¿å­˜å®é™…è®¡æ—¶æ—¶é•¿
                            console.log('è‡ªç”±æ¨¡å¼ï¼Œä¿å­˜æ—¶é•¿:', duration, 'ç§’');
                            await saveFocusRecord(duration, 'free');
                        }
                    } else if (duration > 0) {
                        showToast('ä¸“æ³¨ä¸è¶³1åˆ†é’Ÿï¼Œä¸è®°å½•ç»éªŒ');
                    }
                    
                    // ä¿å­˜å®Œæˆåå†é‡ç½®çŠ¶æ€
                    secondsElapsed.value = 0;
                    isStopping.value = false;
                    
                    if (focusMode.value === 'pomodoro') {
                        pomodoroPhase.value = 'focus';
                        pomodoroTimeLeft.value = pomodoroConfig.focusDuration * 60;
                        statusText.value = 'ğŸ… ç•ªèŒ„é’Ÿå‡†å¤‡å°±ç»ª';
                    } else {
                        statusText.value = 'å‡†å¤‡å¥½äº†å—ï¼Ÿ';
                    }
                    
                    document.title = 'æ·±åº¦ä¸“æ³¨ - äº‘ç«¯è‡ªä¹ å®¤';
                    petAI.resetMilestone();
                }
                
                async function saveFocusRecord(duration, type = 'free') {
                    console.log('ä¿å­˜ä¸“æ³¨è®°å½•:', { duration, type });
                    try {
                        const res = await fetch('/api/focus/save', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ duration, type })
                        });
                        const data = await res.json();
                        console.log('ä¿å­˜ç»“æœ:', data);
                        
                        if (data.success) {
                            const expEarned = data.expEarned || 0;
                            if (type === 'pomodoro') {
                                showToast(`ğŸ… ç•ªèŒ„å®Œæˆï¼è·å¾— ${expEarned} ç»éªŒå€¼ï¼ˆå«20%å¥–åŠ±ï¼‰`);
                            } else {
                                showToast(`ä¸“æ³¨ ${formatDuration(duration)} å·²è®°å½•ï¼è·å¾— ${expEarned} ç»éªŒå€¼`);
                            }
                            
                            // æ›´æ–°ä»Šæ—¥ç»Ÿè®¡
                            todayStats.totalDuration += duration;
                            todayStats.focusCount += 1;
                            todayStats.expEarned += expEarned;
                            
                            // æ›´æ–°å® ç‰©ç»éªŒ
                            petInfo.exp += expEarned;
                            
                            // æ£€æŸ¥æ˜¯å¦å‡çº§
                            const newLevel = Math.floor(petInfo.exp / 100) + 1;
                            if (newLevel > petInfo.level) {
                                petInfo.level = newLevel;
                                showPetBubble(`ğŸ‰ æ­å–œï¼å® ç‰©å‡åˆ° Lv.${newLevel} å•¦ï¼`);
                            } else if (type !== 'pomodoro') {
                                showPetBubble('å¤ªæ£’äº†ï¼åˆè·å¾—ç»éªŒå•¦~');
                            }
                            
                            petState.value = 'playing';
                            setTimeout(() => petState.value = 'idle', 2000);
                            
                            return true;
                        } else {
                            console.error('ä¿å­˜å¤±è´¥:', data.message);
                            showToast(data.message || 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
                            return false;
                        }
                    } catch (err) {
                        console.error('ä¿å­˜å¤±è´¥:', err);
                        showToast('ç½‘ç»œé”™è¯¯ï¼Œä¿å­˜å¤±è´¥');
                        return false;
                    }
                }
                
                async function loadTodayStats() {
                    try {
                        const res = await fetch('/api/focus/today');
                        const data = await res.json();
                        console.log('ä»Šæ—¥ç»Ÿè®¡æ•°æ®:', data);
                        if (data.success) {
                            todayStats.totalDuration = data.totalDuration || 0;
                            todayStats.focusCount = data.focusCount || 0;
                            todayStats.expEarned = data.expEarned || 0;
                            todayStats.tomatoCount = data.tomatoCount || 0;
                        } else {
                            console.warn('è·å–ä»Šæ—¥ç»Ÿè®¡å¤±è´¥:', data.message);
                        }
                    } catch (err) {
                        console.error('è·å–ç»Ÿè®¡å¤±è´¥:', err);
                    }
                }
                
                async function loadPetInfo() {
                    try {
                        const res = await fetch('/api/pet');
                        const data = await res.json();
                        console.log('å® ç‰©ä¿¡æ¯:', data);
                        if (data.success && data.hasPet) {
                            hasPet.value = true;
                            const pet = data.pet;
                            petInfo.type = pet.type || 'cat';
                            petInfo.stage = pet.stage || 'baby';
                            petInfo.level = pet.level || 1;
                            petInfo.exp = pet.exp || 0;
                            petInfo.mood = pet.mood || 100;
                            petInfo.name = pet.name || 'å°è›‹è›‹';
                            console.log('å® ç‰©ç»éªŒ:', petInfo.exp, 'expInLevel:', petInfo.exp % 100);
                        } else {
                            hasPet.value = false;
                            console.warn('æ²¡æœ‰å® ç‰©æˆ–è·å–å¤±è´¥:', data.message);
                        }
                    } catch (err) {
                        console.error('è·å–å® ç‰©ä¿¡æ¯å¤±è´¥:', err);
                        hasPet.value = false;
                    }
                }
                
                // å® ç‰©ç›¸å…³
                function showPetBubble(text) {
                    bubbleText.value = text;
                    showBubble.value = true;
                    setTimeout(() => showBubble.value = false, 3000);
                }
                
                function handlePetClick() {
                    if (dragHandler && dragHandler.isDragging) return;
                    
                    petState.value = 'interact';
                    showPetBubble(petAI.getRandomDialogue('interact'));
                    
                    setTimeout(() => {
                        petState.value = isRunning.value ? 'idle' : petAI.decide({
                            isFocusing: isRunning.value,
                            focusDuration: secondsElapsed.value,
                            mood: petInfo.mood
                        });
                    }, 500);
                }
                
                function startPetBehavior() {
                    const tick = () => {
                        if (dragHandler && dragHandler.isDragging) {
                            behaviorTimer = setTimeout(tick, 1000);
                            return;
                        }
                        
                        const nextState = petAI.decide({
                            isFocusing: isRunning.value,
                            focusDuration: secondsElapsed.value,
                            mood: petInfo.mood
                        });
                        
                        petState.value = nextState;
                        
                        // èµ°åŠ¨æ—¶ç§»åŠ¨ä½ç½®
                        if (nextState === 'walking' && dragHandler) {
                            petDirection.value = dragHandler.randomMove();
                        }
                        
                        const delay = petAI.getNextDelay(nextState);
                        behaviorTimer = setTimeout(tick, delay);
                    };
                    
                    tick();
                }
                
                // ç™½å™ªéŸ³
                function initSounds() {
                    const soundFiles = {
                        rain: '/audio/rain.mp3',
                        fire: '/audio/fire.mp3',
                        forest: '/audio/forest.mp3',
                        ocean: '/audio/ocean.mp3'
                    };
                    
                    for (const [name, src] of Object.entries(soundFiles)) {
                        const audio = new Audio(src);
                        audio.loop = true;
                        audio.volume = masterVolume.value;
                        sounds[name] = audio;
                    }
                }
                
                function toggleSound(name) {
                    const audio = sounds[name];
                    if (!audio) return;
                    
                    if (audio.paused) {
                        audio.play();
                        activeSounds[name] = true;
                        // æ·¡å…¥
                        audio.volume = 0;
                        let vol = 0;
                        const fadeIn = setInterval(() => {
                            if (vol < masterVolume.value) {
                                vol += 0.05;
                                if (vol > masterVolume.value) vol = masterVolume.value;
                                audio.volume = vol;
                            } else {
                                clearInterval(fadeIn);
                            }
                        }, 50);
                    } else {
                        audio.pause();
                        activeSounds[name] = false;
                    }
                }
                
                function updateVolume() {
                    for (const [name, audio] of Object.entries(sounds)) {
                        if (!audio.paused) {
                            audio.volume = masterVolume.value;
                        }
                    }
                }

                // ==================== æ–°å¢åŠŸèƒ½ ====================
                
                // ç•ªèŒ„é’Ÿæ—¶é•¿è®¾ç½®
                function setPomodoroConfig(type, value) {
                    if (isRunning.value) {
                        showToast('è¯·å…ˆåœæ­¢è®¡æ—¶å†ä¿®æ”¹è®¾ç½®');
                        return;
                    }
                    
                    if (type === 'focus') {
                        pomodoroConfig.focusDuration = value;
                    } else if (type === 'short') {
                        pomodoroConfig.shortBreakDuration = value;
                    } else if (type === 'long') {
                        pomodoroConfig.longBreakDuration = value;
                    }
                    
                    // ä¿å­˜åˆ°æœ¬åœ°
                    localStorage.setItem('pomodoroConfig', JSON.stringify(pomodoroConfig));
                    
                    // æ›´æ–°å½“å‰æ˜¾ç¤º
                    if (focusMode.value === 'pomodoro' && pomodoroPhase.value === 'focus') {
                        pomodoroTimeLeft.value = pomodoroConfig.focusDuration * 60;
                    }
                    
                    showToast('è®¾ç½®å·²ä¿å­˜');
                }
                
                // ä¸»é¢˜åˆ‡æ¢
                function changeTheme(theme) {
                    currentTheme.value = theme;
                    localStorage.setItem('focusTheme', theme);
                    
                    const themes = {
                        default: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                        sunset: 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%)',
                        forest: 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                        ocean: 'linear-gradient(135deg, #74b9ff 0%, #0984e3 100%)',
                        night: 'linear-gradient(135deg, #2c3e50 0%, #4a6741 100%)',
                        cherry: 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)'
                    };
                    
                    document.body.style.background = themes[theme] || themes.default;
                    showToast(`å·²åˆ‡æ¢åˆ°${theme === 'default' ? 'é»˜è®¤' : theme}ä¸»é¢˜`);
                }

                // å® ç‰©å¿«æ·äº’åŠ¨
                async function quickInteract(type) {
                    if (cooldowns[type] > 0 && type !== 'talk') return;

                    try {
                        let endpoint = '/api/pet/interact';
                        let method = 'POST';
                        let requestBody = { interactType: type };
                        
                        if (type === 'talk') {
                            // èŠå¤©ç›´æ¥æ˜¾ç¤ºå¯¹è¯
                            const hour = new Date().getHours();
                            let messages;
                            if (hour < 12) {
                                messages = ['æ—©ä¸Šå¥½å•Šä¸»äººï¼', 'æ–°çš„ä¸€å¤©å¼€å§‹å•¦~', 'ä»Šå¤©ä¹Ÿè¦åŠ æ²¹å“¦ï¼'];
                            } else if (hour < 18) {
                                messages = ['ä¸‹åˆå¥½~', 'å­¦ä¹ ç´¯äº†å—ï¼Ÿ', 'è¦ä¸è¦ä¼‘æ¯ä¸€ä¸‹ï¼Ÿ'];
                            } else {
                                messages = ['æ™šä¸Šå¥½ï¼', 'ä»Šå¤©è¾›è‹¦äº†~', 'æ™šå®‰ï¼Œå¥½æ¢¦~'];
                            }
                            
                            const message = messages[Math.floor(Math.random() * messages.length)];
                            showPetBubble(message);
                            petState.value = 'interact';
                            setTimeout(() => petState.value = 'idle', 2000);
                            return;
                        }

                        const res = await fetch(endpoint, { 
                            method,
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(requestBody)
                        });
                        const data = await res.json();

                        if (data.success) {
                            showPetBubble(data.message || 'äº’åŠ¨æˆåŠŸï¼');
                            
                            // æ›´æ–°å® ç‰©ä¿¡æ¯
                            if (data.mood !== undefined) {
                                petInfo.mood = data.mood;
                            }
                            if (data.exp !== undefined) {
                                petInfo.exp = data.exp;
                            }
                            if (data.level !== undefined) {
                                petInfo.level = data.level;
                            }

                            // è®¾ç½®å†·å´æ—¶é—´
                            if (type === 'feed') {
                                cooldowns.feed = 30 * 60; // 30åˆ†é’Ÿ
                                petState.value = 'eating';
                            } else if (type === 'pet') {
                                cooldowns.pet = 5 * 60; // 5åˆ†é’Ÿ
                                petState.value = 'happy';
                            } else if (type === 'play') {
                                cooldowns.play = 15 * 60; // 15åˆ†é’Ÿ
                                petState.value = 'playing';
                            }

                            setTimeout(() => petState.value = 'idle', 2000);
                            
                            // å¼€å§‹å†·å´å€’è®¡æ—¶
                            startCooldownTimer();
                        } else {
                            showToast(data.message || 'äº’åŠ¨å¤±è´¥');
                        }
                    } catch (err) {
                        console.error('äº’åŠ¨å¤±è´¥:', err);
                        showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
                    }
                }

                // å†·å´æ—¶é—´å€’è®¡æ—¶
                function startCooldownTimer() {
                    setInterval(() => {
                        if (cooldowns.feed > 0) cooldowns.feed--;
                        if (cooldowns.pet > 0) cooldowns.pet--;
                        if (cooldowns.play > 0) cooldowns.play--;
                    }, 1000);
                }

                // æ ¼å¼åŒ–å†·å´æ—¶é—´
                function formatCooldown(seconds) {
                    const m = Math.floor(seconds / 60);
                    const s = seconds % 60;
                    return m > 0 ? `${m}åˆ†é’Ÿ` : `${s}ç§’`;
                }

                // è¿”å›å°å±‹å¼¹çª—
                function showBackModal() {
                    if (isRunning.value) {
                        pauseTimer();
                    }
                    showBackConfirm.value = true;
                }

                async function confirmBack() {
                    // å¦‚æœæœ‰ä¸“æ³¨è®°å½•ï¼Œå…ˆä¿å­˜
                    if (secondsElapsed.value >= 60) {
                        await saveFocusRecord(secondsElapsed.value);
                    }
                    
                    // åœæ­¢æ‰€æœ‰éŸ³é¢‘
                    for (const audio of Object.values(sounds)) {
                        audio.pause();
                    }
                    
                    // è·³è½¬åˆ°å­¦ä¹ å°å±‹
                    window.location.href = '/study.html';
                }

                // é¡µé¢ç¦»å¼€æé†’
                function setupPageLeaveWarning() {
                    window.addEventListener('beforeunload', (e) => {
                        if (isRunning.value && !isStopping.value) {
                            e.preventDefault();
                            e.returnValue = 'ç¦»å¼€é¡µé¢å°†æš‚åœä¸“æ³¨è®¡æ—¶ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
                            return e.returnValue;
                        }
                    });

                    // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
                    document.addEventListener('visibilitychange', () => {
                        // å¦‚æœæ­£åœ¨åœæ­¢ï¼Œä¸è¦æš‚åœ
                        if (isStopping.value) return;
                        
                        if (document.hidden && isRunning.value) {
                            showToast('é¡µé¢å·²éšè—ï¼Œä¸“æ³¨è®¡æ—¶æš‚åœ');
                            pauseTimer();
                        }
                    });
                }
                
                function showToast(message) {
                    const existing = document.querySelector('.focus-toast');
                    if (existing) existing.remove();
                    
                    const toast = document.createElement('div');
                    toast.className = 'focus-toast';
                    toast.textContent = message;
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 3000);
                }
                
                // ==================== ç”Ÿå‘½å‘¨æœŸ ====================
                onMounted(() => {
                    loadTodayStats();
                    loadPetInfo();
                    initSounds();
                    
                    // åˆå§‹åŒ–æ–°åŠŸèƒ½
                    setupPageLeaveWarning();
                    startCooldownTimer();
                    
                    // åŠ è½½ä¿å­˜çš„ä¸»é¢˜
                    const savedTheme = localStorage.getItem('focusTheme') || 'default';
                    changeTheme(savedTheme);
                    
                    // åŠ è½½ç•ªèŒ„é’Ÿé…ç½®
                    const savedPomodoroConfig = localStorage.getItem('pomodoroConfig');
                    if (savedPomodoroConfig) {
                        try {
                            const config = JSON.parse(savedPomodoroConfig);
                            pomodoroConfig.focusDuration = config.focusDuration || 25;
                            pomodoroConfig.shortBreakDuration = config.shortBreakDuration || 5;
                            pomodoroConfig.longBreakDuration = config.longBreakDuration || 15;
                            pomodoroTimeLeft.value = pomodoroConfig.focusDuration * 60;
                        } catch(e) {}
                    }
                    
                    // åˆå§‹åŒ–å® ç‰©æ‹–åŠ¨
                    setTimeout(() => {
                        if (petElement.value) {
                            dragHandler = new PetDragHandler(petElement.value, {
                                initialX: window.innerWidth * 0.2,
                                initialY: window.innerHeight * 0.55,
                                onDragStart: () => {
                                    petState.value = 'interact';
                                },
                                onDragEnd: () => {
                                    showPetBubble(petAI.getRandomDialogue('drag'));
                                    setTimeout(() => {
                                        petState.value = 'idle';
                                    }, 500);
                                }
                            });
                        }
                        
                        startPetBehavior();
                    }, 100);
                });
                
                onUnmounted(() => {
                    clearInterval(timerId);
                    clearTimeout(behaviorTimer);
                    
                    // åœæ­¢æ‰€æœ‰éŸ³é¢‘
                    for (const audio of Object.values(sounds)) {
                        audio.pause();
                    }
                });
                
                return {
                    secondsElapsed,
                    isRunning,
                    statusText,
                    todayStats,
                    petInfo,
                    petElement,
                    petState,
                    petDirection,
                    showBubble,
                    bubbleText,
                    petEmoji,
                    previewExp,
                    expInLevel,
                    expToNext,
                    expPercent,
                    activeSounds,
                    masterVolume,
                    formatTime,
                    formatDuration,
                    toggleTimer,
                    stopTimer,
                    handlePetClick,
                    toggleSound,
                    updateVolume,
                    // æ–°å¢åŠŸèƒ½
                    showSettings,
                    currentTheme,
                    hasPet,
                    cooldowns,
                    changeTheme,
                    quickInteract,
                    formatCooldown,
                    // è¿”å›ç¡®è®¤å¼¹çª—
                    showBackConfirm,
                    showBackModal,
                    confirmBack,
                    // ç•ªèŒ„é’Ÿæ¨¡å¼
                    focusMode,
                    pomodoroPhase,
                    pomodoroSession,
                    pomodoroTimeLeft,
                    pomodoroConfig,
                    switchMode,
                    setPomodoroConfig
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
