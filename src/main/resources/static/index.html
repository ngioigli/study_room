<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äº‘ç«¯è‡ªä¹ å®¤</title>
    <link rel="stylesheet" href="/css/variables.css">
    <link rel="stylesheet" href="/css/components.css">
    <style>
        body {
            background: var(--color-bg);
        }

        .page-container {
            min-height: 100vh;
            padding: var(--space-4);
            padding-bottom: calc(var(--nav-height) + var(--space-6));
        }

        /* é—®å€™å¡ç‰‡ */
        .greeting-card {
            background: var(--gradient-primary);
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            color: #fff;
            margin-bottom: var(--space-5);
            box-shadow: var(--shadow-card);
        }

        .greeting-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            margin-bottom: var(--space-2);
        }

        .greeting-subtitle {
            font-size: var(--font-size-sm);
            opacity: 0.9;
        }

        .greeting-stats {
            display: flex;
            gap: var(--space-6);
            margin-top: var(--space-5);
        }

        .greeting-stat {
            text-align: center;
        }

        .greeting-stat-value {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
        }

        .greeting-stat-label {
            font-size: var(--font-size-xs);
            opacity: 0.8;
            margin-top: 2px;
        }

        /* äºŒç»´ç å¡ç‰‡ */
        .qrcode-card {
            background: #fff;
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            text-align: center;
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-5);
        }

        .qrcode-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-dark);
            margin-bottom: var(--space-4);
        }

        .qrcode-container {
            width: 200px;
            height: 200px;
            margin: 0 auto var(--space-4);
            background: var(--color-card-bg);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .qrcode-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            filter: blur(8px);
            transition: filter 0.3s;
        }

        .qrcode-container.unlocked img {
            filter: none;
        }

        .qrcode-placeholder {
            font-size: 48px;
            color: var(--color-text-tertiary);
        }

        .qrcode-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #fff;
            border-radius: var(--radius-lg);
        }

        .qrcode-overlay.hidden {
            display: none;
        }

        .qrcode-overlay-icon {
            font-size: 32px;
            margin-bottom: var(--space-2);
        }

        .qrcode-overlay-text {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
        }

        .qrcode-status {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            margin-bottom: var(--space-4);
        }

        .qrcode-status.locked {
            color: var(--color-warning);
        }

        .qrcode-countdown {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
            margin-bottom: var(--space-4);
        }

        /* å åº§çŠ¶æ€å¡ç‰‡ */
        .seat-status-card {
            background: linear-gradient(135deg, #10B981, #34D399);
            border-radius: var(--radius-xl);
            padding: var(--space-5);
            color: #fff;
            margin-bottom: var(--space-5);
            box-shadow: var(--shadow-card);
            display: none;
        }

        .seat-status-card.active {
            display: block;
        }

        .seat-status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-3);
        }

        .seat-status-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-bold);
        }

        .seat-status-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
        }

        .seat-status-info {
            display: flex;
            gap: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .seat-status-item {
            text-align: center;
        }

        .seat-status-value {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
        }

        .seat-status-label {
            font-size: var(--font-size-xs);
            opacity: 0.9;
        }

        .leave-seat-btn {
            width: 100%;
            padding: var(--space-3);
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: var(--radius-lg);
            color: #fff;
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .leave-seat-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* åº§ä½çŠ¶æ€ */
        .section-title {
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-secondary);
            margin-bottom: var(--space-4);
            padding-left: var(--space-1);
        }

        .seats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-3);
        }

        .seat-item {
            aspect-ratio: 1;
            background: var(--color-card-bg);
            border-radius: var(--radius-md);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-secondary);
            transition: var(--transition-fast);
        }

        .seat-item.occupied {
            background: var(--color-primary-bg);
            color: var(--color-primary);
        }

        .seat-item.available {
            background: var(--color-success-bg);
            color: var(--color-success);
        }

        .seat-icon {
            font-size: 20px;
        }

        /* å¿«æ·å…¥å£ */
        .quick-access {
            display: flex;
            gap: var(--space-3);
            margin-bottom: var(--space-5);
            overflow-x: auto;
            padding-bottom: var(--space-2);
            -webkit-overflow-scrolling: touch;
        }

        .quick-access::-webkit-scrollbar {
            display: none;
        }

        .quick-item {
            flex-shrink: 0;
            width: 72px;
            text-align: center;
            text-decoration: none;
            color: var(--color-text-primary);
        }

        .quick-icon {
            width: 56px;
            height: 56px;
            margin: 0 auto var(--space-2);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: var(--transition-fast);
        }

        .quick-item:nth-child(1) .quick-icon { background: #FEF3C7; }
        .quick-item:nth-child(2) .quick-icon { background: #DBEAFE; }
        .quick-item:nth-child(3) .quick-icon { background: #FCE7F3; }
        .quick-item:nth-child(4) .quick-icon { background: #D1FAE5; }
        .quick-item:nth-child(5) .quick-icon { background: #FEE2E2; }
        .quick-item:nth-child(6) .quick-icon { background: #E0E7FF; }

        .quick-item:hover .quick-icon {
            transform: scale(1.05);
        }

        .quick-label {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
        }
    </style>
</head>
<body>
    <div class="page-container page-with-nav">
        <!-- é—®å€™å¡ç‰‡ -->
        <div class="greeting-card">
            <div class="greeting-title">æ¬¢è¿å›æ¥ï¼Œ<span id="userName">åŒå­¦</span></div>
            <div class="greeting-subtitle">ä»Šå¤©ä¹Ÿè¦åŠ æ²¹å“¦ï¼</div>
            <div class="greeting-stats">
                <div class="greeting-stat">
                    <div class="greeting-stat-value" id="todayDuration">--</div>
                    <div class="greeting-stat-label">ä»Šæ—¥å­¦ä¹ </div>
                </div>
                <div class="greeting-stat">
                    <div class="greeting-stat-value" id="todayCount">-</div>
                    <div class="greeting-stat-label">ä¸“æ³¨æ¬¡æ•°</div>
                </div>
                <div class="greeting-stat">
                    <div class="greeting-stat-value" id="todayExp">-</div>
                    <div class="greeting-stat-label">è·å¾—ç»éªŒ</div>
                </div>
            </div>
        </div>

        <!-- å åº§çŠ¶æ€å¡ç‰‡ï¼ˆé»˜è®¤éšè—ï¼‰ -->
        <div class="seat-status-card" id="seatStatusCard">
            <div class="seat-status-header">
                <span class="seat-status-title">ğŸ¯ æ­£åœ¨å åº§ä¸­</span>
                <span class="seat-status-badge" id="seatStatusBadge">ä½¿ç”¨ä¸­</span>
            </div>
            <div class="seat-status-info">
                <div class="seat-status-item">
                    <div class="seat-status-value" id="currentSeatNumber">--</div>
                    <div class="seat-status-label">åº§ä½å·</div>
                </div>
                <div class="seat-status-item">
                    <div class="seat-status-value" id="seatUseDuration">--</div>
                    <div class="seat-status-label">å·²ä½¿ç”¨</div>
                </div>
                <div class="seat-status-item">
                    <div class="seat-status-value" id="seatPowerStatus">ğŸ”Œ</div>
                    <div class="seat-status-label">ç”µæºçŠ¶æ€</div>
                </div>
            </div>
            <button class="leave-seat-btn" onclick="leaveSeat()">ğŸšª ä¸€é”®ç¦»åº§æ–­ç”µ</button>
        </div>

        <!-- äºŒç»´ç å¡ç‰‡ -->
        <div class="qrcode-card">
            <div class="qrcode-title">æ‰«ç è¿›å…¥è‡ªä¹ å®¤</div>
            <div class="qrcode-container" id="qrcodeContainer" onclick="window.location.href='/qrcode_scan.html'">
                <img id="qrcodeImg" src="" alt="äºŒç»´ç " style="display: none;">
                <div class="qrcode-placeholder" id="qrcodePlaceholder">ğŸ“±</div>
                <div class="qrcode-overlay" id="qrcodeOverlay">
                    <div class="qrcode-overlay-icon">ğŸ”’</div>
                    <div class="qrcode-overlay-text">ç‚¹å‡»è¿›å…¥æ‰«ç </div>
                </div>
            </div>
            <div class="qrcode-countdown" id="countdown" style="display: none;">03:00</div>
            <div class="qrcode-status" id="qrcodeStatus">ç‚¹å‡»ä¸Šæ–¹åŒºåŸŸè¿›å…¥æ‰«ç é¡µé¢</div>
            <a href="/qrcode_scan.html" class="btn btn-primary btn-large" style="display: block; text-decoration: none; text-align: center;">æ‰«ç å¼€é—¨</a>
        </div>

        <!-- å¿«æ·å…¥å£ -->
        <div class="section-title">å¸¸ç”¨åŠŸèƒ½</div>
        <div class="quick-access">
            <a href="/focus.html" class="quick-item">
                <div class="quick-icon">â±ï¸</div>
                <span class="quick-label">ä¸“æ³¨æ¨¡å¼</span>
            </a>
            <a href="/calendar.html" class="quick-item">
                <div class="quick-icon">ğŸ“…</div>
                <span class="quick-label">å­¦ä¹ æ—¥å†</span>
            </a>
            <a href="/encouragement.html" class="quick-item">
                <div class="quick-icon">ğŸ’Œ</div>
                <span class="quick-label">æ¸©æš–ä¼ é€’</span>
            </a>
            <a href="/ranking.html" class="quick-item">
                <div class="quick-icon">ğŸ†</div>
                <span class="quick-label">æ’è¡Œæ¦œ</span>
            </a>
            <a href="/message.html" class="quick-item">
                <div class="quick-icon">ğŸ’¬</div>
                <span class="quick-label">ç•™è¨€æ¿</span>
            </a>
            <a href="/reservation.html" class="quick-item">
                <div class="quick-icon">ğŸ“Œ</div>
                <span class="quick-label">åº§ä½é¢„çº¦</span>
            </a>
        </div>

        <!-- åº§ä½çŠ¶æ€ -->
        <div class="section-title">åº§ä½çŠ¶æ€</div>
        <div class="seats-grid" id="seatsGrid">
            <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <nav class="bottom-nav">
        <a href="/index.html" class="nav-item active">
            <span class="nav-icon">ğŸ </span>
            <span class="nav-label">è‡ªä¹ å®¤</span>
        </a>
        <a href="/study.html" class="nav-item">
            <span class="nav-icon">ğŸ“š</span>
            <span class="nav-label">å­¦ä¹ å°å±‹</span>
        </a>
        <a href="/member.html" class="nav-item">
            <span class="nav-icon">ğŸ‘‘</span>
            <span class="nav-label">ä¼šå‘˜</span>
        </a>
        <a href="/profile.html" class="nav-item">
            <span class="nav-icon">ğŸ‘¤</span>
            <span class="nav-label">æˆ‘çš„</span>
        </a>
    </nav>

    <script src="/js/nav.js"></script>
    <script>
        // DOM å…ƒç´ 
        const seatsGrid = document.getElementById('seatsGrid');

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadUserInfo();
            loadTodayStats();
            loadSeats();
            loadCurrentSeatStatus();
        });

        // æ ¼å¼åŒ–æ—¶é•¿ï¼ˆç§’è½¬ä¸ºå¯è¯»æ ¼å¼ï¼‰
        function formatDuration(seconds) {
            if (!seconds || seconds <= 0) return '0åˆ†';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            if (hours > 0) {
                return minutes > 0 ? `${hours}h${minutes}m` : `${hours}h`;
            }
            return `${minutes}åˆ†`;
        }

        // åŠ è½½å½“å‰å åº§çŠ¶æ€
        async function loadCurrentSeatStatus() {
            try {
                const res = await fetch('/api/orders/current');
                const data = await res.json();
                
                if (data.success && data.hasActiveOrder) {
                    const card = document.getElementById('seatStatusCard');
                    card.classList.add('active');
                    
                    // ä¿å­˜å½“å‰è®¢å•ä¿¡æ¯ä»¥ä¾¿ç¦»åº§æ—¶ä½¿ç”¨
                    window.currentOrderId = data.order.id;
                    
                    document.getElementById('currentSeatNumber').textContent = data.seat?.seatNumber || '--';
                    document.getElementById('seatPowerStatus').textContent = data.seat?.powerOn ? 'âš¡ å·²é€šç”µ' : 'ğŸ”Œ å·²æ–­ç”µ';
                    
                    // è®¡ç®—ä½¿ç”¨æ—¶é•¿
                    if (data.order.startTime) {
                        updateSeatDuration(data.order.startTime);
                        setInterval(() => updateSeatDuration(data.order.startTime), 60000);
                    }
                }
            } catch (err) {
                console.error('åŠ è½½å åº§çŠ¶æ€å¤±è´¥:', err);
            }
        }

        // æ›´æ–°ä½¿ç”¨æ—¶é•¿
        function updateSeatDuration(startTime) {
            const start = new Date(startTime);
            const now = new Date();
            const diffSeconds = Math.floor((now - start) / 1000);
            document.getElementById('seatUseDuration').textContent = formatDuration(diffSeconds);
        }

        // ä¸€é”®ç¦»åº§
        async function leaveSeat() {
            if (!window.currentOrderId) {
                alert('æœªæ‰¾åˆ°å½“å‰è®¢å•ä¿¡æ¯');
                return;
            }
            
            if (!confirm('ç¡®å®šè¦ç¦»åº§å¹¶æ–­ç”µå—ï¼Ÿ')) return;
            
            try {
                const res = await fetch(`/api/orders/${window.currentOrderId}/end`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('å·²æˆåŠŸç¦»åº§ï¼Œåº§ä½ç”µæºå·²æ–­å¼€');
                    document.getElementById('seatStatusCard').classList.remove('active');
                    window.currentOrderId = null;
                    loadSeats();
                    loadCurrentSeatStatus();
                } else {
                    alert(data.message || 'ç¦»åº§å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            } catch (err) {
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }

        // åŠ è½½ç”¨æˆ·ä¿¡æ¯
        async function loadUserInfo() {
            try {
                const res = await fetch('/api/user/info');
                const data = await res.json();
                if (data.success && data.user) {
                    const name = data.user.nickname || data.user.username || 'åŒå­¦';
                    document.getElementById('userName').textContent = name;
                    localStorage.setItem('userName', name);
                }
            } catch (err) {
                console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', err);
                // å›é€€ä½¿ç”¨æœ¬åœ°å­˜å‚¨
                const userName = localStorage.getItem('userName') || 'åŒå­¦';
                document.getElementById('userName').textContent = userName;
            }
        }

        // åŠ è½½ä»Šæ—¥ç»Ÿè®¡
        async function loadTodayStats() {
            try {
                const res = await fetch('/api/focus/today');
                const data = await res.json();
                if (data.success) {
                    document.getElementById('todayDuration').textContent = formatDuration(data.totalDuration || 0);
                    document.getElementById('todayCount').textContent = data.focusCount || 0;
                    document.getElementById('todayExp').textContent = data.expEarned || 0;
                }
            } catch (err) {
                console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', err);
            }
        }

        // åŠ è½½åº§ä½çŠ¶æ€
        async function loadSeats() {
            try {
                const res = await fetch('/api/seats');
                const data = await res.json();
                
                if (data.success && data.seats) {
                    const seats = data.seats;
                    seatsGrid.innerHTML = seats.map(seat => {
                        const statusClass = seat.status === 'occupied' ? 'occupied' : 'available';
                        const icon = seat.status === 'occupied' ? 'ğŸ‘¤' : 'ğŸ’º';
                        return `
                            <div class="seat-item ${statusClass}" onclick="window.location.href='/seat.html'">
                                <span class="seat-icon">${icon}</span>
                                <span>${seat.seatNumber}</span>
                            </div>
                        `;
                    }).join('');
                } else {
                    // ä½¿ç”¨é»˜è®¤æ•°æ®
                    loadDefaultSeats();
                }
            } catch (err) {
                console.error('åŠ è½½åº§ä½å¤±è´¥:', err);
                loadDefaultSeats();
            }
        }

        // é»˜è®¤åº§ä½æ•°æ®
        function loadDefaultSeats() {
            const seats = [
                { id: 'A01', status: 'available' },
                { id: 'A02', status: 'occupied' },
                { id: 'B01', status: 'available' },
                { id: 'B02', status: 'available' },
                { id: 'C01', status: 'occupied' },
                { id: 'C02', status: 'available' },
                { id: 'D01', status: 'available' },
                { id: 'D02', status: 'occupied' }
            ];

            seatsGrid.innerHTML = seats.map(seat => `
                <div class="seat-item ${seat.status}" onclick="window.location.href='/seat.html'">
                    <span class="seat-icon">${seat.status === 'occupied' ? 'ğŸ‘¤' : 'ğŸ’º'}</span>
                    <span>${seat.id}</span>
                </div>
            `).join('');
        }
    </script>
</body>
</html>
