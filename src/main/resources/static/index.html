<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äº‘ç«¯è‡ªä¹ å®¤</title>
    <link rel="stylesheet" href="/css/variables.css">
    <link rel="stylesheet" href="/css/components.css">
    <style>
        body {
            background: var(--color-bg);
        }

        .page-container {
            min-height: 100vh;
            padding: var(--space-4);
            padding-bottom: calc(var(--nav-height) + var(--space-6));
        }

        /* é—®å€™å¡ç‰‡ */
        .greeting-card {
            background: var(--gradient-primary);
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            color: #fff;
            margin-bottom: var(--space-5);
            box-shadow: var(--shadow-card);
        }

        .greeting-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            margin-bottom: var(--space-2);
        }

        .greeting-subtitle {
            font-size: var(--font-size-sm);
            opacity: 0.9;
        }

        .greeting-stats {
            display: flex;
            gap: var(--space-6);
            margin-top: var(--space-5);
        }

        .greeting-stat {
            text-align: center;
        }

        .greeting-stat-value {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
        }

        .greeting-stat-label {
            font-size: var(--font-size-xs);
            opacity: 0.8;
            margin-top: 2px;
        }

        /* äºŒç»´ç å¡ç‰‡ */
        .qrcode-card {
            background: #fff;
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            text-align: center;
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-5);
        }

        .qrcode-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-dark);
            margin-bottom: var(--space-4);
        }

        .qrcode-container {
            width: 200px;
            height: 200px;
            margin: 0 auto var(--space-4);
            background: var(--color-card-bg);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .qrcode-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            filter: blur(8px);
            transition: filter 0.3s;
        }

        .qrcode-container.unlocked img {
            filter: none;
        }

        .qrcode-placeholder {
            font-size: 48px;
            color: var(--color-text-tertiary);
        }

        .qrcode-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #fff;
            border-radius: var(--radius-lg);
        }

        .qrcode-overlay.hidden {
            display: none;
        }

        .qrcode-overlay-icon {
            font-size: 32px;
            margin-bottom: var(--space-2);
        }

        .qrcode-overlay-text {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
        }

        .qrcode-status {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            margin-bottom: var(--space-4);
        }

        .qrcode-status.locked {
            color: var(--color-warning);
        }

        .qrcode-countdown {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
            margin-bottom: var(--space-4);
        }

        /* åº§ä½çŠ¶æ€ */
        .section-title {
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-secondary);
            margin-bottom: var(--space-4);
            padding-left: var(--space-1);
        }

        .seats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-3);
        }

        .seat-item {
            aspect-ratio: 1;
            background: var(--color-card-bg);
            border-radius: var(--radius-md);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-secondary);
            transition: var(--transition-fast);
        }

        .seat-item.occupied {
            background: var(--color-primary-bg);
            color: var(--color-primary);
        }

        .seat-item.available {
            background: var(--color-success-bg);
            color: var(--color-success);
        }

        .seat-icon {
            font-size: 20px;
        }
    </style>
</head>
<body>
    <div class="page-container page-with-nav">
        <!-- é—®å€™å¡ç‰‡ -->
        <div class="greeting-card">
            <div class="greeting-title">æ¬¢è¿å›æ¥ï¼Œ<span id="userName">åŒå­¦</span></div>
            <div class="greeting-subtitle">ä»Šå¤©ä¹Ÿè¦åŠ æ²¹å“¦ï¼</div>
            <div class="greeting-stats">
                <div class="greeting-stat">
                    <div class="greeting-stat-value" id="todayDuration">--</div>
                    <div class="greeting-stat-label">ä»Šæ—¥å­¦ä¹ </div>
                </div>
                <div class="greeting-stat">
                    <div class="greeting-stat-value" id="todayCount">-</div>
                    <div class="greeting-stat-label">ä¸“æ³¨æ¬¡æ•°</div>
                </div>
                <div class="greeting-stat">
                    <div class="greeting-stat-value" id="todayExp">-</div>
                    <div class="greeting-stat-label">è·å¾—ç»éªŒ</div>
                </div>
            </div>
        </div>

        <!-- äºŒç»´ç å¡ç‰‡ -->
        <div class="qrcode-card">
            <div class="qrcode-title">æ‰«ç è¿›å…¥è‡ªä¹ å®¤</div>
            <div class="qrcode-container" id="qrcodeContainer" onclick="window.location.href='/qrcode_scan.html'">
                <img id="qrcodeImg" src="" alt="äºŒç»´ç " style="display: none;">
                <div class="qrcode-placeholder" id="qrcodePlaceholder">ğŸ“±</div>
                <div class="qrcode-overlay" id="qrcodeOverlay">
                    <div class="qrcode-overlay-icon">ğŸ”’</div>
                    <div class="qrcode-overlay-text">ç‚¹å‡»è¿›å…¥æ‰«ç </div>
                </div>
            </div>
            <div class="qrcode-countdown" id="countdown" style="display: none;">03:00</div>
            <div class="qrcode-status" id="qrcodeStatus">ç‚¹å‡»ä¸Šæ–¹åŒºåŸŸè¿›å…¥æ‰«ç é¡µé¢</div>
            <a href="/qrcode_scan.html" class="btn btn-primary btn-large" style="display: block; text-decoration: none; text-align: center;">æ‰«ç å¼€é—¨</a>
        </div>

        <!-- åº§ä½çŠ¶æ€ -->
        <div class="section-title">åº§ä½çŠ¶æ€</div>
        <div class="seats-grid" id="seatsGrid">
            <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <nav class="bottom-nav">
        <a href="/index.html" class="nav-item active">
            <span class="nav-icon">ğŸ </span>
            <span class="nav-label">è‡ªä¹ å®¤</span>
        </a>
        <a href="/study.html" class="nav-item">
            <span class="nav-icon">ğŸ“š</span>
            <span class="nav-label">å­¦ä¹ å°å±‹</span>
        </a>
        <a href="/member.html" class="nav-item">
            <span class="nav-icon">ğŸ‘‘</span>
            <span class="nav-label">ä¼šå‘˜</span>
        </a>
        <a href="/profile.html" class="nav-item">
            <span class="nav-icon">ğŸ‘¤</span>
            <span class="nav-label">æˆ‘çš„</span>
        </a>
    </nav>

    <script src="/js/nav.js"></script>
    <script>
        // DOM å…ƒç´ 
        const seatsGrid = document.getElementById('seatsGrid');

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadUserInfo();
            loadTodayStats();
            loadSeats();
        });

        // æ ¼å¼åŒ–æ—¶é•¿ï¼ˆç§’è½¬ä¸ºå¯è¯»æ ¼å¼ï¼‰
        function formatDuration(seconds) {
            if (!seconds || seconds <= 0) return '0åˆ†';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            if (hours > 0) {
                return minutes > 0 ? `${hours}h${minutes}m` : `${hours}h`;
            }
            return `${minutes}åˆ†`;
        }

        // åŠ è½½ç”¨æˆ·ä¿¡æ¯
        async function loadUserInfo() {
            try {
                const res = await fetch('/api/user/info');
                const data = await res.json();
                if (data.success && data.user) {
                    const name = data.user.nickname || data.user.username || 'åŒå­¦';
                    document.getElementById('userName').textContent = name;
                    localStorage.setItem('userName', name);
                }
            } catch (err) {
                console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', err);
                // å›é€€ä½¿ç”¨æœ¬åœ°å­˜å‚¨
                const userName = localStorage.getItem('userName') || 'åŒå­¦';
                document.getElementById('userName').textContent = userName;
            }
        }

        // åŠ è½½ä»Šæ—¥ç»Ÿè®¡
        async function loadTodayStats() {
            try {
                const res = await fetch('/api/focus/today');
                const data = await res.json();
                if (data.success) {
                    document.getElementById('todayDuration').textContent = formatDuration(data.totalDuration || 0);
                    document.getElementById('todayCount').textContent = data.focusCount || 0;
                    document.getElementById('todayExp').textContent = data.expEarned || 0;
                }
            } catch (err) {
                console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', err);
            }
        }

        // åŠ è½½åº§ä½çŠ¶æ€
        async function loadSeats() {
            try {
                const res = await fetch('/api/seats');
                const data = await res.json();
                
                if (data.success && data.seats) {
                    const seats = data.seats;
                    seatsGrid.innerHTML = seats.map(seat => {
                        const statusClass = seat.status === 'occupied' ? 'occupied' : 'available';
                        const icon = seat.status === 'occupied' ? 'ğŸ‘¤' : 'ğŸ’º';
                        return `
                            <div class="seat-item ${statusClass}" onclick="window.location.href='/seat.html'">
                                <span class="seat-icon">${icon}</span>
                                <span>${seat.seatNumber}</span>
                            </div>
                        `;
                    }).join('');
                } else {
                    // ä½¿ç”¨é»˜è®¤æ•°æ®
                    loadDefaultSeats();
                }
            } catch (err) {
                console.error('åŠ è½½åº§ä½å¤±è´¥:', err);
                loadDefaultSeats();
            }
        }

        // é»˜è®¤åº§ä½æ•°æ®
        function loadDefaultSeats() {
            const seats = [
                { id: 'A01', status: 'available' },
                { id: 'A02', status: 'occupied' },
                { id: 'B01', status: 'available' },
                { id: 'B02', status: 'available' },
                { id: 'C01', status: 'occupied' },
                { id: 'C02', status: 'available' },
                { id: 'D01', status: 'available' },
                { id: 'D02', status: 'occupied' }
            ];

            seatsGrid.innerHTML = seats.map(seat => `
                <div class="seat-item ${seat.status}" onclick="window.location.href='/seat.html'">
                    <span class="seat-icon">${seat.status === 'occupied' ? 'ğŸ‘¤' : 'ğŸ’º'}</span>
                    <span>${seat.id}</span>
                </div>
            `).join('');
        }
    </script>
</body>
</html>
