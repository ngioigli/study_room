<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç•™è¨€æ¿ - äº‘ç«¯è‡ªä¹ å®¤</title>
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/components.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: var(--font-family);
            background: var(--color-bg);
            min-height: 100vh;
            padding-bottom: 160px;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: white;
            display: flex;
            align-items: center;
            padding: 0 var(--space-4);
            box-shadow: var(--shadow-sm);
            z-index: 100;
        }

        .back-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--color-card-bg);
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .top-title {
            flex: 1;
            text-align: center;
            font-size: 17px;
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .top-action {
            width: 36px;
        }

        /* æç¤ºæ¨ªå¹… */
        .tips-banner {
            margin: 72px var(--space-4) var(--space-4);
            padding: var(--space-4);
            background: linear-gradient(135deg, #FEF3C7, #FDE68A);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .tips-icon {
            font-size: 28px;
        }

        .tips-text {
            flex: 1;
            font-size: 13px;
            color: #92400E;
            line-height: 1.5;
        }

        .tips-close {
            width: 24px;
            height: 24px;
            border: none;
            background: rgba(0,0,0,0.1);
            border-radius: 50%;
            font-size: 14px;
            cursor: pointer;
        }

        /* ç•™è¨€åˆ—è¡¨ */
        .message-list {
            padding: 0 var(--space-4);
        }

        .message-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin-bottom: var(--space-3);
            box-shadow: var(--shadow-sm);
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-3);
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            background: var(--color-card-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .message-info {
            flex: 1;
        }

        .message-author {
            font-size: 14px;
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .message-status {
            font-size: 11px;
            color: var(--color-primary);
            margin-left: var(--space-2);
        }

        .message-time {
            font-size: 12px;
            color: var(--color-text-tertiary);
        }

        .message-menu {
            position: relative;
        }

        .message-menu-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            font-size: 16px;
            cursor: pointer;
            border-radius: 50%;
        }

        .message-menu-btn:hover {
            background: var(--color-card-bg);
        }

        .message-content {
            font-size: 15px;
            color: var(--color-text-primary);
            line-height: 1.6;
            margin-bottom: var(--space-3);
            word-break: break-word;
        }

        .message-actions {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            padding-top: var(--space-3);
            border-top: 1px solid var(--color-border);
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            font-size: 13px;
            color: var(--color-text-secondary);
            background: none;
            border: none;
            cursor: pointer;
            padding: var(--space-2);
            border-radius: var(--radius-sm);
        }

        .action-btn:hover {
            background: var(--color-card-bg);
            color: var(--color-primary);
        }

        /* å›å¤åŒºåŸŸ */
        .replies-section {
            background: var(--color-card-bg);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            margin-top: var(--space-3);
        }

        .reply-item {
            display: flex;
            gap: var(--space-2);
            padding: var(--space-2) 0;
            border-bottom: 1px solid var(--color-border);
        }

        .reply-item:last-child {
            border-bottom: none;
        }

        .reply-avatar {
            width: 28px;
            height: 28px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .reply-content {
            flex: 1;
        }

        .reply-author {
            font-size: 12px;
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .reply-text {
            font-size: 13px;
            color: var(--color-text-secondary);
            margin-top: 2px;
            line-height: 1.5;
        }

        .reply-time {
            font-size: 11px;
            color: var(--color-text-tertiary);
            margin-top: 4px;
        }

        .reply-delete {
            font-size: 11px;
            color: var(--color-error);
            background: none;
            border: none;
            cursor: pointer;
            margin-left: var(--space-2);
        }

        /* å‘å¸ƒç•™è¨€åŒº */
        .compose-area {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: var(--space-4);
            box-shadow: var(--shadow-lg);
            z-index: 100;
        }

        .compose-input {
            display: flex;
            gap: var(--space-3);
            align-items: flex-end;
        }

        .compose-textarea {
            flex: 1;
            min-height: 44px;
            max-height: 120px;
            padding: var(--space-3);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            font-size: 15px;
            resize: none;
            font-family: inherit;
        }

        .compose-textarea:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .compose-btn {
            height: 44px;
            padding: 0 var(--space-5);
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: var(--radius-lg);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .compose-btn:hover {
            opacity: 0.9;
        }

        .compose-btn:disabled {
            background: var(--color-text-tertiary);
            cursor: not-allowed;
        }

        .compose-tools {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-top: var(--space-2);
            padding-top: var(--space-2);
            border-top: 1px solid var(--color-border);
        }

        .tool-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--color-card-bg);
            border-radius: var(--radius-md);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-fast);
        }

        .tool-btn:hover {
            background: var(--color-border);
        }

        .image-input {
            display: none;
        }

        .image-preview {
            display: flex;
            gap: var(--space-2);
            flex-wrap: wrap;
            margin-top: var(--space-2);
        }

        .preview-item {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .message-images {
            display: flex;
            gap: var(--space-2);
            flex-wrap: wrap;
            margin-top: var(--space-2);
        }

        .message-image {
            width: 100px;
            height: 100px;
            border-radius: var(--radius-md);
            object-fit: cover;
            cursor: pointer;
        }

        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 300;
        }

        .image-modal.show {
            display: flex;
        }

        .image-modal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: var(--radius-md);
        }

        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .char-count {
            font-size: 11px;
            color: var(--color-text-tertiary);
            text-align: right;
            margin-top: 4px;
        }

        /* å›å¤å¼¹çª— */
        .reply-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: flex-end;
            z-index: 200;
        }

        .reply-modal.show {
            display: flex;
        }

        .reply-panel {
            width: 100%;
            background: white;
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            padding: var(--space-4);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .reply-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-4);
        }

        .reply-panel-title {
            font-size: 16px;
            font-weight: 600;
        }

        .reply-panel-close {
            width: 28px;
            height: 28px;
            border: none;
            background: var(--color-card-bg);
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
        }

        .reply-input {
            width: 100%;
            min-height: 80px;
            padding: var(--space-3);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 15px;
            resize: none;
            margin-bottom: var(--space-3);
            font-family: inherit;
        }

        .reply-input:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .reply-submit {
            width: 100%;
            padding: var(--space-3);
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: var(--space-10) var(--space-4);
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: var(--space-4);
        }

        .empty-text {
            font-size: 14px;
            color: var(--color-text-secondary);
        }

        /* åŠ è½½æ›´å¤š */
        .load-more {
            text-align: center;
            padding: var(--space-4);
        }

        .load-more-btn {
            padding: var(--space-3) var(--space-6);
            background: var(--color-card-bg);
            border: none;
            border-radius: var(--radius-full);
            font-size: 14px;
            color: var(--color-text-secondary);
            cursor: pointer;
        }

        .load-more-btn:hover {
            background: var(--color-border);
        }

        /* ä¸‹æ‹‰èœå• */
        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            min-width: 100px;
            overflow: hidden;
            display: none;
            z-index: 50;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            padding: var(--space-3) var(--space-4);
            font-size: 14px;
            cursor: pointer;
            display: block;
            width: 100%;
            text-align: left;
            border: none;
            background: none;
        }

        .dropdown-item:hover {
            background: var(--color-card-bg);
        }

        .dropdown-item.danger {
            color: var(--color-error);
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: var(--space-3) var(--space-5);
            border-radius: var(--radius-full);
            font-size: 14px;
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="top-bar">
        <button class="back-btn" onclick="goBack()">â†</button>
        <span class="top-title">ç•™è¨€æ¿ ğŸ’¬</span>
        <div class="top-action"></div>
    </div>

    <!-- æç¤ºæ¨ªå¹… -->
    <div class="tips-banner" id="tipsBanner">
        <span class="tips-icon">ğŸ’¡</span>
        <div class="tips-text">
            <strong>æ¸©é¦¨æç¤º</strong><br>
            å‹å–„äº¤æµï¼Œäº’ç›¸é¼“åŠ±ã€‚ç•™è¨€å†…å®¹è¯·æ–‡æ˜å‹å–„ï¼Œç¦æ­¢å‘å¸ƒå¹¿å‘Šå’Œä¸è‰¯ä¿¡æ¯ã€‚
        </div>
        <button class="tips-close" onclick="closeTips()">Ã—</button>
    </div>

    <!-- ç•™è¨€åˆ—è¡¨ -->
    <div class="message-list" id="messageList">
        <!-- ç•™è¨€å¡ç‰‡ç”±JSæ¸²æŸ“ -->
    </div>

    <!-- åŠ è½½æ›´å¤š -->
    <div class="load-more" id="loadMore" style="display: none;">
        <button class="load-more-btn" onclick="loadMore()">åŠ è½½æ›´å¤š</button>
    </div>

    <!-- ç©ºçŠ¶æ€ -->
    <div class="empty-state" id="emptyState" style="display: none;">
        <div class="empty-icon">ğŸ“</div>
        <div class="empty-text">è¿˜æ²¡æœ‰ç•™è¨€ï¼Œå¿«æ¥å†™ä¸‹ç¬¬ä¸€æ¡å§ï¼</div>
    </div>

    <!-- å‘å¸ƒç•™è¨€åŒº -->
    <div class="compose-area">
        <div class="compose-input">
            <textarea class="compose-textarea" id="composeInput" placeholder="å†™ä¸‹ä½ æƒ³è¯´çš„è¯..." maxlength="500" oninput="updateCharCount()"></textarea>
            <button class="compose-btn" id="composeBtn" onclick="submitMessage()">å‘å¸ƒ</button>
        </div>
        <div class="compose-tools">
            <div class="char-count"><span id="charCount">0</span>/500</div>
        </div>
    </div>

    <!-- å›å¤å¼¹çª— -->
    <div class="reply-modal" id="replyModal">
        <div class="reply-panel">
            <div class="reply-panel-header">
                <span class="reply-panel-title">å›å¤ç•™è¨€</span>
                <button class="reply-panel-close" onclick="closeReplyModal()">Ã—</button>
            </div>
            <textarea class="reply-input" id="replyInput" placeholder="å†™ä¸‹ä½ çš„å›å¤..." maxlength="200"></textarea>
            <button class="reply-submit" onclick="submitReply()">å‘é€</button>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- å›¾ç‰‡é¢„è§ˆå¼¹çª— -->
    <div class="image-modal" id="imageModal" onclick="closeImageModal()">
        <button class="image-modal-close" onclick="closeImageModal()">Ã—</button>
        <img id="modalImage" src="" alt="é¢„è§ˆå›¾ç‰‡">
    </div>

    <script>
        let currentPage = 1;
        let totalPages = 1;
        let currentUserId = null;
        let replyingTo = null;
        let openDropdown = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            await getCurrentUser();
            loadMessages();
            
            // æ£€æŸ¥æ˜¯å¦å·²å…³é—­æç¤º
            if (localStorage.getItem('messageTipsClosed')) {
                document.getElementById('tipsBanner').style.display = 'none';
            }
        });

        // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰èœå•
        document.addEventListener('click', (e) => {
            if (openDropdown && !e.target.closest('.message-menu')) {
                openDropdown.classList.remove('show');
                openDropdown = null;
            }
        });

        async function getCurrentUser() {
            try {
                const res = await fetch('/api/user/info');
                const data = await res.json();
                if (data.success && data.user) {
                    currentUserId = data.user.id;
                }
            } catch (err) {
                console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', err);
            }
        }

        async function loadMessages(append = false) {
            try {
                const res = await fetch(`/api/message/list?page=${currentPage}&size=10`);
                const data = await res.json();
                
                if (data.success) {
                    totalPages = data.totalPages;
                    
                    if (data.messages.length === 0 && currentPage === 1) {
                        document.getElementById('emptyState').style.display = 'block';
                        document.getElementById('loadMore').style.display = 'none';
                    } else {
                        document.getElementById('emptyState').style.display = 'none';
                        renderMessages(data.messages, append);
                        document.getElementById('loadMore').style.display = currentPage < totalPages ? 'block' : 'none';
                    }
                }
            } catch (err) {
                showToast('åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        function renderMessages(messages, append = false) {
            const list = document.getElementById('messageList');
            
            const html = messages.map(msg => {
                // æ¸²æŸ“å›¾ç‰‡ - å¤„ç†åç«¯è¿”å›çš„é€—å·åˆ†éš”å­—ç¬¦ä¸²
                let imagesHtml = '';
                let imageList = [];
                if (msg.images) {
                    // images å¯èƒ½æ˜¯å­—ç¬¦ä¸²ï¼ˆé€—å·åˆ†éš”ï¼‰æˆ–æ•°ç»„
                    if (typeof msg.images === 'string') {
                        imageList = msg.images.split(',').filter(url => url.trim());
                    } else if (Array.isArray(msg.images)) {
                        imageList = msg.images;
                    }
                }
                
                if (imageList.length > 0) {
                    imagesHtml = `
                        <div class="message-images">
                            ${imageList.map(img => `
                                <img class="message-image" src="${img.trim()}" alt="ç•™è¨€å›¾ç‰‡" onclick="openImageModal('${img.trim()}')">
                            `).join('')}
                        </div>
                    `;
                }
                
                return `
                <div class="message-card" data-id="${msg.id}">
                    <div class="message-header">
                        <div class="message-avatar">${msg.avatar || 'ğŸ‘¤'}</div>
                        <div class="message-info">
                            <div>
                                <span class="message-author">${escapeHtml(msg.nickname || 'åŒ¿åç”¨æˆ·')}</span>
                                ${msg.todayStatus ? `<span class="message-status">${escapeHtml(msg.todayStatus)}</span>` : ''}
                            </div>
                            <div class="message-time">${formatTime(msg.createdAt)}</div>
                        </div>
                        ${msg.userId === currentUserId ? `
                        <div class="message-menu">
                            <button class="message-menu-btn" onclick="toggleDropdown(event, ${msg.id})">â‹®</button>
                            <div class="dropdown-menu" id="dropdown-${msg.id}">
                                <button class="dropdown-item" onclick="editMessage(${msg.id})">ç¼–è¾‘</button>
                                <button class="dropdown-item danger" onclick="deleteMessage(${msg.id})">åˆ é™¤</button>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    <div class="message-content">${escapeHtml(msg.content)}</div>
                    ${imagesHtml}
                    <div class="message-actions">
                        <button class="action-btn" onclick="openReplyModal(${msg.id})">
                            ğŸ’¬ å›å¤ ${msg.replyCount > 0 ? `(${msg.replyCount})` : ''}
                        </button>
                    </div>
                    <div class="replies-section" id="replies-${msg.id}" style="display: none;"></div>
                </div>
            `}).join('');
            
            if (append) {
                list.innerHTML += html;
            } else {
                list.innerHTML = html;
            }
        }

        function toggleDropdown(event, messageId) {
            event.stopPropagation();
            const dropdown = document.getElementById(`dropdown-${messageId}`);
            
            if (openDropdown && openDropdown !== dropdown) {
                openDropdown.classList.remove('show');
            }
            
            dropdown.classList.toggle('show');
            openDropdown = dropdown.classList.contains('show') ? dropdown : null;
        }

        async function loadReplies(messageId) {
            const repliesSection = document.getElementById(`replies-${messageId}`);
            
            if (repliesSection.style.display === 'block') {
                repliesSection.style.display = 'none';
                return;
            }
            
            try {
                const res = await fetch(`/api/message/${messageId}/replies`);
                const data = await res.json();
                
                if (data.success && data.replies.length > 0) {
                    repliesSection.innerHTML = data.replies.map(reply => `
                        <div class="reply-item">
                            <div class="reply-avatar">${reply.avatar || 'ğŸ‘¤'}</div>
                            <div class="reply-content">
                                <span class="reply-author">${escapeHtml(reply.nickname || 'åŒ¿åç”¨æˆ·')}</span>
                                <div class="reply-text">${escapeHtml(reply.content)}</div>
                                <div class="reply-time">
                                    ${formatTime(reply.createdAt)}
                                    ${reply.userId === currentUserId ? `<button class="reply-delete" onclick="deleteReply(${reply.id}, ${messageId})">åˆ é™¤</button>` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('');
                    repliesSection.style.display = 'block';
                } else {
                    repliesSection.innerHTML = '<div style="text-align:center;color:#999;font-size:13px;padding:8px;">æš‚æ— å›å¤</div>';
                    repliesSection.style.display = 'block';
                }
            } catch (err) {
                showToast('åŠ è½½å›å¤å¤±è´¥');
            }
        }

        function openReplyModal(messageId) {
            replyingTo = messageId;
            document.getElementById('replyInput').value = '';
            document.getElementById('replyModal').classList.add('show');
            
            // åŒæ—¶åŠ è½½å›å¤åˆ—è¡¨
            loadReplies(messageId);
        }

        function closeReplyModal() {
            document.getElementById('replyModal').classList.remove('show');
            replyingTo = null;
        }

        async function submitReply() {
            const content = document.getElementById('replyInput').value.trim();
            
            if (!content) {
                showToast('å›å¤å†…å®¹ä¸èƒ½ä¸ºç©º');
                return;
            }
            
            try {
                const res = await fetch(`/api/message/${replyingTo}/reply`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });
                const data = await res.json();
                
                if (data.success) {
                    showToast('å›å¤æˆåŠŸ');
                    closeReplyModal();
                    loadReplies(replyingTo);
                    // åˆ·æ–°ç•™è¨€åˆ—è¡¨æ›´æ–°å›å¤æ•°
                    currentPage = 1;
                    loadMessages();
                } else {
                    showToast(data.message || 'å›å¤å¤±è´¥');
                }
            } catch (err) {
                showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }

        async function submitMessage() {
            const input = document.getElementById('composeInput');
            const content = input.value.trim();
            
            if (!content) {
                showToast('ç•™è¨€å†…å®¹ä¸èƒ½ä¸ºç©º');
                return;
            }
            
            const btn = document.getElementById('composeBtn');
            btn.disabled = true;
            btn.textContent = 'å‘å¸ƒä¸­...';
            
            try {
                const res = await fetch('/api/message/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });
                const data = await res.json();
                
                if (data.success) {
                    showToast('ç•™è¨€å‘å¸ƒæˆåŠŸ');
                    input.value = '';
                    updateCharCount();
                    currentPage = 1;
                    loadMessages();
                } else {
                    showToast(data.message || 'å‘å¸ƒå¤±è´¥');
                }
            } catch (err) {
                showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            } finally {
                btn.disabled = false;
                btn.textContent = 'å‘å¸ƒ';
            }
        }

        async function deleteMessage(messageId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ç•™è¨€å—ï¼Ÿ')) return;
            
            try {
                const res = await fetch(`/api/message/${messageId}`, { method: 'DELETE' });
                const data = await res.json();
                
                if (data.success) {
                    showToast('åˆ é™¤æˆåŠŸ');
                    currentPage = 1;
                    loadMessages();
                } else {
                    showToast(data.message || 'åˆ é™¤å¤±è´¥');
                }
            } catch (err) {
                showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }

        async function deleteReply(replyId, messageId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å›å¤å—ï¼Ÿ')) return;
            
            try {
                const res = await fetch(`/api/message/reply/${replyId}`, { method: 'DELETE' });
                const data = await res.json();
                
                if (data.success) {
                    showToast('åˆ é™¤æˆåŠŸ');
                    loadReplies(messageId);
                    currentPage = 1;
                    loadMessages();
                } else {
                    showToast(data.message || 'åˆ é™¤å¤±è´¥');
                }
            } catch (err) {
                showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }

        function editMessage(messageId) {
            const card = document.querySelector(`.message-card[data-id="${messageId}"]`);
            const contentEl = card.querySelector('.message-content');
            const originalContent = contentEl.textContent;
            
            const textarea = document.createElement('textarea');
            textarea.className = 'compose-textarea';
            textarea.value = originalContent;
            textarea.style.marginBottom = '8px';
            
            const saveBtn = document.createElement('button');
            saveBtn.className = 'compose-btn';
            saveBtn.textContent = 'ä¿å­˜';
            saveBtn.style.marginRight = '8px';
            
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'compose-btn';
            cancelBtn.style.background = '#999';
            cancelBtn.textContent = 'å–æ¶ˆ';
            
            const wrapper = document.createElement('div');
            wrapper.appendChild(textarea);
            wrapper.appendChild(saveBtn);
            wrapper.appendChild(cancelBtn);
            
            contentEl.innerHTML = '';
            contentEl.appendChild(wrapper);
            
            saveBtn.onclick = async () => {
                const newContent = textarea.value.trim();
                if (!newContent) {
                    showToast('å†…å®¹ä¸èƒ½ä¸ºç©º');
                    return;
                }
                
                try {
                    const res = await fetch(`/api/message/${messageId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content: newContent })
                    });
                    const data = await res.json();
                    
                    if (data.success) {
                        showToast('ä¿®æ”¹æˆåŠŸ');
                        currentPage = 1;
                        loadMessages();
                    } else {
                        showToast(data.message || 'ä¿®æ”¹å¤±è´¥');
                    }
                } catch (err) {
                    showToast('ç½‘ç»œé”™è¯¯');
                }
            };
            
            cancelBtn.onclick = () => {
                contentEl.textContent = originalContent;
            };
            
            // å…³é—­ä¸‹æ‹‰èœå•
            if (openDropdown) {
                openDropdown.classList.remove('show');
                openDropdown = null;
            }
        }

        function loadMore() {
            currentPage++;
            loadMessages(true);
        }

        function updateCharCount() {
            const count = document.getElementById('composeInput').value.length;
            document.getElementById('charCount').textContent = count;
        }

        // å›¾ç‰‡å¤„ç†å‡½æ•°
        function handleImageSelect(event) {
            const files = Array.from(event.target.files);
            
            if (selectedImages.length + files.length > MAX_IMAGES) {
                showToast(`æœ€å¤šåªèƒ½ä¸Šä¼ ${MAX_IMAGES}å¼ å›¾ç‰‡`);
                return;
            }
            
            files.forEach(file => {
                if (!file.type.startsWith('image/')) {
                    showToast('åªèƒ½ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶');
                    return;
                }
                
                if (file.size > MAX_IMAGE_SIZE) {
                    showToast('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡2MB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedImages.push({
                        file: file,
                        dataUrl: e.target.result
                    });
                    renderImagePreview();
                };
                reader.readAsDataURL(file);
            });
            
            event.target.value = '';
        }

        function renderImagePreview() {
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = selectedImages.map((img, index) => `
                <div class="preview-item">
                    <img src="${img.dataUrl}" alt="é¢„è§ˆ">
                    <button class="preview-remove" onclick="removeImage(${index})">Ã—</button>
                </div>
            `).join('');
        }

        function removeImage(index) {
            selectedImages.splice(index, 1);
            renderImagePreview();
        }

        function openImageModal(src) {
            document.getElementById('modalImage').src = src;
            document.getElementById('imageModal').classList.add('show');
        }

        function closeImageModal() {
            document.getElementById('imageModal').classList.remove('show');
        }

        function closeTips() {
            document.getElementById('tipsBanner').style.display = 'none';
            localStorage.setItem('messageTipsClosed', 'true');
        }

        function goBack() {
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = '/profile.html';
            }
        }

        function formatTime(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'åˆšåˆš';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
            if (diff < 604800000) return Math.floor(diff / 86400000) + 'å¤©å‰';
            
            return date.toLocaleDateString();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }
    </script>
</body>
</html>
