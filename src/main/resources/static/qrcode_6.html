<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- ç§»åŠ¨ç«¯é€‚é…æ ¸å¿ƒé…ç½® -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äº‘ç«¯è‡ªä¹ å®¤ - æ‰«ç å…¥åº§</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- å¼•å…¥åœ†æ¶¦å­—ä½“(æ­£æ–‡) å’Œ æ‰‹å†™å­—ä½“(é»‘æ¿) -->
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&family=Zeyada&display=swap" rel="stylesheet">
    <style>
        :root { --refresh-interval: 3s; }

        /* --- 1. å…¨å±€åŸºç¡€æ ·å¼ --- */
        body, html {
            height: 100%; margin: 0; font-family: 'M PLUS Rounded 1c', sans-serif;
            background: #e0f7fa; overflow-x: hidden;
            user-select: none; -webkit-user-select: none; /* ç¦æ­¢é€‰ä¸­æ–‡æœ¬ï¼Œæ›´æœ‰Appæ„Ÿ */
        }

        /* åŠ¨æ€èƒŒæ™¯å®¹å™¨ */
        .background {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(120deg, #a1c4fd 0%, #c2e9fb 100%);
            z-index: -1;
        }

        /* äº‘æœµåŠ¨ç”» */
        .cloud {
            position: absolute; background: #fff; border-radius: 50%; opacity: 0.6;
            animation: float 35s infinite linear; pointer-events: none;
        }
        .cloud::after, .cloud::before { content: ''; position: absolute; background: inherit; border-radius: inherit; }
        .c1 { width: 100px; height: 40px; top: 10%; left: -10%; }
        .c1::after { width: 50px; height: 50px; top: -25px; left: 15px; }
        .c1::before { width: 40px; height: 40px; top: -15px; left: 45px; }
        .c2 { width: 120px; height: 50px; top: 80%; left: -20%; animation-duration: 45s; transform: scale(1.5); opacity: 0.4;}
        .c2::after { width: 60px; height: 60px; top: -30px; left: 20px; }
        .c2::before { width: 50px; height: 50px; top: -20px; left: 60px; }
        @keyframes float { from { left: -20%; } to { left: 120%; } }

        /* --- 2. é¡¶éƒ¨æ§åˆ¶æ  (ç™½å™ªéŸ³ + é€€å‡º) --- */
        .top-bar {
            position: absolute; top: 0; left: 0; width: 100%;
            padding: 20px; box-sizing: border-box;
            display: flex; justify-content: space-between; align-items: flex-start;
            z-index: 100; pointer-events: none; /* å¸ƒå±€å±‚ç©¿é€ï¼Œè®©ä¸‹é¢èƒ½ç‚¹ */
        }

        /* é€€å‡ºæŒ‰é’® */
        #logoutBtn {
            pointer-events: auto; padding: 8px 16px; background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.8); border-radius: 20px;
            color: #57606f; cursor: pointer; font-family: inherit; font-size: 13px; font-weight: bold;
            backdrop-filter: blur(4px); transition: all 0.3s;
        }
        #logoutBtn:hover { background: rgba(255, 255, 255, 0.9); transform: translateY(-2px); }

        /* ç™½å™ªéŸ³æ§åˆ¶å° */
        .noise-player {
            pointer-events: auto; background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            padding: 10px 15px; border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            display: flex; flex-direction: column; gap: 8px; width: 140px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: width 0.3s ease;
        }
        .player-header { font-size: 12px; color: #57606f; font-weight: bold; display: flex; align-items: center; gap: 5px; opacity: 0.8; }
        .player-controls { display: flex; justify-content: space-between; }
        .sound-btn {
            width: 30px; height: 30px; border-radius: 50%; border: none; cursor: pointer;
            background: rgba(255, 255, 255, 0.4); font-size: 16px;
            display: flex; justify-content: center; align-items: center; transition: all 0.2s; position: relative;
        }
        .sound-btn.active { background: #fff; box-shadow: 0 0 10px rgba(255, 255, 255, 0.8); transform: scale(1.1); }
        .sound-btn.active::after {
            content: ''; position: absolute; top: -2px; left: -2px; right: -2px; bottom: -2px;
            border-radius: 50%; border: 2px solid rgba(255,255,255,0.5); animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.4); opacity: 0; } }
        .volume-control { display: flex; align-items: center; gap: 5px; margin-top: 5px; }
        .volume-slider { width: 100%; height: 4px; border-radius: 2px; -webkit-appearance: none; background: rgba(255,255,255,0.5); }
        .volume-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; background: #fff; border-radius: 50%; cursor: pointer; }

        /* --- 3. ä¸»å†…å®¹åŒºåŸŸ --- */
        .main-container {
            display: flex; flex-direction: column; align-items: center; gap: 30px;
            padding-top: 100px; /* é¿å¼€é¡¶éƒ¨æ  */
            width: 100%; min-height: 100vh; box-sizing: border-box;
        }

        /* äºŒç»´ç å¡ç‰‡ */
        #qrcode-container {
            width: 100%; max-width: 360px; padding: 25px;
            background-color: rgba(255, 255, 255, 0.85);
            border-radius: 24px; text-align: center;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(137, 196, 244, 0.3);
            position: relative;
        }
        .header-text { font-size: 18px; font-weight: 700; color: #2c3e50; margin-bottom: 20px; }

        .qrcode-image-wrapper {
            position: relative; width: 100%; padding-bottom: 100%; height: 0;
            border-radius: 16px; overflow: hidden; border: 4px solid #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        #qrcode-image {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;
            transition: filter 0.5s ease;
        }

        /* æ¨¡ç³Šé®ç½© */
        .blur-mask { filter: blur(12px); }

        /* é”å®š/è§£é” è¦†ç›–å±‚ */
        .lock-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.3);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 10; backdrop-filter: blur(2px); border-radius: 16px;
        }

        /* æŠ¢å æŒ‰é’® */
        .unlock-btn {
            background: linear-gradient(135deg, #66a6ff 0%, #89f7fe 100%);
            border: none; padding: 12px 28px; border-radius: 25px;
            color: white; font-weight: bold; font-size: 16px; cursor: pointer;
            box-shadow: 0 5px 15px rgba(102, 166, 255, 0.4);
            transition: transform 0.2s; animation: pulse-btn 2s infinite;
        }
        .unlock-btn:active { transform: scale(0.95); }
        .unlock-btn:disabled { background: #bdc3c7; box-shadow: none; cursor: not-allowed; animation: none; }
        @keyframes pulse-btn { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* å€’è®¡æ—¶æ ·å¼ */
        .countdown-text { font-size: 36px; font-weight: bold; color: #e74c3c; margin-bottom: 5px; font-family: monospace; }
        .status-tip { font-size: 14px; color: #57606f; margin-top: 5px; max-width: 80%; line-height: 1.5; }

        /* æ¸©é¦¨æç¤ºé»‘æ¿ */
        .blackboard {
            width: 100%; max-width: 360px; background: #404b69;
            border: 8px solid #a67c52; border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15); padding: 20px; color: #f1f2f6;
        }
        .blackboard h4 { font-size: 20px; margin-top: 0; text-align: center; border-bottom: 1px dashed rgba(255,255,255,0.3); padding-bottom: 12px; margin-bottom: 15px; font-weight: normal; letter-spacing: 2px; }
        .blackboard p { font-size: 14px; line-height: 1.8; white-space: pre-line; margin: 0; opacity: 0.9; }

        /* --- 4. PCç«¯é€‚é… --- */
        @media (min-width: 768px) {
            .main-container { flex-direction: row; justify-content: center; align-items: flex-start; gap: 60px; padding-top: 0; height: 100vh; }
            #qrcode-container { transform: rotate(-2deg); margin-top: 100px; }
            #qrcode-container:hover { transform: rotate(0) scale(1.02); }
            .blackboard { width: 340px; transform: rotate(2deg); margin-top: 120px; }
            .noise-player { width: 180px; padding: 15px 20px; }
            .sound-btn { width: 36px; height: 36px; font-size: 18px; }
        }
    </style>
</head>
<body>

<!-- åŠ¨æ€èƒŒæ™¯ -->
<div class="background"><div class="cloud c1"></div><div class="cloud c2"></div></div>

<!-- é¡¶éƒ¨æ  -->
<div class="top-bar">
    <div class="noise-player">
        <div class="player-header"><span>â˜ï¸ æ²‰æµ¸ç™½å™ªéŸ³</span></div>
        <div class="player-controls">
            <button class="sound-btn" data-sound="rain" title="é›¨è½å±‹æª">ğŸŒ§ï¸</button>
            <button class="sound-btn" data-sound="fire" title="å›´ç‚‰å¤œè¯">ğŸ”¥</button>
            <button class="sound-btn" data-sound="forest" title="æ¸…æ™¨æ£®æ—">ğŸŒ²</button>
            <button class="sound-btn" data-sound="ocean" title="è¿œæ–¹æµ·æµª">ğŸŒŠ</button>
        </div>
        <div class="volume-control"><input type="range" class="volume-slider" min="0" max="1" step="0.05" value="0.3"></div>
    </div>
    <button id="logoutBtn">ç¦»åº§ä¼‘æ¯</button>
</div>

<!-- ä¸»å†…å®¹ -->
<div class="main-container">
    <div id="qrcode-container">
        <h3 class="header-text">âœ¨ æ‰«ç è¿›å…¥å­¦ä¹ å°å±‹ âœ¨</h3>

        <div class="qrcode-image-wrapper">
            <img id="qrcode-image" src="/images/dynamic_qrcode.jpg" alt="äºŒç»´ç åŠ è½½ä¸­...">

            <!-- é®ç½©å±‚ (åŒ…å«è§£é”æŒ‰é’® å’Œ å€’è®¡æ—¶) -->
            <div id="lockOverlay" class="lock-overlay">
                <!-- çŠ¶æ€A: è§£é”æŒ‰é’® -->
                <button id="unlockBtn" class="unlock-btn">ç‚¹å‡»æ‰«ç å…¥åº§</button>
                <!-- çŠ¶æ€B: å€’è®¡æ—¶ -->
                <div id="countdownBox" style="display: none; text-align: center;">
                    <div class="status-tip">æ­£åœ¨è¢«å…¶ä»–åŒå­¦ä½¿ç”¨<br>è¯·ç¨å€™...</div>
                    <div id="timer" class="countdown-text">03:00</div>
                </div>
            </div>
        </div>
        <p id="footerTip" style="font-size: 12px; color: #999; margin-top: 15px;">
            ä¸ºé˜²æ‹¥å µï¼Œæ¯äººæ‰«ç åé€šé“é”å®š3åˆ†é’Ÿ
        </p>
    </div>

    <div class="blackboard">
        <h4>æ¸©é¦¨æç¤º</h4>
        <p>æ—¶å…‰ä¸è´Ÿèµ¶è·¯äººï¼Œäº¦ä¸è´Ÿä½ 
            å­¦é•¿å­¦å§ï¼Œæ„¿ä½ ä»¬å¾—å¿æ‰€æ„¿ï½
            ğŸŒ¸ğŸŒ¸ğŸŒ¸

            âš ï¸ æ³¨æ„äº‹é¡¹ï¼š
            ç‚¹å‡»â€œæ‰«ç å…¥åº§â€åï¼Œé€šé“å°†é”å®š3åˆ†é’Ÿ
            è¯·åŠ¡å¿…å°½å¿«æ‰«æï¼Œé¿å…æµªè´¹èµ„æºå“¦~

            äºŒç»´ç å¦‚æ˜¾ç¤ºå¤±æ•ˆ,è¯·è€å¿ƒç­‰å¾…3sè‡ªåŠ¨åˆ·æ–°</p>
    </div>
</div>

<script>
    // --- å…¨å±€å˜é‡ ---
    const qrImage = document.getElementById('qrcode-image');
    const lockOverlay = document.getElementById('lockOverlay');
    const unlockBtn = document.getElementById('unlockBtn');
    const countdownBox = document.getElementById('countdownBox');
    const timerText = document.getElementById('timer');
    const footerTip = document.getElementById('footerTip');

    // å®šæ—¶å™¨å˜é‡
    let pollTimer = null;      // è½®è¯¢å®šæ—¶å™¨
    let countdownTimer = null; // æœ¬åœ°å€’è®¡æ—¶å®šæ—¶å™¨
    let isCountingDown = false; // æ ‡è®°ä½

    // --- 1. æ ¸å¿ƒçŠ¶æ€åŒæ­¥é€»è¾‘ (Smart Polling) ---

    // é¡µé¢åŠ è½½ç«‹å³æ£€æŸ¥ä¸€æ¬¡
    checkServerStatus();

    function checkServerStatus() {
        // å¦‚æœæœ¬åœ°æ­£åœ¨å€’è®¡æ—¶ï¼Œå°±ä¸è¯·æ±‚æœåŠ¡å™¨äº†ï¼ˆçœæµé‡ï¼‰
        if (isCountingDown) return;

        fetch('/api/qr-status/check')
            .then(res => res.json())
            .then(data => {
                if (data.status === 'LOCKED') {
                    // å‘ç°é”å®šï¼Œå¼€å¯æœ¬åœ°å€’è®¡æ—¶
                    handleLocked(data.endTime);
                } else {
                    // å‘ç°ç©ºé—²ï¼Œå¼€å¯ä½é¢‘è½®è¯¢
                    handleFree();
                }
            })
            .catch(err => console.error("çŠ¶æ€åŒæ­¥å¤±è´¥:", err));
    }

    // å¤„ç†ç©ºé—²çŠ¶æ€
    function handleFree() {
        // UIæ›´æ–°
        qrImage.classList.add('blur-mask');
        lockOverlay.style.display = 'flex';
        unlockBtn.style.display = 'block';
        countdownBox.style.display = 'none';
        footerTip.innerText = "é€šé“ç©ºé—²ä¸­ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æ‰«ç ";

        // é€»è¾‘å¤„ç†
        if (countdownTimer) clearInterval(countdownTimer);
        isCountingDown = false;

        // å¯åŠ¨ä½é¢‘è½®è¯¢ (3ç§’æŸ¥ä¸€æ¬¡)
        if (pollTimer) clearInterval(pollTimer);
        pollTimer = setInterval(checkServerStatus, 3000);
    }

    // å¤„ç†é”å®šçŠ¶æ€
    function handleLocked(endTimeStamp) {
        // åœæ­¢è½®è¯¢ï¼Œæ”¹ç”¨æœ¬åœ°è®¡ç®—
        if (pollTimer) clearInterval(pollTimer);
        isCountingDown = true;

        // UIæ›´æ–°
        qrImage.classList.remove('blur-mask'); // å›¾ç‰‡å˜æ¸…æ™°(æˆ–ä¿æŒæ¨¡ç³Šï¼Œçœ‹éœ€æ±‚ï¼Œè¿™é‡Œè®¾ä¸ºæ¸…æ™°æ–¹ä¾¿æŸ¥çœ‹)
        lockOverlay.style.display = 'flex';
        unlockBtn.style.display = 'none';
        countdownBox.style.display = 'block';
        footerTip.innerText = "é€šé“å†·å´ä¸­...";

        // å¯åŠ¨æœ¬åœ°å€’è®¡æ—¶
        startLocalTimer(endTimeStamp);
    }

    // æœ¬åœ°çº¯JSå€’è®¡æ—¶
    function startLocalTimer(endTime) {
        if (countdownTimer) clearInterval(countdownTimer);

        // ç«‹å³æ‰§è¡Œä¸€æ¬¡
        updateTimerUI();

        countdownTimer = setInterval(updateTimerUI, 1000);

        function updateTimerUI() {
            const now = new Date().getTime();
            const distance = endTime - now;

            if (distance < 0) {
                // å€’è®¡æ—¶ç»“æŸ
                clearInterval(countdownTimer);
                isCountingDown = false;
                timerText.innerText = "00:00";
                // å†æ¬¡è¯·æ±‚æœåŠ¡å™¨ç¡®è®¤æ˜¯å¦é‡Šæ”¾
                checkServerStatus();
                return;
            }

            // æ ¼å¼åŒ– mm:ss
            const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60)).toString().padStart(2, '0');
            const s = Math.floor((distance % (1000 * 60)) / 1000).toString().padStart(2, '0');
            timerText.innerText = `${m}:${s}`;
        }
    }

    // --- 2. äº¤äº’é€»è¾‘ ---

    // ç‚¹å‡»â€œæ‰«ç å…¥åº§â€
    unlockBtn.addEventListener('click', function() {
        this.disabled = true;
        this.innerText = "æ­£åœ¨é”å®š...";

        fetch('/api/qr-status/lock', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // é”å®šæˆåŠŸï¼Œæ‹¿åˆ°ç»“æŸæ—¶é—´ï¼Œç›´æ¥å¼€å§‹æœ¬åœ°å€’è®¡æ—¶
                    handleLocked(data.endTime);
                } else {
                    // é”å®šå¤±è´¥ï¼ˆè¢«æŠ¢ï¼‰ï¼Œåˆ·æ–°çŠ¶æ€
                    alert(data.message);
                    checkServerStatus();
                }
            })
            .finally(() => {
                this.disabled = false;
                this.innerText = "ç‚¹å‡»æ‰«ç å…¥åº§";
            });
    });

    // å›¾ç‰‡æŒç»­åˆ·æ–° (ä¸å—é”å®šå½±å“ï¼Œä¿è¯å›¾ç‰‡æ˜¯æœ€æ–°çš„)
    function refreshQRCode() {
        const imageUrl = '/images/dynamic_qrcode.jpg?t=' + new Date().getTime();
        qrImage.src = imageUrl;
    }
    setInterval(refreshQRCode, 3000);

    // --- 3. é€€å‡º & ç™½å™ªéŸ³é€»è¾‘ ---

    document.getElementById('logoutBtn').addEventListener('click', function() {
        if(confirm('å­¦ç´¯äº†å—ï¼Ÿç¡®å®šè¦ç¦»åº§ä¼‘æ¯ä¸€ä¸‹å—ï¼Ÿ\nä½ç½®ä¼šä¸€ç›´ä¸ºä½ ç•™ç€å“’~')) {
            fetch('/api/logout').then(() => { window.location.href = '/login.html'; });
        }
    });

    const sounds = {
        rain: new Audio('/audio/rain.mp3'),
        fire: new Audio('/audio/fire.mp3'),
        forest: new Audio('/audio/forest.mp3'),
        ocean: new Audio('/audio/ocean.mp3')
    };
    Object.values(sounds).forEach(audio => { audio.loop = true; audio.volume = 0.3; });
    const volumeSlider = document.querySelector('.volume-slider');

    document.querySelectorAll('.sound-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const audio = sounds[this.dataset.sound];
            if (audio.paused) {
                audio.play().catch(e=>{console.log("éœ€äº¤äº’")}); this.classList.add('active'); fadeIn(audio, volumeSlider.value);
            } else {
                audio.pause(); this.classList.remove('active');
            }
        });
    });
    volumeSlider.addEventListener('input', function() {
        const vol = this.value; Object.values(sounds).forEach(audio => { audio.volume = vol; });
    });
    function fadeIn(audio, target) {
        audio.volume = 0; let vol = 0;
        const t = setInterval(() => { if(vol<target){vol+=0.02;if(vol>target)vol=target;audio.volume=vol;}else{clearInterval(t)}}, 50);
    }
</script>
</body>
</html>