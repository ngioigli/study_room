<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ’è¡Œæ¦œ - äº‘ç«¯è‡ªä¹ å®¤</title>
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/components.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: var(--font-family);
            background: var(--color-bg);
            min-height: 100vh;
            padding-bottom: 100px;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: white;
            display: flex;
            align-items: center;
            padding: 0 var(--space-4);
            box-shadow: var(--shadow-sm);
            z-index: 100;
        }

        .back-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--color-card-bg);
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .top-title {
            flex: 1;
            text-align: center;
            font-size: 17px;
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .top-action {
            width: 36px;
        }

        /* Tab åˆ‡æ¢ */
        .tab-container {
            position: fixed;
            top: 56px;
            left: 0;
            right: 0;
            background: white;
            padding: var(--space-3) var(--space-4);
            box-shadow: var(--shadow-sm);
            z-index: 99;
        }

        .tab-list {
            display: flex;
            gap: var(--space-2);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .tab-list::-webkit-scrollbar {
            display: none;
        }

        .tab-item {
            flex-shrink: 0;
            padding: var(--space-2) var(--space-4);
            background: var(--color-card-bg);
            border: none;
            border-radius: var(--radius-full);
            font-size: 14px;
            color: var(--color-text-secondary);
            cursor: pointer;
            transition: var(--transition-fast);
            white-space: nowrap;
        }

        .tab-item.active {
            background: var(--color-primary);
            color: white;
        }

        /* æˆ‘çš„æ’åå¡ç‰‡ */
        .my-rank-card {
            margin: 130px var(--space-4) var(--space-4);
            background: linear-gradient(135deg, #8B5CF6, #A78BFA);
            border-radius: var(--radius-xl);
            padding: var(--space-5);
            color: white;
        }

        .my-rank-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
        }

        .my-rank-avatar {
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .my-rank-info {
            flex: 1;
        }

        .my-rank-name {
            font-size: 16px;
            font-weight: 600;
        }

        .my-rank-status {
            font-size: 12px;
            opacity: 0.8;
        }

        .my-rank-number {
            font-size: 32px;
            font-weight: 700;
        }

        .my-rank-label {
            font-size: 12px;
            opacity: 0.8;
        }

        .my-rank-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: var(--space-2);
        }

        .my-rank-item {
            text-align: center;
            padding: var(--space-2);
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
        }

        .my-rank-item-value {
            font-size: 18px;
            font-weight: 700;
        }

        .my-rank-item-label {
            font-size: 10px;
            opacity: 0.8;
        }

        /* æ’è¡Œæ¦œåˆ—è¡¨ */
        .ranking-list {
            padding: 0 var(--space-4);
        }

        /* å‰ä¸‰åç‰¹æ®Šæ ·å¼ */
        .top-three {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: var(--space-3);
            padding: var(--space-4) 0;
            margin-bottom: var(--space-4);
        }

        .top-item {
            text-align: center;
            flex: 1;
            max-width: 100px;
        }

        .top-item.first {
            order: 2;
        }

        .top-item.second {
            order: 1;
        }

        .top-item.third {
            order: 3;
        }

        .top-avatar {
            width: 56px;
            height: 56px;
            background: var(--color-card-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin: 0 auto var(--space-2);
            position: relative;
        }

        .top-item.first .top-avatar {
            width: 72px;
            height: 72px;
            font-size: 36px;
            border: 3px solid #FFD700;
        }

        .top-item.second .top-avatar {
            border: 3px solid #C0C0C0;
        }

        .top-item.third .top-avatar {
            border: 3px solid #CD7F32;
        }

        .top-medal {
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 20px;
        }

        .top-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .top-time {
            font-size: 12px;
            color: var(--color-primary);
            font-weight: 500;
        }

        /* æ™®é€šæ’è¡Œé¡¹ */
        .rank-card {
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .rank-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-4);
            border-bottom: 1px solid var(--color-border);
        }

        .rank-item:last-child {
            border-bottom: none;
        }

        .rank-number {
            width: 28px;
            height: 28px;
            background: var(--color-card-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
            color: var(--color-text-secondary);
        }

        .rank-item:nth-child(1) .rank-number,
        .rank-item:nth-child(2) .rank-number,
        .rank-item:nth-child(3) .rank-number {
            display: none;
        }

        .rank-avatar {
            width: 40px;
            height: 40px;
            background: var(--color-card-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .rank-info {
            flex: 1;
        }

        .rank-name {
            font-size: 15px;
            font-weight: 500;
            color: var(--color-text-primary);
        }

        .rank-status {
            font-size: 12px;
            color: var(--color-text-tertiary);
        }

        .rank-time {
            font-size: 14px;
            font-weight: 600;
            color: var(--color-primary);
        }

        .rank-unit {
            font-size: 12px;
            color: var(--color-text-tertiary);
            margin-left: 2px;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: var(--space-10) var(--space-4);
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: var(--space-4);
        }

        .empty-text {
            font-size: 14px;
            color: var(--color-text-secondary);
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading {
            text-align: center;
            padding: var(--space-6);
            color: var(--color-text-secondary);
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="top-bar">
        <button class="back-btn" onclick="goBack()">â†</button>
        <span class="top-title">æ’è¡Œæ¦œ ğŸ†</span>
        <div class="top-action"></div>
    </div>

    <!-- Tab åˆ‡æ¢ -->
    <div class="tab-container">
        <div class="tab-list">
            <button class="tab-item active" data-type="today" onclick="switchTab('today')">ä»Šæ—¥</button>
            <button class="tab-item" data-type="weekly" onclick="switchTab('weekly')">æœ¬å‘¨</button>
            <button class="tab-item" data-type="monthly" onclick="switchTab('monthly')">æœ¬æœˆ</button>
            <button class="tab-item" data-type="yearly" onclick="switchTab('yearly')">æœ¬å¹´</button>
            <button class="tab-item" data-type="total" onclick="switchTab('total')">æ€»æ¦œ</button>
        </div>
    </div>

    <!-- æˆ‘çš„æ’åå¡ç‰‡ -->
    <div class="my-rank-card">
        <div class="my-rank-header">
            <div class="my-rank-avatar" id="myAvatar">ğŸ‘¤</div>
            <div class="my-rank-info">
                <div class="my-rank-name" id="myName">åŠ è½½ä¸­...</div>
                <div class="my-rank-status" id="myStatus">--</div>
            </div>
            <div>
                <div class="my-rank-number" id="myCurrentRank">--</div>
                <div class="my-rank-label">å½“å‰æ’å</div>
            </div>
        </div>
        <div class="my-rank-grid">
            <div class="my-rank-item">
                <div class="my-rank-item-value" id="myTodayRank">--</div>
                <div class="my-rank-item-label">ä»Šæ—¥</div>
            </div>
            <div class="my-rank-item">
                <div class="my-rank-item-value" id="myWeekRank">--</div>
                <div class="my-rank-item-label">æœ¬å‘¨</div>
            </div>
            <div class="my-rank-item">
                <div class="my-rank-item-value" id="myMonthRank">--</div>
                <div class="my-rank-item-label">æœ¬æœˆ</div>
            </div>
            <div class="my-rank-item">
                <div class="my-rank-item-value" id="myYearRank">--</div>
                <div class="my-rank-item-label">æœ¬å¹´</div>
            </div>
            <div class="my-rank-item">
                <div class="my-rank-item-value" id="myTotalRank">--</div>
                <div class="my-rank-item-label">æ€»æ¦œ</div>
            </div>
        </div>
    </div>

    <!-- æ’è¡Œæ¦œåˆ—è¡¨ -->
    <div class="ranking-list" id="rankingList">
        <div class="loading">åŠ è½½ä¸­...</div>
    </div>

    <script>
        let currentType = 'today';
        let myRankings = {};

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadMyRanking();
            loadRanking('today');
        });

        async function loadMyRanking() {
            try {
                const [userRes, rankRes] = await Promise.all([
                    fetch('/api/user/profile'),
                    fetch('/api/ranking/me')
                ]);
                
                const userData = await userRes.json();
                const rankData = await rankRes.json();
                
                if (userData.success && userData.profile) {
                    document.getElementById('myAvatar').textContent = userData.profile.avatar || 'ğŸ‘¤';
                    document.getElementById('myName').textContent = userData.profile.nickname || 'å­¦ä¹ è€…';
                    document.getElementById('myStatus').textContent = userData.profile.todayStatus || 'åŠªåŠ›å­¦ä¹ ä¸­';
                }
                
                if (rankData.success && rankData.rankings) {
                    myRankings = rankData.rankings;
                    updateMyRankDisplay();
                }
            } catch (err) {
                console.error('åŠ è½½æˆ‘çš„æ’åå¤±è´¥:', err);
            }
        }

        function updateMyRankDisplay() {
            document.getElementById('myTodayRank').textContent = myRankings.today || '--';
            document.getElementById('myWeekRank').textContent = myRankings.week || '--';
            document.getElementById('myMonthRank').textContent = myRankings.month || '--';
            document.getElementById('myYearRank').textContent = myRankings.year || '--';
            document.getElementById('myTotalRank').textContent = myRankings.total || '--';
            
            // æ›´æ–°å½“å‰ç±»å‹çš„æ’å
            const rankMap = {
                'today': myRankings.today,
                'weekly': myRankings.week,
                'monthly': myRankings.month,
                'yearly': myRankings.year,
                'total': myRankings.total
            };
            document.getElementById('myCurrentRank').textContent = rankMap[currentType] || '--';
        }

        function switchTab(type) {
            currentType = type;
            
            // æ›´æ–°Tabæ ·å¼
            document.querySelectorAll('.tab-item').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.type === type);
            });
            
            // æ›´æ–°å½“å‰æ’åæ˜¾ç¤º
            updateMyRankDisplay();
            
            // åŠ è½½å¯¹åº”æ’è¡Œæ¦œ
            loadRanking(type);
        }

        async function loadRanking(type) {
            const listEl = document.getElementById('rankingList');
            listEl.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            
            try {
                const res = await fetch(`/api/ranking/${type}?limit=20`);
                const data = await res.json();
                
                if (data.success && data.ranking.length > 0) {
                    renderRanking(data.ranking);
                } else {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ“Š</div>
                            <div class="empty-text">æš‚æ— æ’è¡Œæ•°æ®</div>
                        </div>
                    `;
                }
            } catch (err) {
                listEl.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ˜¢</div>
                        <div class="empty-text">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>
                    </div>
                `;
            }
        }

        function renderRanking(ranking) {
            const listEl = document.getElementById('rankingList');
            
            // å‰ä¸‰å
            let topThreeHtml = '';
            if (ranking.length >= 1) {
                topThreeHtml = '<div class="top-three">';
                
                // ç¬¬äºŒå
                if (ranking.length >= 2) {
                    topThreeHtml += `
                        <div class="top-item second">
                            <div class="top-avatar">
                                ${ranking[1].avatar || 'ğŸ‘¤'}
                                <span class="top-medal">ğŸ¥ˆ</span>
                            </div>
                            <div class="top-name">${escapeHtml(ranking[1].nickname || 'åŒ¿å')}</div>
                            <div class="top-time">${formatTime(ranking[1].totalMinutes)}</div>
                        </div>
                    `;
                }
                
                // ç¬¬ä¸€å
                topThreeHtml += `
                    <div class="top-item first">
                        <div class="top-avatar">
                            ${ranking[0].avatar || 'ğŸ‘¤'}
                            <span class="top-medal">ğŸ¥‡</span>
                        </div>
                        <div class="top-name">${escapeHtml(ranking[0].nickname || 'åŒ¿å')}</div>
                        <div class="top-time">${formatTime(ranking[0].totalMinutes)}</div>
                    </div>
                `;
                
                // ç¬¬ä¸‰å
                if (ranking.length >= 3) {
                    topThreeHtml += `
                        <div class="top-item third">
                            <div class="top-avatar">
                                ${ranking[2].avatar || 'ğŸ‘¤'}
                                <span class="top-medal">ğŸ¥‰</span>
                            </div>
                            <div class="top-name">${escapeHtml(ranking[2].nickname || 'åŒ¿å')}</div>
                            <div class="top-time">${formatTime(ranking[2].totalMinutes)}</div>
                        </div>
                    `;
                }
                
                topThreeHtml += '</div>';
            }
            
            // ç¬¬4ååŠä»¥å
            let restHtml = '';
            if (ranking.length > 3) {
                restHtml = '<div class="rank-card">';
                for (let i = 3; i < ranking.length; i++) {
                    const item = ranking[i];
                    restHtml += `
                        <div class="rank-item">
                            <div class="rank-number">${i + 1}</div>
                            <div class="rank-avatar">${item.avatar || 'ğŸ‘¤'}</div>
                            <div class="rank-info">
                                <div class="rank-name">${escapeHtml(item.nickname || 'åŒ¿å')}</div>
                                <div class="rank-status">${escapeHtml(item.todayStatus || '')}</div>
                            </div>
                            <div class="rank-time">
                                ${formatTime(item.totalMinutes)}
                            </div>
                        </div>
                    `;
                }
                restHtml += '</div>';
            }
            
            listEl.innerHTML = topThreeHtml + restHtml;
        }

        function formatTime(minutes) {
            if (!minutes || minutes === 0) return '0åˆ†';
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            if (hours > 0) {
                return mins > 0 ? `${hours}h${mins}m` : `${hours}h`;
            }
            return `${mins}åˆ†`;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function goBack() {
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = '/profile.html';
            }
        }
    </script>
</body>
</html>
