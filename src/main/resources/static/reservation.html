<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åº§ä½é¢„çº¦ - äº‘ç«¯è‡ªä¹ å®¤</title>
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/components.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: var(--font-family);
            background: var(--color-bg);
            min-height: 100vh;
            padding-bottom: 100px;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: white;
            display: flex;
            align-items: center;
            padding: 0 var(--space-4);
            box-shadow: var(--shadow-sm);
            z-index: 100;
        }

        .back-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--color-card-bg);
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .top-title {
            flex: 1;
            text-align: center;
            font-size: 17px;
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .top-action {
            width: 36px;
        }

        /* Tab åˆ‡æ¢ */
        .tab-container {
            position: fixed;
            top: 56px;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            box-shadow: var(--shadow-sm);
            z-index: 99;
        }

        .tab-item {
            flex: 1;
            padding: var(--space-4);
            text-align: center;
            font-size: 14px;
            color: var(--color-text-secondary);
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: var(--transition-fast);
        }

        .tab-item.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        /* å†…å®¹åŒºåŸŸ */
        .content {
            margin-top: 112px;
            padding: var(--space-4);
        }

        /* é¢„çº¦é™åˆ¶æç¤º */
        .reservation-limit-card {
            background: linear-gradient(135deg, #FEF3C7, #FDE68A);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .limit-icon {
            font-size: 28px;
        }

        .limit-text {
            flex: 1;
            font-size: 13px;
            color: #92400E;
            line-height: 1.5;
        }

        .limit-text strong {
            display: block;
            font-size: 14px;
            margin-bottom: 4px;
        }

        /* å·²æœ‰é¢„çº¦æç¤º */
        .existing-reservation-card {
            background: linear-gradient(135deg, #DBEAFE, #BFDBFE);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
            display: none;
        }

        .existing-reservation-card.show {
            display: block;
        }

        .existing-header {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-bottom: var(--space-3);
        }

        .existing-header span {
            font-size: 14px;
            font-weight: 600;
            color: #1E40AF;
        }

        .existing-info {
            font-size: 13px;
            color: #1E40AF;
            line-height: 1.6;
        }

        .existing-actions {
            display: flex;
            gap: var(--space-2);
            margin-top: var(--space-3);
        }

        .existing-btn {
            flex: 1;
            padding: var(--space-2) var(--space-3);
            border: none;
            border-radius: var(--radius-md);
            font-size: 13px;
            cursor: pointer;
        }

        .existing-btn.cancel {
            background: rgba(239, 68, 68, 0.1);
            color: #DC2626;
        }

        .existing-btn.view {
            background: #1E40AF;
            color: white;
        }

        /* æ—¥æœŸé€‰æ‹©ï¼ˆåªæ˜¾ç¤ºä»Šå¤©å’Œæ˜å¤©ï¼‰ */
        .date-selector {
            display: flex;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
        }

        .date-item {
            flex: 1;
            padding: var(--space-4);
            text-align: center;
            background: white;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .date-item.active {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: white;
        }

        .date-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .date-weekday {
            font-size: 12px;
            margin-bottom: 4px;
        }

        .date-day {
            font-size: 20px;
            font-weight: 700;
        }

        .date-label {
            font-size: 11px;
            margin-top: 4px;
            opacity: 0.8;
        }

        /* åº§ä½ç½‘æ ¼ */
        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: var(--space-3);
        }

        .seat-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: var(--space-3);
            margin-bottom: var(--space-4);
        }

        .seat-item {
            aspect-ratio: 1;
            background: white;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .seat-item:hover:not(.disabled) {
            border-color: var(--color-primary);
        }

        .seat-item.selected {
            background: #EDE9FE;
            border-color: var(--color-primary);
        }

        .seat-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .seat-number {
            font-size: 14px;
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .seat-status {
            font-size: 10px;
            color: var(--color-text-tertiary);
            margin-top: 2px;
        }

        /* å›¾ä¾‹ */
        .legend {
            display: flex;
            gap: var(--space-4);
            justify-content: center;
            margin-bottom: var(--space-4);
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .legend-dot.available {
            background: white;
            border: 1px solid var(--color-border);
        }

        .legend-dot.selected {
            background: #EDE9FE;
            border: 1px solid var(--color-primary);
        }

        /* æ—¶é—´é€‰æ‹©å™¨ */
        .time-section {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .time-picker-row {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-3);
        }

        .time-picker-label {
            width: 60px;
            font-size: 14px;
            color: var(--color-text-secondary);
        }

        .time-select {
            flex: 1;
            padding: var(--space-3);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 14px;
            background: white;
        }

        .time-select:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .time-hint {
            font-size: 12px;
            color: var(--color-text-tertiary);
            margin-top: var(--space-2);
        }

        .time-duration {
            text-align: center;
            padding: var(--space-3);
            background: var(--color-card-bg);
            border-radius: var(--radius-md);
            margin-top: var(--space-3);
        }

        .time-duration-label {
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        .time-duration-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-primary);
        }

        /* é¢„çº¦æŒ‰é’® */
        .reserve-btn {
            width: 100%;
            padding: var(--space-4);
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: var(--radius-lg);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .reserve-btn:hover {
            opacity: 0.9;
        }

        .reserve-btn:disabled {
            background: var(--color-text-tertiary);
            cursor: not-allowed;
        }

        /* æˆ‘çš„é¢„çº¦åˆ—è¡¨ */
        .reservation-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }

        .reservation-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            box-shadow: var(--shadow-sm);
        }

        .reservation-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-3);
        }

        .reservation-seat {
            font-size: 18px;
            font-weight: 700;
            color: var(--color-primary);
        }

        .reservation-status {
            padding: 4px 10px;
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 500;
        }

        .reservation-status.active {
            background: #D1FAE5;
            color: #059669;
        }

        .reservation-status.used {
            background: #DBEAFE;
            color: #2563EB;
        }

        .reservation-status.expired {
            background: #F3F4F6;
            color: #6B7280;
        }

        .reservation-status.cancelled {
            background: #FEE2E2;
            color: #DC2626;
        }

        .reservation-info {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            margin-bottom: var(--space-3);
        }

        .reservation-row {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: 14px;
            color: var(--color-text-secondary);
        }

        .reservation-row-icon {
            width: 20px;
        }

        .reservation-actions {
            display: flex;
            gap: var(--space-2);
        }

        .action-btn {
            flex: 1;
            padding: var(--space-3);
            border: none;
            border-radius: var(--radius-md);
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .action-btn.checkin {
            background: var(--color-success);
            color: white;
        }

        .action-btn.cancel {
            background: var(--color-card-bg);
            color: var(--color-text-secondary);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: var(--space-10) var(--space-4);
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: var(--space-4);
        }

        .empty-text {
            font-size: 14px;
            color: var(--color-text-secondary);
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: var(--space-3) var(--space-5);
            border-radius: var(--radius-full);
            font-size: 14px;
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="top-bar">
        <button class="back-btn" onclick="goBack()">â†</button>
        <span class="top-title">åº§ä½é¢„çº¦ ğŸ“…</span>
        <div class="top-action"></div>
    </div>

    <!-- Tab åˆ‡æ¢ -->
    <div class="tab-container">
        <button class="tab-item active" onclick="switchTab('reserve')">é¢„çº¦åº§ä½</button>
        <button class="tab-item" onclick="switchTab('my')">æˆ‘çš„é¢„çº¦</button>
    </div>

    <!-- é¢„çº¦åº§ä½ -->
    <div class="content" id="reserveContent">
        <!-- é¢„çº¦è§„åˆ™æç¤º -->
        <div class="reservation-limit-card">
            <span class="limit-icon">ğŸ’¡</span>
            <div class="limit-text">
                <strong>é¢„çº¦è§„åˆ™</strong>
                æ¯ä½ç”¨æˆ·æœ€å¤šæœ‰1ä¸ªå¾…ä½¿ç”¨çš„é¢„çº¦ã€‚å¯é¢„çº¦ä»Šå¤©æˆ–æ˜å¤©çš„åº§ä½ï¼Œæ—¶é•¿1-4å°æ—¶ã€‚<br>
                â° é¢„çº¦éœ€æå‰è‡³å°‘1å°æ—¶ï¼Œå¼€å§‹å‰30åˆ†é’Ÿå†…ä¸å¯å–æ¶ˆã€‚
            </div>
        </div>

        <!-- å·²æœ‰é¢„çº¦æç¤ºï¼ˆåŠ¨æ€æ˜¾ç¤ºï¼‰ -->
        <div class="existing-reservation-card" id="existingCard">
            <div class="existing-header">
                <span>ğŸ“Œ</span>
                <span>æ‚¨å·²æœ‰ä¸€ä¸ªå¾…ä½¿ç”¨çš„é¢„çº¦</span>
            </div>
            <div class="existing-info" id="existingInfo">
                <!-- åŠ¨æ€å¡«å…… -->
            </div>
            <div class="existing-actions">
                <button class="existing-btn cancel" onclick="cancelExistingReservation()">å–æ¶ˆé¢„çº¦</button>
                <button class="existing-btn view" onclick="switchTab('my')">æŸ¥çœ‹è¯¦æƒ…</button>
            </div>
        </div>

        <!-- æ—¥æœŸé€‰æ‹©ï¼ˆåªæ˜¾ç¤ºä»Šå¤©å’Œæ˜å¤©ï¼‰ -->
        <div class="section-title">é€‰æ‹©æ—¥æœŸ</div>
        <div class="date-selector" id="dateSelector">
            <!-- ç”±JSç”Ÿæˆ -->
        </div>

        <!-- å›¾ä¾‹ -->
        <div class="legend">
            <div class="legend-item">
                <div class="legend-dot available"></div>
                <span>å¯é€‰</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot selected"></div>
                <span>å·²é€‰</span>
            </div>
        </div>

        <!-- åº§ä½ç½‘æ ¼ -->
        <div class="section-title">é€‰æ‹©åº§ä½</div>
        <div class="seat-grid" id="seatGrid">
            <!-- ç”±JSç”Ÿæˆ -->
        </div>

        <!-- æ—¶é—´é€‰æ‹© -->
        <div class="time-section">
            <div class="section-title">é€‰æ‹©æ—¶é—´</div>
            <div class="time-picker-row">
                <span class="time-picker-label">å¼€å§‹æ—¶é—´</span>
                <select class="time-select" id="startTimeSelect" onchange="updateDuration()">
                    <!-- ç”±JSç”Ÿæˆ -->
                </select>
            </div>
            <div class="time-picker-row">
                <span class="time-picker-label">ç»“æŸæ—¶é—´</span>
                <select class="time-select" id="endTimeSelect" onchange="updateDuration()">
                    <!-- ç”±JSç”Ÿæˆ -->
                </select>
            </div>
            <div class="time-hint">â° é¢„çº¦æ—¶é•¿ï¼šæœ€çŸ­1å°æ—¶ï¼Œæœ€é•¿4å°æ—¶</div>
            <div class="time-duration">
                <div class="time-duration-label">é¢„çº¦æ—¶é•¿</div>
                <div class="time-duration-value" id="durationValue">--</div>
            </div>
        </div>

        <!-- é¢„çº¦æŒ‰é’® -->
        <button class="reserve-btn" id="reserveBtn" onclick="submitReservation()" disabled>
            è¯·é€‰æ‹©åº§ä½å’Œæ—¶é—´
        </button>
    </div>

    <!-- æˆ‘çš„é¢„çº¦ -->
    <div class="content" id="myContent" style="display: none;">
        <div class="reservation-list" id="reservationList">
            <!-- ç”±JSç”Ÿæˆ -->
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        const statusMap = {
            0: { text: 'å·²å–æ¶ˆ', class: 'cancelled' },
            1: { text: 'å¾…ä½¿ç”¨', class: 'active' },
            2: { text: 'å·²ä½¿ç”¨', class: 'used' },
            3: { text: 'å·²è¿‡æœŸ', class: 'expired' }
        };

        let selectedDate = null;
        let selectedSeat = null;
        let seats = [];
        let existingReservation = null; // ç”¨æˆ·å½“å‰çš„å¾…ä½¿ç”¨é¢„çº¦

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            generateDateSelector();
            generateTimeOptions();
            loadSeats();
            checkExistingReservation();
        });

        // ç”Ÿæˆæ—¥æœŸé€‰æ‹©å™¨ï¼ˆåªæœ‰ä»Šå¤©å’Œæ˜å¤©ï¼‰
        function generateDateSelector() {
            const container = document.getElementById('dateSelector');
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            
            const dates = [
                { date: today, label: 'ä»Šå¤©' },
                { date: tomorrow, label: 'æ˜å¤©' }
            ];
            
            let html = '';
            dates.forEach((item, index) => {
                const dateStr = formatDateStr(item.date);
                const isToday = index === 0;
                
                html += `
                    <div class="date-item ${isToday ? 'active' : ''}" 
                         data-date="${dateStr}" 
                         onclick="selectDate('${dateStr}', this)">
                        <div class="date-weekday">å‘¨${weekdays[item.date.getDay()]}</div>
                        <div class="date-day">${item.date.getDate()}</div>
                        <div class="date-label">${item.label}</div>
                    </div>
                `;
            });
            container.innerHTML = html;
            
            // é»˜è®¤é€‰ä¸­ä»Šå¤©
            selectedDate = formatDateStr(today);
        }

        // ç”Ÿæˆæ—¶é—´é€‰é¡¹
        function generateTimeOptions() {
            const startSelect = document.getElementById('startTimeSelect');
            const endSelect = document.getElementById('endTimeSelect');
            
            let startHtml = '<option value="">è¯·é€‰æ‹©å¼€å§‹æ—¶é—´</option>';
            let endHtml = '<option value="">è¯·é€‰æ‹©ç»“æŸæ—¶é—´</option>';
            
            // è¥ä¸šæ—¶é—´ 8:00 - 22:00
            for (let h = 8; h <= 21; h++) {
                for (let m = 0; m < 60; m += 30) {
                    const time = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                    startHtml += `<option value="${time}">${time}</option>`;
                }
            }
            
            for (let h = 9; h <= 22; h++) {
                for (let m = 0; m < 60; m += 30) {
                    if (h === 22 && m > 0) continue;
                    const time = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                    endHtml += `<option value="${time}">${time}</option>`;
                }
            }
            
            startSelect.innerHTML = startHtml;
            endSelect.innerHTML = endHtml;
        }

        // æ›´æ–°æ—¶é•¿æ˜¾ç¤º
        function updateDuration() {
            const startTime = document.getElementById('startTimeSelect').value;
            const endTime = document.getElementById('endTimeSelect').value;
            const durationEl = document.getElementById('durationValue');
            
            if (startTime && endTime) {
                const [startH, startM] = startTime.split(':').map(Number);
                const [endH, endM] = endTime.split(':').map(Number);
                const startMinutes = startH * 60 + startM;
                const endMinutes = endH * 60 + endM;
                const duration = endMinutes - startMinutes;
                
                if (duration > 0) {
                    const hours = Math.floor(duration / 60);
                    const mins = duration % 60;
                    durationEl.textContent = mins > 0 ? `${hours}å°æ—¶${mins}åˆ†é’Ÿ` : `${hours}å°æ—¶`;
                } else {
                    durationEl.textContent = 'æ—¶é—´æ— æ•ˆ';
                }
            } else {
                durationEl.textContent = '--';
            }
            
            updateReserveBtn();
        }

        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²æœ‰å¾…ä½¿ç”¨çš„é¢„çº¦
        async function checkExistingReservation() {
            try {
                const res = await fetch('/api/reservation/pending');
                const data = await res.json();
                
                if (data.success && data.reservation) {
                    existingReservation = data.reservation;
                    showExistingReservation(data.reservation);
                } else {
                    existingReservation = null;
                    document.getElementById('existingCard').classList.remove('show');
                }
            } catch (err) {
                console.error('æ£€æŸ¥é¢„çº¦å¤±è´¥:', err);
            }
        }

        // æ˜¾ç¤ºå·²æœ‰é¢„çº¦
        function showExistingReservation(reservation) {
            const card = document.getElementById('existingCard');
            const info = document.getElementById('existingInfo');
            
            info.innerHTML = `
                ğŸ“… ${reservation.reservationDate} &nbsp;
                â° ${reservation.startTime} - ${reservation.endTime} &nbsp;
                ğŸ’º ${reservation.seatNumber || 'åº§ä½'} å·
            `;
            
            card.classList.add('show');
        }

        // å–æ¶ˆå·²æœ‰é¢„çº¦
        async function cancelExistingReservation() {
            if (!existingReservation) return;
            if (!confirm('ç¡®å®šè¦å–æ¶ˆè¿™ä¸ªé¢„çº¦å—ï¼Ÿ')) return;
            
            try {
                const res = await fetch(`/api/reservation/${existingReservation.id}/cancel`, { method: 'POST' });
                const data = await res.json();
                
                if (data.success) {
                    showToast('å–æ¶ˆæˆåŠŸ');
                    checkExistingReservation();
                } else {
                    showToast(data.message || 'å–æ¶ˆå¤±è´¥');
                }
            } catch (err) {
                showToast('ç½‘ç»œé”™è¯¯');
            }
        }

        async function loadSeats() {
            try {
                const res = await fetch('/api/reservation/seats');
                const data = await res.json();
                
                if (data.success) {
                    seats = data.seats;
                    renderSeats();
                }
            } catch (err) {
                showToast('åŠ è½½åº§ä½å¤±è´¥');
            }
        }

        function renderSeats() {
            const grid = document.getElementById('seatGrid');
            const hasExisting = existingReservation !== null;
            
            grid.innerHTML = seats.map(seat => `
                <div class="seat-item ${selectedSeat === seat.id ? 'selected' : ''} ${hasExisting ? 'disabled' : ''}" 
                     data-id="${seat.id}"
                     onclick="${hasExisting ? '' : `selectSeat(${seat.id}, this)`}">
                    <div class="seat-number">${seat.seatNumber}</div>
                    <div class="seat-status">å¯é¢„çº¦</div>
                </div>
            `).join('');
        }

        function selectDate(dateStr, el) {
            selectedDate = dateStr;
            
            document.querySelectorAll('.date-item').forEach(item => {
                item.classList.toggle('active', item.dataset.date === dateStr);
            });
            
            updateReserveBtn();
        }

        function selectSeat(seatId, el) {
            if (existingReservation) {
                showToast('æ‚¨å·²æœ‰ä¸€ä¸ªå¾…ä½¿ç”¨çš„é¢„çº¦ï¼Œè¯·å…ˆå–æ¶ˆ');
                return;
            }
            
            selectedSeat = seatId;
            
            document.querySelectorAll('.seat-item').forEach(item => {
                item.classList.toggle('selected', parseInt(item.dataset.id) === seatId);
            });
            
            updateReserveBtn();
        }

        function updateReserveBtn() {
            const btn = document.getElementById('reserveBtn');
            const startTime = document.getElementById('startTimeSelect').value;
            const endTime = document.getElementById('endTimeSelect').value;
            
            if (existingReservation) {
                btn.textContent = 'æ‚¨å·²æœ‰å¾…ä½¿ç”¨çš„é¢„çº¦';
                btn.disabled = true;
                return;
            }
            
            if (selectedSeat && startTime && endTime) {
                // éªŒè¯æ—¶é—´
                const [startH, startM] = startTime.split(':').map(Number);
                const [endH, endM] = endTime.split(':').map(Number);
                const startMinutes = startH * 60 + startM;
                const endMinutes = endH * 60 + endM;
                const duration = endMinutes - startMinutes;
                
                if (duration < 60) {
                    btn.textContent = 'é¢„çº¦æ—¶é•¿ä¸èƒ½å°‘äº1å°æ—¶';
                    btn.disabled = true;
                    return;
                }
                
                if (duration > 240) {
                    btn.textContent = 'é¢„çº¦æ—¶é•¿ä¸èƒ½è¶…è¿‡4å°æ—¶';
                    btn.disabled = true;
                    return;
                }
                
                // éªŒè¯æ˜¯å¦æå‰è‡³å°‘1å°æ—¶é¢„çº¦
                const now = new Date();
                const today = formatDateStr(now);
                if (selectedDate === today) {
                    const currentMinutes = now.getHours() * 60 + now.getMinutes();
                    if (startMinutes < currentMinutes + 60) {
                        btn.textContent = 'é¢„çº¦éœ€æå‰è‡³å°‘1å°æ—¶';
                        btn.disabled = true;
                        return;
                    }
                }
                
                const seat = seats.find(s => s.id === selectedSeat);
                btn.textContent = `ç¡®è®¤é¢„çº¦ ${seat.seatNumber} å·åº§ä½`;
                btn.disabled = false;
            } else if (selectedSeat) {
                btn.textContent = 'è¯·é€‰æ‹©æ—¶é—´';
                btn.disabled = true;
            } else {
                btn.textContent = 'è¯·é€‰æ‹©åº§ä½å’Œæ—¶é—´';
                btn.disabled = true;
            }
        }

        async function submitReservation() {
            if (!selectedSeat || existingReservation) return;
            
            const startTime = document.getElementById('startTimeSelect').value;
            const endTime = document.getElementById('endTimeSelect').value;
            
            if (!startTime || !endTime) {
                showToast('è¯·é€‰æ‹©æ—¶é—´');
                return;
            }
            
            // å†æ¬¡éªŒè¯æ˜¯å¦æå‰è‡³å°‘1å°æ—¶é¢„çº¦
            const now = new Date();
            const today = formatDateStr(now);
            if (selectedDate === today) {
                const [startH, startM] = startTime.split(':').map(Number);
                const startMinutes = startH * 60 + startM;
                const currentMinutes = now.getHours() * 60 + now.getMinutes();
                if (startMinutes < currentMinutes + 60) {
                    showToast('é¢„çº¦éœ€æå‰è‡³å°‘1å°æ—¶');
                    return;
                }
            }
            
            const btn = document.getElementById('reserveBtn');
            btn.disabled = true;
            btn.textContent = 'é¢„çº¦ä¸­...';
            
            try {
                const res = await fetch('/api/reservation/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        seatId: selectedSeat.toString(),
                        date: selectedDate,
                        startTime: startTime + ':00',
                        endTime: endTime + ':00'
                    })
                });
                const data = await res.json();
                
                if (data.success) {
                    showToast('é¢„çº¦æˆåŠŸï¼');
                    selectedSeat = null;
                    document.getElementById('startTimeSelect').value = '';
                    document.getElementById('endTimeSelect').value = '';
                    updateDuration();
                    checkExistingReservation();
                    renderSeats();
                } else {
                    showToast(data.message || 'é¢„çº¦å¤±è´¥');
                }
            } catch (err) {
                showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            } finally {
                updateReserveBtn();
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-item').forEach((item, index) => {
                item.classList.toggle('active', (tab === 'reserve' && index === 0) || (tab === 'my' && index === 1));
            });
            
            document.getElementById('reserveContent').style.display = tab === 'reserve' ? 'block' : 'none';
            document.getElementById('myContent').style.display = tab === 'my' ? 'block' : 'none';
            
            if (tab === 'my') {
                loadMyReservations();
            }
        }

        async function loadMyReservations() {
            const list = document.getElementById('reservationList');
            list.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">åŠ è½½ä¸­...</div>';
            
            try {
                const res = await fetch('/api/reservation/my');
                const data = await res.json();
                
                if (data.success && data.reservations.length > 0) {
                    list.innerHTML = data.reservations.map(r => {
                        const status = statusMap[r.status] || statusMap[0];
                        const canCheckin = r.status === 1 && isWithinCheckinTime(r);
                        const canCancel = r.status === 1 && !isNearStart(r);
                        const cancelBtnText = canCancel ? 'å–æ¶ˆ' : 'å¼€å§‹å‰30åˆ†é’Ÿå†…ä¸å¯å–æ¶ˆ';
                        
                        return `
                            <div class="reservation-card">
                                <div class="reservation-header">
                                    <span class="reservation-seat">${r.seatNumber || 'åº§ä½'} å·</span>
                                    <span class="reservation-status ${status.class}">${status.text}</span>
                                </div>
                                <div class="reservation-info">
                                    <div class="reservation-row">
                                        <span class="reservation-row-icon">ğŸ“…</span>
                                        <span>${r.reservationDate}</span>
                                    </div>
                                    <div class="reservation-row">
                                        <span class="reservation-row-icon">â°</span>
                                        <span>${r.startTime} - ${r.endTime}</span>
                                    </div>
                                </div>
                                ${r.status === 1 ? `
                                <div class="reservation-actions">
                                    <button class="action-btn checkin" onclick="checkIn(${r.id})" ${!canCheckin ? 'disabled' : ''}>
                                        ${canCheckin ? 'ç­¾åˆ°' : 'æœªåˆ°ç­¾åˆ°æ—¶é—´'}
                                    </button>
                                    <button class="action-btn cancel" onclick="cancelReservation(${r.id})" ${!canCancel ? 'disabled' : ''}>
                                        ${cancelBtnText}
                                    </button>
                                </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
                } else {
                    list.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ“‹</div>
                            <div class="empty-text">æš‚æ— é¢„çº¦è®°å½•</div>
                        </div>
                    `;
                }
            } catch (err) {
                list.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">åŠ è½½å¤±è´¥</div>';
            }
        }

        function isWithinCheckinTime(reservation) {
            const now = new Date();
            const today = formatDateStr(now);
            if (reservation.reservationDate !== today) return false;
            
            const currentTime = now.getHours() * 60 + now.getMinutes();
            const [startH, startM] = reservation.startTime.split(':').map(Number);
            const startMinutes = startH * 60 + startM;
            
            return currentTime >= startMinutes - 15 && currentTime <= startMinutes + 15;
        }

        // åˆ¤æ–­æ˜¯å¦åœ¨å¼€å§‹å‰30åˆ†é’Ÿå†…ï¼ˆä¸å¯å–æ¶ˆï¼‰
        function isNearStart(reservation) {
            const now = new Date();
            const today = formatDateStr(now);
            
            // å¦‚æœæ˜¯æ˜å¤©çš„é¢„çº¦ï¼Œè¿˜å¯ä»¥å–æ¶ˆ
            if (reservation.reservationDate > today) return false;
            
            // å¦‚æœé¢„çº¦æ—¥æœŸå·²è¿‡ï¼Œä¸å¯å–æ¶ˆ
            if (reservation.reservationDate < today) return true;
            
            // ä»Šå¤©çš„é¢„çº¦ï¼Œæ£€æŸ¥æ˜¯å¦åœ¨å¼€å§‹å‰30åˆ†é’Ÿå†…
            const currentTime = now.getHours() * 60 + now.getMinutes();
            const [startH, startM] = reservation.startTime.split(':').map(Number);
            const startMinutes = startH * 60 + startM;
            
            // å¦‚æœå½“å‰æ—¶é—´ >= å¼€å§‹æ—¶é—´-30åˆ†é’Ÿï¼Œåˆ™ä¸å¯å–æ¶ˆ
            return currentTime >= startMinutes - 30;
        }

        async function checkIn(reservationId) {
            try {
                const res = await fetch(`/api/reservation/${reservationId}/checkin`, { method: 'POST' });
                const data = await res.json();
                
                if (data.success) {
                    showToast('ç­¾åˆ°æˆåŠŸ');
                    loadMyReservations();
                    checkExistingReservation();
                } else {
                    showToast(data.message || 'ç­¾åˆ°å¤±è´¥');
                }
            } catch (err) {
                showToast('ç½‘ç»œé”™è¯¯');
            }
        }

        async function cancelReservation(reservationId) {
            if (!confirm('ç¡®å®šè¦å–æ¶ˆè¿™ä¸ªé¢„çº¦å—ï¼Ÿ')) return;
            
            try {
                const res = await fetch(`/api/reservation/${reservationId}/cancel`, { method: 'POST' });
                const data = await res.json();
                
                if (data.success) {
                    showToast('å–æ¶ˆæˆåŠŸ');
                    loadMyReservations();
                    checkExistingReservation();
                } else {
                    showToast(data.message || 'å–æ¶ˆå¤±è´¥');
                }
            } catch (err) {
                showToast('ç½‘ç»œé”™è¯¯');
            }
        }

        function formatDateStr(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        function goBack() {
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = '/profile.html';
            }
        }
    </script>
</body>
</html>
