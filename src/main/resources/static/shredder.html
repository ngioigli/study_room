<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åæƒ…ç»ªç²‰ç¢æœº - è‡ªä¹ å®¤</title>
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/components.css">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Noto Sans SC"', 'sans-serif'],
                        hand: ['"ZCOOL KuaiLe"', 'cursive'],
                        cute: ['"ZCOOL KuaiLe"', 'cursive'],
                    },
                    colors: {
                        'cream': '#FFFDF5',
                        'pastel-yellow': '#FEF9C3',
                        'pastel-pink': '#FCE7F3',
                        'pastel-blue': '#E0F2FE',
                        'pastel-green': '#DCFCE7',
                        'soft-text': '#57534E',
                        'accent': '#F472B6',
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'breathe': 'breathe 4s ease-in-out infinite',
                        'bounce-slow': 'bounce 2s infinite',
                        'pulse-glow': 'pulse-glow 2s infinite',
                        'spin-slow': 'spin 3s linear infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        breathe: {
                            '0%, 100%': { transform: 'scale(1)' },
                            '50%': { transform: 'scale(1.05)' },
                        },
                        'pulse-glow': {
                            '0%, 100%': { boxShadow: '0 0 20px rgba(244, 114, 182, 0.4)' },
                            '50%': { boxShadow: '0 0 40px rgba(244, 114, 182, 0.8)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #FFFDF5;
            overscroll-behavior: none;
            min-height: 100vh;
        }
        
        /* Custom scrollbar */
        textarea::-webkit-scrollbar {
            width: 6px;
        }
        textarea::-webkit-scrollbar-track {
            background: transparent;
        }
        textarea::-webkit-scrollbar-thumb {
            background: #E5E7EB;
            border-radius: 10px;
        }
        textarea::-webkit-scrollbar-thumb:hover {
            background: #D1D5DB;
        }
        
        /* Animations */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        @keyframes paper-fall {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(500px) rotate(720deg); opacity: 0; }
        }
        
        @keyframes mascot-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes fire-flicker {
            0%, 100% { height: 60px; opacity: 0.6; }
            50% { height: 100px; opacity: 1; }
        }
        
        @keyframes star-twinkle {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 1; }
        }
        
        @keyframes bubble-float {
            0% { transform: translate(0, 0) scale(0); opacity: 0; }
            20% { opacity: 1; }
            100% { transform: translate(var(--tx), -500px) scale(1); opacity: 0; }
        }
        
        @keyframes black-hole-grow {
            0% { width: 0; height: 0; opacity: 0; }
            20% { width: 250px; height: 250px; opacity: 1; }
            80% { width: 250px; height: 250px; opacity: 1; }
            100% { width: 0; height: 0; opacity: 0; }
        }
        
        @keyframes paper-suck {
            0% { transform: scale(1) rotate(1deg); opacity: 1; filter: blur(0px); }
            50% { transform: scale(0.8) rotate(10deg); opacity: 0.8; filter: blur(2px); }
            100% { transform: scale(0) rotate(720deg); opacity: 0; filter: blur(10px); }
        }
        
        @keyframes rocket-launch {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-1200px) scale(0.2); opacity: 0; }
        }
        
        @keyframes shred-strip {
            0% { transform: translateY(0) rotateX(0) rotateY(0); opacity: 0; }
            20% { opacity: 1; }
            100% { transform: translateY(500px) rotateX(720deg) rotateY(360deg); opacity: 0; }
        }
        
        .mascot-processing {
            animation: mascot-bounce 2s ease-in-out infinite;
        }
        
        .fire-trail {
            animation: fire-flicker 0.15s infinite;
        }
        
        .star {
            animation: star-twinkle 2s infinite;
        }
        
        .bubble {
            animation: bubble-float 5s ease-out forwards;
        }
        
        .black-hole {
            animation: black-hole-grow 3.5s ease-in-out forwards;
        }
        
        .paper-suck {
            animation: paper-suck 1.5s ease-in forwards;
            animation-delay: 0.8s;
        }
        
        .rocket-launch {
            animation: rocket-launch 3s cubic-bezier(0.2, 0, 0.2, 1) forwards;
            animation-delay: 0.5s;
        }
        
        .shred-strip {
            animation: shred-strip 2.5s ease-in forwards;
        }
        
        /* Modal backdrop */
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(4px);
        }
        
        /* Transition classes */
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        .fade-out {
            animation: fadeOut 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }
        
        /* Tool button hover effect */
        .tool-btn:hover:not(:disabled) .tool-tooltip {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        .tool-tooltip {
            opacity: 0;
            transform: translateX(-50%) translateY(10px);
            transition: all 0.3s ease;
        }
        
        /* Washi tape pattern */
        .washi-tape {
            background: repeating-linear-gradient(
                90deg,
                transparent,
                transparent 4px,
                rgba(255,255,255,0.3) 4px,
                rgba(255,255,255,0.3) 8px
            );
        }
    </style>
</head>
<body class="min-h-screen bg-cream text-soft-text overflow-x-hidden font-sans">
    <!-- Background Decor -->
    <div class="fixed inset-0 pointer-events-none -z-10 overflow-hidden">
        <div class="absolute top-[-5%] left-[-5%] w-80 h-80 bg-pastel-pink/40 rounded-full blur-3xl animate-float" style="animation-delay: 1s;"></div>
        <div class="absolute bottom-[-10%] right-[-5%] w-[500px] h-[500px] bg-pastel-blue/40 rounded-full blur-3xl animate-float"></div>
        <div class="absolute top-[40%] right-[15%] w-40 h-40 bg-yellow-200/50 rounded-full blur-2xl animate-breathe"></div>
    </div>

    <!-- Header -->
    <header class="fixed top-0 w-full p-4 md:p-6 flex justify-between items-center z-30">
        <div class="flex items-center gap-2">
            <a href="study.html" class="w-10 h-10 bg-white/60 backdrop-blur-md rounded-full flex items-center justify-center text-slate-500 hover:bg-white transition-colors shadow-sm">
                <i data-lucide="arrow-left" class="w-5 h-5"></i>
            </a>
            <div class="flex items-center gap-2">
                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-xl shadow-sm border border-slate-50">ğŸ¬</div>
                <h1 class="font-cute text-xl md:text-2xl tracking-wide text-slate-600">åæƒ…ç»ªç²‰ç¢æœº</h1>
            </div>
        </div>
        
        <div class="flex gap-2 md:gap-3">
            <button id="muteBtn" class="w-10 h-10 bg-white/60 backdrop-blur-md rounded-full flex items-center justify-center text-slate-500 hover:bg-white transition-colors shadow-sm" title="åˆ‡æ¢å£°éŸ³">
                <i data-lucide="volume-2" class="w-5 h-5" id="volumeIcon"></i>
            </button>
            <button id="historyBtn" class="px-3 md:px-4 h-10 bg-white/60 backdrop-blur-md rounded-full flex items-center gap-2 text-slate-600 hover:bg-white transition-colors shadow-sm font-cute text-sm">
                <i data-lucide="history" class="w-4 h-4"></i>
                <span class="hidden md:inline">æ²»æ„ˆæ—…ç¨‹</span>
            </button>
            <button id="settingsBtn" class="w-10 h-10 bg-white/60 backdrop-blur-md rounded-full flex items-center justify-center text-slate-500 hover:bg-white transition-colors shadow-sm" title="è®¾ç½®">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <!-- Main Stage -->
    <main id="mainStage" class="flex flex-col items-center justify-center min-h-screen p-4 pt-20 pb-8 relative w-full max-w-4xl mx-auto z-10">
        <!-- Mascot (æ²»æ„ˆå›¢å­) -->
        <div id="mascot" class="w-20 h-20 md:w-24 md:h-24 mb-4 relative">
            <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-lg" id="mascotSvg">
                <!-- Body -->
                <circle cx="50" cy="55" r="40" fill="#FCE7F3" />
                <!-- IDLE Face -->
                <g id="faceIdle">
                    <circle cx="35" cy="50" r="4" fill="#4B5563" />
                    <circle cx="65" cy="50" r="4" fill="#4B5563" />
                    <path d="M 45 60 Q 50 65 55 60" stroke="#4B5563" stroke-width="3" fill="none" stroke-linecap="round" />
                    <circle cx="30" cy="58" r="3" fill="#F472B6" opacity="0.6" />
                    <circle cx="70" cy="58" r="3" fill="#F472B6" opacity="0.6" />
                </g>
                <!-- PROCESSING Face -->
                <g id="faceProcessing" style="display: none;">
                    <path d="M 32 50 Q 36 46 40 50" stroke="#4B5563" stroke-width="3" fill="none" stroke-linecap="round" />
                    <path d="M 60 50 Q 64 46 68 50" stroke="#4B5563" stroke-width="3" fill="none" stroke-linecap="round" />
                    <circle cx="50" cy="62" r="3" fill="#4B5563" />
                    <path d="M 15 55 Q 5 45 15 35" stroke="#FCE7F3" stroke-width="8" stroke-linecap="round" />
                    <path d="M 85 55 Q 95 45 85 35" stroke="#FCE7F3" stroke-width="8" stroke-linecap="round" />
                </g>
                <!-- RESULT Face -->
                <g id="faceResult" style="display: none;">
                    <path d="M 32 52 Q 36 45 40 52" stroke="#4B5563" stroke-width="3" fill="none" stroke-linecap="round" />
                    <path d="M 60 52 Q 64 45 68 52" stroke="#4B5563" stroke-width="3" fill="none" stroke-linecap="round" />
                    <path d="M 42 60 Q 50 68 58 60" stroke="#4B5563" stroke-width="3" fill="none" stroke-linecap="round" />
                    <path d="M 50 30 L 55 20 L 60 28" fill="#FCD34D" />
                    <circle cx="30" cy="58" r="4" fill="#F472B6" opacity="0.8" />
                    <circle cx="70" cy="58" r="4" fill="#F472B6" opacity="0.8" />
                </g>
            </svg>
        </div>

        <!-- IDLE STATE: Input Stage -->
        <div id="inputStage" class="flex flex-col items-center w-full fade-in">
            <div class="mb-6 md:mb-8 text-center max-w-md">
                <h2 class="text-lg md:text-2xl font-bold mb-2 text-slate-700 font-cute">æœ‰ä»€ä¹ˆä¸å¼€å¿ƒçš„äº‹å—ï¼Ÿ</h2>
                <p class="text-slate-500 text-sm md:text-base">å†™ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¸€èµ·æŠŠå®ƒæ¶ˆç­æ‰ã€‚</p>
            </div>

            <!-- Mood Paper -->
            <div class="relative w-64 h-64 md:w-80 md:h-80 shadow-xl transform rotate-1 flex flex-col p-4 md:p-6 rounded-sm mb-6 md:mb-8"
                 style="background: linear-gradient(135deg, #FEF9C3 0%, #FDE047 100%); box-shadow: 10px 10px 30px rgba(0,0,0,0.08), 0 0 0 1px rgba(0,0,0,0.02);">
                <!-- Washi Tape -->
                <div class="absolute -top-3 md:-top-4 left-1/2 transform -translate-x-1/2 w-20 md:w-24 h-6 md:h-8 bg-pink-200/80 backdrop-blur-sm rotate-[-2deg] shadow-sm z-10 flex items-center justify-center overflow-hidden rounded-sm washi-tape"></div>
                
                <textarea id="moodText" 
                    placeholder="æŠŠé‚£äº›çƒ¦äººçš„ã€ä¸å¼€å¿ƒçš„äº‹ï¼Œéƒ½å†™åœ¨è¿™é‡Œå§..."
                    class="flex-1 w-full h-full bg-transparent resize-none border-none outline-none font-hand text-lg md:text-2xl text-slate-700 placeholder-slate-400/60 leading-relaxed tracking-wide"
                    spellcheck="false"></textarea>
                
                <!-- Heart doodle -->
                <div class="absolute bottom-3 md:bottom-4 right-3 md:right-4 opacity-40">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-600">
                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
                    </svg>
                </div>
            </div>

            <!-- Tool Bar -->
            <div class="flex flex-col items-center gap-4 md:gap-6 w-full max-w-2xl px-4">
                <p id="toolHint" class="text-soft-text font-cute text-base md:text-lg mb-2 h-6 flex items-center gap-2 opacity-0 transition-opacity duration-300">
                    ğŸ‘‡ é€‰æ‹©ä¸€ç§æ–¹å¼æ¶ˆç­å®ƒï¼š
                </p>

                <div class="flex justify-center gap-4 md:gap-8 flex-wrap">
                    <!-- Shredder -->
                    <button class="tool-btn relative group flex flex-col items-center justify-center w-16 h-16 md:w-24 md:h-24 rounded-3xl transition-all duration-300 bg-blue-100 text-blue-500 hover:bg-blue-200 opacity-40 cursor-not-allowed shadow-lg"
                            data-tool="SHREDDER" disabled>
                        <i data-lucide="scissors" class="w-6 h-6 md:w-8 md:h-8"></i>
                        <span class="hidden md:block text-xs md:text-sm font-bold font-cute mt-1">å¼ºåŠ›ç²‰ç¢</span>
                        <div class="tool-tooltip absolute -top-12 left-1/2 transform -translate-x-1/2 bg-white text-soft-text text-xs py-2 px-3 rounded-xl shadow-md whitespace-nowrap pointer-events-none border border-gray-100">
                            å’”åš“å’”åš“ç¢æ‰
                            <div class="absolute -bottom-1 left-1/2 transform -translate-x-1/2 w-2 h-2 bg-white rotate-45 border-r border-b border-gray-100"></div>
                        </div>
                    </button>

                    <!-- Rocket -->
                    <button class="tool-btn relative group flex flex-col items-center justify-center w-16 h-16 md:w-24 md:h-24 rounded-3xl transition-all duration-300 bg-red-100 text-red-500 hover:bg-red-200 opacity-40 cursor-not-allowed shadow-lg"
                            data-tool="ROCKET" disabled>
                        <i data-lucide="rocket" class="w-6 h-6 md:w-8 md:h-8"></i>
                        <span class="hidden md:block text-xs md:text-sm font-bold font-cute mt-1">å‘å°„å¤ªç©º</span>
                        <div class="tool-tooltip absolute -top-12 left-1/2 transform -translate-x-1/2 bg-white text-soft-text text-xs py-2 px-3 rounded-xl shadow-md whitespace-nowrap pointer-events-none border border-gray-100">
                            å†ä¹Ÿè§ä¸åˆ°äº†
                            <div class="absolute -bottom-1 left-1/2 transform -translate-x-1/2 w-2 h-2 bg-white rotate-45 border-r border-b border-gray-100"></div>
                        </div>
                    </button>

                    <!-- Bubble -->
                    <button class="tool-btn relative group flex flex-col items-center justify-center w-16 h-16 md:w-24 md:h-24 rounded-3xl transition-all duration-300 bg-purple-100 text-purple-500 hover:bg-purple-200 opacity-40 cursor-not-allowed shadow-lg"
                            data-tool="BUBBLE" disabled>
                        <i data-lucide="wind" class="w-6 h-6 md:w-8 md:h-8"></i>
                        <span class="hidden md:block text-xs md:text-sm font-bold font-cute mt-1">å¹æˆæ³¡æ³¡</span>
                        <div class="tool-tooltip absolute -top-12 left-1/2 transform -translate-x-1/2 bg-white text-soft-text text-xs py-2 px-3 rounded-xl shadow-md whitespace-nowrap pointer-events-none border border-gray-100">
                            å™—å™—éšé£é£˜èµ°
                            <div class="absolute -bottom-1 left-1/2 transform -translate-x-1/2 w-2 h-2 bg-white rotate-45 border-r border-b border-gray-100"></div>
                        </div>
                    </button>

                    <!-- Black Hole -->
                    <button class="tool-btn relative group flex flex-col items-center justify-center w-16 h-16 md:w-24 md:h-24 rounded-3xl transition-all duration-300 bg-slate-800 text-slate-200 hover:bg-slate-700 opacity-40 cursor-not-allowed shadow-lg"
                            data-tool="BLACK_HOLE" disabled>
                        <i data-lucide="circle-dashed" class="w-6 h-6 md:w-8 md:h-8"></i>
                        <span class="hidden md:block text-xs md:text-sm font-bold font-cute mt-1">ä¸¢è¿›é»‘æ´</span>
                        <div class="tool-tooltip absolute -top-12 left-1/2 transform -translate-x-1/2 bg-white text-soft-text text-xs py-2 px-3 rounded-xl shadow-md whitespace-nowrap pointer-events-none border border-gray-100">
                            å¸å…¥å¼‚æ¬¡å…ƒ
                            <div class="absolute -bottom-1 left-1/2 transform -translate-x-1/2 w-2 h-2 bg-white rotate-45 border-r border-b border-gray-100"></div>
                        </div>
                    </button>
                </div>
            </div>
        </div>

        <!-- PROCESSING STATE: Animation Stage -->
        <div id="processingStage" class="w-full flex flex-col items-center justify-center hidden">
            <h3 id="processingText" class="text-lg md:text-xl font-cute text-slate-500 mb-6 md:mb-8 animate-pulse"></h3>
            <div id="animationContainer" class="relative w-full h-[400px] md:h-[600px] flex items-center justify-center overflow-hidden"></div>
        </div>

        <!-- RESULT STATE: Comfort Message -->
        <div id="resultStage" class="flex flex-col items-center justify-center max-w-md text-center px-4 md:px-6 hidden">
            <div class="w-20 h-20 md:w-24 md:h-24 bg-white rounded-full flex items-center justify-center mb-4 md:mb-6 shadow-md border-4 border-pastel-green transform scale-0" id="heartIcon" style="transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);">
                <i data-lucide="heart" class="w-10 h-10 md:w-12 md:h-12 text-green-400 fill-green-400"></i>
            </div>
            
            <h3 class="text-xl md:text-2xl font-cute text-slate-700 mb-4 md:mb-6">å…¨éƒ½æ¶ˆå¤±å•¦ï¼</h3>
            
            <div class="bg-white/80 backdrop-blur-sm p-6 md:p-8 rounded-3xl shadow-xl border border-white relative mb-8 md:mb-10 w-full transform hover:scale-105 transition-transform duration-500">
                <div class="absolute -top-4 -left-2 text-5xl md:text-6xl text-pastel-pink opacity-40 font-serif">"</div>
                <p id="comfortMessage" class="text-lg md:text-xl font-hand text-slate-600 leading-loose tracking-wide">
                    æ­£åœ¨æ¥æ”¶æ¥è‡ªå®‡å®™çš„ä¿¡å·...
                </p>
                <div class="absolute -bottom-6 md:-bottom-8 -right-2 text-5xl md:text-6xl text-pastel-pink opacity-40 font-serif rotate-180">"</div>
            </div>

            <button id="resetBtn" class="group flex items-center gap-2 md:gap-3 px-6 md:px-8 py-3 md:py-4 bg-slate-800 text-white rounded-full font-bold shadow-lg hover:bg-slate-700 hover:shadow-xl transition-all">
                <i data-lucide="refresh-ccw" class="w-5 h-5 group-hover:rotate-180 transition-transform duration-500"></i>
                <span>å¿ƒæƒ…å¥½ç‚¹äº†å—ï¼Ÿå†è¯•ä¸€æ¬¡</span>
            </button>
        </div>
    </main>

    <!-- History Modal -->
    <div id="historyModal" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop absolute inset-0" id="historyBackdrop"></div>
        <div class="absolute inset-0 md:inset-10 flex items-center justify-center pointer-events-none">
            <div class="bg-cream w-full max-w-lg h-full md:h-auto md:max-h-[80vh] flex flex-col rounded-none md:rounded-2xl shadow-2xl overflow-hidden pointer-events-auto border-0 md:border-4 border-white fade-in">
                <!-- Header -->
                <div class="p-4 md:p-6 border-b border-gray-100 flex justify-between items-center bg-white/50">
                    <h2 class="text-lg md:text-xl font-cute text-slate-700">ğŸ“œ æ²»æ„ˆæ—…ç¨‹</h2>
                    <div class="flex gap-2 items-center">
                        <button id="clearHistoryBtn" class="text-xs text-red-400 hover:text-red-600 underline mr-2 md:mr-4 hidden">
                            æ¸…ç©ºè®°å½•
                        </button>
                        <button id="closeHistoryBtn" class="text-slate-400 hover:text-slate-600 transition-colors">
                            <i data-lucide="x" class="w-5 h-5 md:w-6 md:h-6"></i>
                        </button>
                    </div>
                </div>

                <!-- Content -->
                <div id="historyContent" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-4 bg-slate-50/50">
                    <!-- History items will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop absolute inset-0" id="settingsBackdrop"></div>
        <div class="absolute inset-0 md:inset-10 flex items-center justify-center pointer-events-none">
            <div class="bg-cream w-full max-w-md h-auto max-h-[90vh] flex flex-col rounded-none md:rounded-2xl shadow-2xl overflow-hidden pointer-events-auto border-0 md:border-4 border-white fade-in m-4">
                <!-- Header -->
                <div class="p-4 md:p-6 border-b border-gray-100 flex justify-between items-center bg-white/50">
                    <h2 class="text-lg md:text-xl font-cute text-slate-700">âš™ï¸ è®¾ç½®</h2>
                    <button id="closeSettingsBtn" class="text-slate-400 hover:text-slate-600 transition-colors">
                        <i data-lucide="x" class="w-5 h-5 md:w-6 md:h-6"></i>
                    </button>
                </div>

                <!-- Content -->
                <div class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6">
                    <!-- Gemini API Key -->
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex items-center gap-2 mb-3">
                            <i data-lucide="sparkles" class="w-5 h-5 text-purple-500"></i>
                            <h3 class="font-cute text-slate-700">AI å®‰æ…°è¯è¯­</h3>
                        </div>
                        <p class="text-xs text-slate-400 mb-3">é…ç½® Google Gemini API Key ä»¥è·å– AI ç”Ÿæˆçš„ä¸ªæ€§åŒ–å®‰æ…°è¯è¯­</p>
                        <input type="password" id="apiKeyInput" placeholder="è¾“å…¥ Gemini API Key..."
                               class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-300 focus:border-transparent">
                        <div class="flex gap-2 mt-3">
                            <button id="saveApiKeyBtn" class="flex-1 px-4 py-2 bg-purple-500 text-white rounded-lg text-sm font-bold hover:bg-purple-600 transition-colors">
                                ä¿å­˜
                            </button>
                            <button id="clearApiKeyBtn" class="px-4 py-2 bg-slate-200 text-slate-600 rounded-lg text-sm hover:bg-slate-300 transition-colors">
                                æ¸…é™¤
                            </button>
                        </div>
                        <p id="apiKeyStatus" class="text-xs mt-2 text-slate-400"></p>
                    </div>

                    <!-- Sound Settings -->
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex items-center gap-2 mb-3">
                            <i data-lucide="volume-2" class="w-5 h-5 text-blue-500"></i>
                            <h3 class="font-cute text-slate-700">å£°éŸ³è®¾ç½®</h3>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-slate-600">éŸ³æ•ˆå¼€å…³</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="soundToggle" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"></div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // çŠ¶æ€ç®¡ç†
        // ============================================
        const AppState = {
            IDLE: 'IDLE',
            PROCESSING: 'PROCESSING',
            SHOW_RESULT: 'SHOW_RESULT'
        };

        const ToolType = {
            ROCKET: 'ROCKET',
            SHREDDER: 'SHREDDER',
            BUBBLE: 'BUBBLE',
            BLACK_HOLE: 'BLACK_HOLE'
        };

        let state = {
            appState: AppState.IDLE,
            moodText: '',
            selectedTool: null,
            comfortMessage: '',
            history: [],
            isMuted: false,
            apiKey: ''
        };

        // ============================================
        // éŸ³æ•ˆå¼•æ“
        // ============================================
        class SoundEngine {
            constructor() {
                this.ctx = null;
                this.isMuted = false;
                this.masterGain = null;
            }

            init() {
                if (!this.ctx) {
                    const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AudioContextClass();
                    this.masterGain = this.ctx.createGain();
                    this.masterGain.connect(this.ctx.destination);
                    this.masterGain.gain.value = 0.4;
                }
                if (this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }
            }

            toggleMute(muted) {
                this.isMuted = muted;
                if (this.masterGain && this.ctx) {
                    this.masterGain.gain.setValueAtTime(muted ? 0 : 0.4, this.ctx.currentTime);
                }
            }

            playToolSound(tool) {
                if (this.isMuted || !this.ctx) return;
                switch (tool) {
                    case ToolType.ROCKET: this.playRocketSound(); break;
                    case ToolType.SHREDDER: this.playShredderSound(); break;
                    case ToolType.BUBBLE: this.playBubbleSound(); break;
                    case ToolType.BLACK_HOLE: this.playBlackHoleSound(); break;
                }
            }

            playHealSound() {
                if (this.isMuted || !this.ctx) return;
                this.playChime();
            }

            createNoiseBuffer() {
                if (!this.ctx) return null;
                const bufferSize = this.ctx.sampleRate * 2;
                const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) {
                    data[i] = Math.random() * 2 - 1;
                }
                return buffer;
            }

            playRocketSound() {
                if (!this.ctx || !this.masterGain) return;
                const t = this.ctx.currentTime;

                const noiseBuffer = this.createNoiseBuffer();
                if (!noiseBuffer) return;

                const noise = this.ctx.createBufferSource();
                noise.buffer = noiseBuffer;
                noise.loop = true;

                const noiseFilter = this.ctx.createBiquadFilter();
                noiseFilter.type = 'lowpass';
                noiseFilter.frequency.setValueAtTime(200, t);
                noiseFilter.frequency.exponentialRampToValueAtTime(1000, t + 2);

                const noiseGain = this.ctx.createGain();
                noiseGain.gain.setValueAtTime(0, t);
                noiseGain.gain.linearRampToValueAtTime(0.8, t + 0.2);
                noiseGain.gain.linearRampToValueAtTime(0, t + 3);

                noise.connect(noiseFilter);
                noiseFilter.connect(noiseGain);
                noiseGain.connect(this.masterGain);
                noise.start(t);
                noise.stop(t + 3.1);

                const osc = this.ctx.createOscillator();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(100, t);
                osc.frequency.exponentialRampToValueAtTime(600, t + 3);

                const oscGain = this.ctx.createGain();
                oscGain.gain.setValueAtTime(0.1, t);
                oscGain.gain.linearRampToValueAtTime(0, t + 3);

                osc.connect(oscGain);
                oscGain.connect(this.masterGain);
                osc.start(t);
                osc.stop(t + 3.1);
            }

            playShredderSound() {
                if (!this.ctx || !this.masterGain) return;
                const t = this.ctx.currentTime;
                const duration = 2.5;

                const noiseBuffer = this.createNoiseBuffer();
                if (!noiseBuffer) return;
                const noise = this.ctx.createBufferSource();
                noise.buffer = noiseBuffer;
                noise.loop = true;

                const filter = this.ctx.createBiquadFilter();
                filter.type = 'bandpass';
                filter.frequency.value = 400;
                filter.Q.value = 1;

                const lfo = this.ctx.createOscillator();
                lfo.type = 'sawtooth';
                lfo.frequency.value = 15;

                const lfoGain = this.ctx.createGain();
                lfoGain.gain.value = 500;

                lfo.connect(lfoGain);
                lfoGain.connect(filter.frequency);
                lfo.start(t);

                const gain = this.ctx.createGain();
                gain.gain.setValueAtTime(0, t);
                gain.gain.linearRampToValueAtTime(0.5, t + 0.1);
                gain.gain.setValueAtTime(0.5, t + duration - 0.1);
                gain.gain.linearRampToValueAtTime(0, t + duration);

                noise.connect(filter);
                filter.connect(gain);
                gain.connect(this.masterGain);

                noise.start(t);
                noise.stop(t + duration);
                lfo.stop(t + duration);
            }

            playBubbleSound() {
                if (!this.ctx || !this.masterGain) return;
                const t = this.ctx.currentTime;

                for (let i = 0; i < 8; i++) {
                    const offset = i * 0.3 + Math.random() * 0.1;
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();

                    osc.frequency.setValueAtTime(400 + Math.random() * 400, t + offset);
                    osc.frequency.exponentialRampToValueAtTime(1200 + Math.random() * 400, t + offset + 0.1);

                    gain.gain.setValueAtTime(0, t + offset);
                    gain.gain.linearRampToValueAtTime(0.3, t + offset + 0.02);
                    gain.gain.exponentialRampToValueAtTime(0.01, t + offset + 0.15);

                    osc.connect(gain);
                    gain.connect(this.masterGain);

                    osc.start(t + offset);
                    osc.stop(t + offset + 0.2);
                }
            }

            playBlackHoleSound() {
                if (!this.ctx || !this.masterGain) return;
                const t = this.ctx.currentTime;
                const duration = 3;

                const osc = this.ctx.createOscillator();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(100, t);
                osc.frequency.exponentialRampToValueAtTime(30, t + duration);

                const gain = this.ctx.createGain();
                gain.gain.setValueAtTime(0, t);
                gain.gain.linearRampToValueAtTime(0.6, t + 0.5);
                gain.gain.linearRampToValueAtTime(0, t + duration);

                const lfo = this.ctx.createOscillator();
                lfo.frequency.value = 8;
                const lfoGain = this.ctx.createGain();
                lfoGain.gain.value = 0.3;

                lfo.connect(lfoGain);
                lfoGain.connect(gain.gain);
                lfo.start(t);

                osc.connect(gain);
                gain.connect(this.masterGain);
                osc.start(t);
                osc.stop(t + duration);
                lfo.stop(t + duration);
            }

            playChime() {
                if (!this.ctx || !this.masterGain) return;
                const t = this.ctx.currentTime;
                const freqs = [523.25, 659.25, 783.99, 1046.50];

                freqs.forEach((freq, i) => {
                    const osc = this.ctx.createOscillator();
                    osc.type = 'sine';
                    osc.frequency.value = freq;

                    const gain = this.ctx.createGain();
                    gain.gain.setValueAtTime(0, t);
                    gain.gain.linearRampToValueAtTime(0.15, t + 0.1 + (i * 0.05));
                    gain.gain.exponentialRampToValueAtTime(0.001, t + 3);

                    osc.connect(gain);
                    gain.connect(this.masterGain);
                    osc.start(t);
                    osc.stop(t + 3.1);
                });
            }
        }

        const soundEngine = new SoundEngine();

        // ============================================
        // Gemini API æœåŠ¡
        // ============================================
        const fallbackMessages = [
            "æ·±å‘¼å¸ï¼Œä¸€åˆ‡éƒ½ä¼šå¥½èµ·æ¥çš„ã€‚",
            "çƒ¦æ¼å·²ç»é£èµ°å•¦ï¼Œä½ æ˜¯æœ€æ£’çš„ï¼",
            "ä»Šå¤©çš„ä¸å¼€å¿ƒå°±ç•™ç»™æ˜¨å¤©å§ï¼Œæ˜å¤©æ˜¯æ–°çš„å¼€å§‹ã€‚",
            "æŠ±æŠ±ä½ ï¼Œæ²¡å…³ç³»çš„ï¼Œæ…¢æ…¢æ¥ã€‚",
            "åƒå°çŒ«æ™’å¤ªé˜³ä¸€æ ·ï¼Œæ”¾æ¾ä¸€ä¸‹å§ã€‚",
            "åæƒ…ç»ªå·²ç»è¢«æ‰“åŒ…é€èµ°å•¦ï¼Œå¿ƒæƒ…ä¼šå˜æ™´æœ—çš„ï¼",
            "ä½ å¾ˆå‹‡æ•¢ï¼Œæ·±å‘¼å¸ï¼Œä¸–ç•Œä¾ç„¶çˆ±ä½ ã€‚",
            "çƒ¦æ¼å˜æˆæ˜Ÿæ˜Ÿç¢ç‰‡å•¦ï¼Œä»Šæ™šä¼šåšä¸€ä¸ªå¥½æ¢¦ã€‚",
            "ç”Ÿæ´»æœ‰æ—¶å€™å¾ˆéš¾ï¼Œä½†ä½ å·²ç»åšå¾—å¾ˆå¥½äº†ã€‚",
            "æ¯ä¸€ä¸ªå°å›°éš¾éƒ½æ˜¯æˆé•¿çš„å…»æ–™ã€‚",
            "æ­¤åˆ»çš„ä¸å¼€å¿ƒï¼Œåªæ˜¯æš‚æ—¶çš„å°æ’æ›²ã€‚",
            "ä½ å€¼å¾—è¢«æ¸©æŸ”ä»¥å¾…ï¼ŒåŒ…æ‹¬ä½ è‡ªå·±ã€‚"
        ];

        // é»˜è®¤ API Key
        const DEFAULT_GEMINI_API_KEY = 'AIzaSyDKi_BRyAKb5xC38Z9F1dTpL7xTZgHg600';

        async function getComfortingMessage(badMood) {
            // ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·é…ç½®çš„ Keyï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤ Key
            const apiKey = localStorage.getItem('geminiApiKey') || DEFAULT_GEMINI_API_KEY;

            console.log('[Gemini] Calling API with key:', apiKey.substring(0, 10) + '...');

            try {
                // ä½¿ç”¨ gemini-pro æ¨¡å‹ï¼ˆæ›´ç¨³å®šï¼‰
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `ç”¨æˆ·å†™ä¸‹äº†è¿™ä¸ªåå¿ƒæƒ…ï¼š"${badMood}"ã€‚ä»–ä»¬åˆšåˆšé€šè¿‡äº¤äº’åŠ¨ç”»é”€æ¯äº†è¿™å¼ ä¾¿ç­¾ã€‚
è¯·å†™ä¸€å¥ç®€çŸ­ã€æ¸©æš–ã€æ²»æ„ˆçš„ä¸­æ–‡ï¼ˆ30å­—ä»¥å†…ï¼‰ï¼Œç”¨æ¸©æŸ”ã€å¯çˆ±æˆ–ç•¥å¸¦å“²ç†çš„è¯­æ°”å®‰æŠšä»–ä»¬ã€‚
ä¸è¦è¯´æ•™ï¼Œåªè¦é™ªä¼´å’Œé¼“åŠ±ã€‚ä¾‹å¦‚ï¼š"çƒ¦æ¼å˜æˆæ˜Ÿæ˜Ÿç¢ç‰‡å•¦ï¼Œä»Šæ™šä¼šåšä¸€ä¸ªå¥½æ¢¦ã€‚"
åªè¾“å‡ºå®‰æ…°çš„è¯ï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–å†…å®¹ã€‚`
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.9,
                            maxOutputTokens: 100
                        }
                    })
                });

                console.log('[Gemini] Response status:', response.status);

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('[Gemini] API error:', errorData);
                    throw new Error(`API request failed: ${response.status}`);
                }

                const data = await response.json();
                console.log('[Gemini] Response data:', data);
                
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) {
                    console.log('[Gemini] Generated message:', text.trim());
                    return text.trim();
                }
                
                console.log('[Gemini] No text in response, using fallback');
                return fallbackMessages[Math.floor(Math.random() * fallbackMessages.length)];
            } catch (error) {
                console.error("[Gemini] Error fetching comfort message:", error);
                return fallbackMessages[Math.floor(Math.random() * fallbackMessages.length)];
            }
        }

        // ============================================
        // DOM å…ƒç´ 
        // ============================================
        const elements = {
            moodText: document.getElementById('moodText'),
            toolHint: document.getElementById('toolHint'),
            toolBtns: document.querySelectorAll('.tool-btn'),
            inputStage: document.getElementById('inputStage'),
            processingStage: document.getElementById('processingStage'),
            processingText: document.getElementById('processingText'),
            animationContainer: document.getElementById('animationContainer'),
            resultStage: document.getElementById('resultStage'),
            comfortMessage: document.getElementById('comfortMessage'),
            heartIcon: document.getElementById('heartIcon'),
            resetBtn: document.getElementById('resetBtn'),
            mascot: document.getElementById('mascot'),
            faceIdle: document.getElementById('faceIdle'),
            faceProcessing: document.getElementById('faceProcessing'),
            faceResult: document.getElementById('faceResult'),
            muteBtn: document.getElementById('muteBtn'),
            volumeIcon: document.getElementById('volumeIcon'),
            historyBtn: document.getElementById('historyBtn'),
            historyModal: document.getElementById('historyModal'),
            historyBackdrop: document.getElementById('historyBackdrop'),
            historyContent: document.getElementById('historyContent'),
            closeHistoryBtn: document.getElementById('closeHistoryBtn'),
            clearHistoryBtn: document.getElementById('clearHistoryBtn'),
            settingsBtn: document.getElementById('settingsBtn'),
            settingsModal: document.getElementById('settingsModal'),
            settingsBackdrop: document.getElementById('settingsBackdrop'),
            closeSettingsBtn: document.getElementById('closeSettingsBtn'),
            apiKeyInput: document.getElementById('apiKeyInput'),
            saveApiKeyBtn: document.getElementById('saveApiKeyBtn'),
            clearApiKeyBtn: document.getElementById('clearApiKeyBtn'),
            apiKeyStatus: document.getElementById('apiKeyStatus'),
            soundToggle: document.getElementById('soundToggle')
        };

        // ============================================
        // åˆå§‹åŒ–
        // ============================================
        function init() {
            // åˆå§‹åŒ– Lucide å›¾æ ‡
            lucide.createIcons();

            // åŠ è½½å†å²è®°å½•
            loadHistory();

            // åŠ è½½è®¾ç½®
            loadSettings();

            // ç»‘å®šäº‹ä»¶
            bindEvents();

            // æ›´æ–° API Key çŠ¶æ€
            updateApiKeyStatus();
        }

        function loadHistory() {
            const saved = localStorage.getItem('crushHistory');
            if (saved) {
                try {
                    state.history = JSON.parse(saved);
                } catch (e) {
                    console.error("Failed to parse history");
                    state.history = [];
                }
            }
        }

        function loadSettings() {
            const muted = localStorage.getItem('soundMuted') === 'true';
            state.isMuted = muted;
            soundEngine.toggleMute(muted);
            updateMuteButton();

            const apiKey = localStorage.getItem('geminiApiKey');
            if (apiKey) {
                state.apiKey = apiKey;
                elements.apiKeyInput.value = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
            }

            elements.soundToggle.checked = !muted;
        }

        function bindEvents() {
            // æ–‡æœ¬è¾“å…¥
            elements.moodText.addEventListener('input', handleTextInput);

            // å·¥å…·æŒ‰é’®
            elements.toolBtns.forEach(btn => {
                btn.addEventListener('click', () => handleToolSelect(btn.dataset.tool));
            });

            // é‡ç½®æŒ‰é’®
            elements.resetBtn.addEventListener('click', handleReset);

            // é™éŸ³æŒ‰é’®
            elements.muteBtn.addEventListener('click', toggleMute);

            // å†å²è®°å½•
            elements.historyBtn.addEventListener('click', openHistory);
            elements.closeHistoryBtn.addEventListener('click', closeHistory);
            elements.historyBackdrop.addEventListener('click', closeHistory);
            elements.clearHistoryBtn.addEventListener('click', clearHistory);

            // è®¾ç½®
            elements.settingsBtn.addEventListener('click', openSettings);
            elements.closeSettingsBtn.addEventListener('click', closeSettings);
            elements.settingsBackdrop.addEventListener('click', closeSettings);
            elements.saveApiKeyBtn.addEventListener('click', saveApiKey);
            elements.clearApiKeyBtn.addEventListener('click', clearApiKey);
            elements.soundToggle.addEventListener('change', handleSoundToggle);
        }

        // ============================================
        // äº‹ä»¶å¤„ç†
        // ============================================
        function handleTextInput() {
            state.moodText = elements.moodText.value;
            const hasText = state.moodText.trim().length > 0;

            // æ›´æ–°å·¥å…·æç¤º
            elements.toolHint.style.opacity = hasText ? '1' : '0';

            // æ›´æ–°å·¥å…·æŒ‰é’®çŠ¶æ€
            elements.toolBtns.forEach(btn => {
                if (hasText) {
                    btn.disabled = false;
                    btn.classList.remove('opacity-40', 'cursor-not-allowed');
                    btn.classList.add('cursor-pointer', 'hover:shadow-xl', 'hover:scale-110', 'hover:-translate-y-1');
                } else {
                    btn.disabled = true;
                    btn.classList.add('opacity-40', 'cursor-not-allowed');
                    btn.classList.remove('cursor-pointer', 'hover:shadow-xl', 'hover:scale-110', 'hover:-translate-y-1');
                }
            });
        }

        async function handleToolSelect(tool) {
            // åˆå§‹åŒ–éŸ³é¢‘
            soundEngine.init();

            state.selectedTool = tool;
            state.appState = AppState.PROCESSING;

            // æ›´æ–° UI
            updateMascotFace('processing');
            elements.mascot.classList.add('mascot-processing');

            // éšè—è¾“å…¥é˜¶æ®µï¼Œæ˜¾ç¤ºå¤„ç†é˜¶æ®µ
            elements.inputStage.classList.add('hidden');
            elements.processingStage.classList.remove('hidden');

            // è®¾ç½®å¤„ç†æ–‡æœ¬
            const processingTexts = {
                [ToolType.ROCKET]: "æ­£åœ¨è£…å¡«ç«ç®­ç‡ƒæ–™...",
                [ToolType.SHREDDER]: "å¼ºåŠ›ç²‰ç¢ä¸­...",
                [ToolType.BUBBLE]: "å˜èº«é­”æ³•æ³¡æ³¡...",
                [ToolType.BLACK_HOLE]: "æ­£åœ¨æ‰“å¼€è™«æ´..."
            };
            elements.processingText.textContent = processingTexts[tool];

            // æ’­æ”¾éŸ³æ•ˆ
            soundEngine.playToolSound(tool);

            // æ¸²æŸ“åŠ¨ç”»
            renderAnimation(tool);

            // è·å–å®‰æ…°æ¶ˆæ¯
            state.comfortMessage = await getComfortingMessage(state.moodText);

            // åŠ¨ç”»å®Œæˆåæ˜¾ç¤ºç»“æœ
            setTimeout(() => {
                handleAnimationComplete();
            }, 4500);
        }

        function handleAnimationComplete() {
            state.appState = AppState.SHOW_RESULT;

            // æ›´æ–° UI
            updateMascotFace('result');
            elements.mascot.classList.remove('mascot-processing');

            // éšè—å¤„ç†é˜¶æ®µï¼Œæ˜¾ç¤ºç»“æœé˜¶æ®µ
            elements.processingStage.classList.add('hidden');
            elements.animationContainer.innerHTML = '';
            elements.resultStage.classList.remove('hidden');
            elements.resultStage.classList.add('fade-in');

            // æ˜¾ç¤ºå®‰æ…°æ¶ˆæ¯
            elements.comfortMessage.textContent = state.comfortMessage || "æ­£åœ¨æ¥æ”¶æ¥è‡ªå®‡å®™çš„ä¿¡å·...";

            // å¿ƒå½¢å›¾æ ‡åŠ¨ç”»
            setTimeout(() => {
                elements.heartIcon.style.transform = 'scale(1)';
            }, 200);

            // æ’­æ”¾æ²»æ„ˆéŸ³æ•ˆ
            soundEngine.playHealSound();

            // æ·»åŠ åˆ°å†å²è®°å½•
            if (state.selectedTool && state.moodText) {
                addToHistory(state.moodText, state.selectedTool, state.comfortMessage);
            }

            // é‡æ–°åˆå§‹åŒ–å›¾æ ‡
            lucide.createIcons();
        }

        function handleReset() {
            state.moodText = '';
            state.comfortMessage = '';
            state.selectedTool = null;
            state.appState = AppState.IDLE;

            // é‡ç½® UI
            elements.moodText.value = '';
            elements.toolHint.style.opacity = '0';
            elements.heartIcon.style.transform = 'scale(0)';

            // é‡ç½®å·¥å…·æŒ‰é’®
            elements.toolBtns.forEach(btn => {
                btn.disabled = true;
                btn.classList.add('opacity-40', 'cursor-not-allowed');
                btn.classList.remove('cursor-pointer', 'hover:shadow-xl', 'hover:scale-110', 'hover:-translate-y-1');
            });

            // æ›´æ–°å‰ç¥¥ç‰©
            updateMascotFace('idle');

            // åˆ‡æ¢é˜¶æ®µ
            elements.resultStage.classList.add('hidden');
            elements.resultStage.classList.remove('fade-in');
            elements.inputStage.classList.remove('hidden');
            elements.inputStage.classList.add('fade-in');
        }

        function toggleMute() {
            state.isMuted = !state.isMuted;
            soundEngine.toggleMute(state.isMuted);
            localStorage.setItem('soundMuted', state.isMuted);
            updateMuteButton();
            elements.soundToggle.checked = !state.isMuted;
        }

        function handleSoundToggle() {
            state.isMuted = !elements.soundToggle.checked;
            soundEngine.toggleMute(state.isMuted);
            localStorage.setItem('soundMuted', state.isMuted);
            updateMuteButton();
        }

        function updateMuteButton() {
            const icon = state.isMuted ? 'volume-x' : 'volume-2';
            // ç›´æ¥æ›¿æ¢æ•´ä¸ªæŒ‰é’®å†…çš„å›¾æ ‡
            const muteBtn = elements.muteBtn;
            muteBtn.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5"></i>`;
            lucide.createIcons({ nodes: [muteBtn] });
        }

        // ============================================
        // å‰ç¥¥ç‰©
        // ============================================
        function updateMascotFace(face) {
            elements.faceIdle.style.display = face === 'idle' ? 'block' : 'none';
            elements.faceProcessing.style.display = face === 'processing' ? 'block' : 'none';
            elements.faceResult.style.display = face === 'result' ? 'block' : 'none';
        }

        // ============================================
        // åŠ¨ç”»æ¸²æŸ“
        // ============================================
        function renderAnimation(tool) {
            elements.animationContainer.innerHTML = '';

            switch (tool) {
                case ToolType.ROCKET:
                    renderRocketAnimation();
                    break;
                case ToolType.SHREDDER:
                    renderShredderAnimation();
                    break;
                case ToolType.BUBBLE:
                    renderBubbleAnimation();
                    break;
                case ToolType.BLACK_HOLE:
                    renderBlackHoleAnimation();
                    break;
            }
        }

        function renderRocketAnimation() {
            const container = elements.animationContainer;
            
            // Stars background
            for (let i = 0; i < 20; i++) {
                const star = document.createElement('div');
                star.className = 'absolute bg-yellow-200 rounded-full star';
                star.style.cssText = `
                    left: ${Math.random() * 100}%;
                    top: ${Math.random() * 100}%;
                    width: ${Math.random() * 4 + 2}px;
                    height: ${Math.random() * 4 + 2}px;
                    animation-delay: ${Math.random() * 2}s;
                `;
                container.appendChild(star);
            }

            // Rocket with paper
            const rocketGroup = document.createElement('div');
            rocketGroup.className = 'relative flex flex-col items-center z-10 rocket-launch';
            rocketGroup.innerHTML = `
                <!-- Paper -->
                <div class="w-12 h-12 md:w-16 md:h-16 bg-pastel-yellow shadow-inner flex items-center justify-center p-1 mb-[-10px] z-10 rounded-full border border-yellow-500/30">
                    <div class="w-full h-full bg-yellow-300/50 rounded-full"></div>
                </div>
                <!-- Rocket -->
                <div class="text-red-500 relative z-20" style="animation: shake 0.2s infinite;">
                    <svg class="w-16 h-16 md:w-20 md:h-20 transform -rotate-45 drop-shadow-lg" viewBox="0 0 24 24" fill="#f87171" stroke="#f87171" stroke-width="1">
                        <path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/>
                        <path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/>
                        <path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"/>
                        <path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"/>
                    </svg>
                    <div class="absolute top-1/2 left-1/2 w-3 h-3 md:w-4 md:h-4 bg-blue-200 rounded-full border-2 border-white transform -translate-x-1/2 -translate-y-1/2"></div>
                </div>
                <!-- Fire -->
                <div class="w-6 h-16 md:w-8 md:h-24 bg-gradient-to-t from-transparent via-orange-400 to-yellow-300 rounded-full blur-sm mt-[-20px] relative z-0 fire-trail"></div>
            `;
            container.appendChild(rocketGroup);

            // Smoke particles
            for (let i = 0; i < 5; i++) {
                const smoke = document.createElement('div');
                smoke.className = 'absolute w-4 h-4 md:w-6 md:h-6 bg-white rounded-full opacity-60 blur-md';
                smoke.style.cssText = `
                    bottom: 20%;
                    left: 50%;
                    animation: smokeRise 1s infinite;
                    animation-delay: ${i * 0.1}s;
                    --tx: ${(i - 2) * 40}px;
                `;
                container.appendChild(smoke);
            }

            // Add smoke animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes smokeRise {
                    0% { transform: translateY(0) translateX(0); opacity: 0.6; }
                    100% { transform: translateY(200px) translateX(var(--tx)); opacity: 0; scale: 2; }
                }
            `;
            document.head.appendChild(style);
        }

        function renderShredderAnimation() {
            const container = elements.animationContainer;
            
            container.innerHTML = `
                <div class="flex flex-col items-center">
                    <!-- Machine Head -->
                    <div class="relative z-20 bg-slate-100 w-56 md:w-72 h-16 md:h-20 rounded-t-2xl shadow-md flex items-center justify-center border-b-8 border-slate-200">
                        <div class="w-44 md:w-56 h-2 md:h-3 bg-slate-800 rounded-full opacity-10"></div>
                        <div class="absolute right-4 top-4 w-2 h-2 md:w-3 md:h-3 bg-green-400 rounded-full shadow-[0_0_10px_rgba(74,222,128,0.8)] animate-pulse"></div>
                    </div>

                    <div class="relative w-56 md:w-72 flex justify-center" style="perspective: 1000px;">
                        <!-- Paper feeding in -->
                        <div class="absolute -top-56 md:-top-72 bg-pastel-yellow w-44 md:w-56 h-56 md:h-72 p-4 md:p-6 shadow-md overflow-hidden text-slate-400 text-xs md:text-sm font-hand"
                             style="animation: paperFeed 2s linear forwards;">
                            <div class="w-full h-full border-2 border-dashed border-yellow-300 p-2">
                                ${state.moodText}
                            </div>
                        </div>

                        <!-- Shredded strips -->
                        <div class="absolute top-0 w-52 md:w-64 flex justify-between overflow-hidden h-[350px] md:h-[450px] px-2" id="shreddedStrips">
                        </div>
                    </div>

                    <!-- Machine Body -->
                    <div class="relative z-20 bg-slate-100 w-56 md:w-72 h-24 md:h-32 rounded-b-2xl shadow-xl flex items-center justify-center flex-col gap-2">
                        <div class="text-slate-300 text-xs md:text-sm font-bold tracking-widest font-cute">MOOD SHREDDER 3000</div>
                        <div class="flex gap-2">
                            <div class="w-12 md:w-16 h-1 bg-slate-200 rounded"></div>
                            <div class="w-12 md:w-16 h-1 bg-slate-200 rounded"></div>
                        </div>
                    </div>
                </div>
            `;

            // Add paper feed animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes paperFeed {
                    0% { transform: translateY(-200px); }
                    100% { transform: translateY(100px); }
                }
            `;
            document.head.appendChild(style);

            // Add shredded strips after delay
            setTimeout(() => {
                const stripsContainer = document.getElementById('shreddedStrips');
                if (stripsContainer) {
                    for (let i = 0; i < 12; i++) {
                        const strip = document.createElement('div');
                        strip.className = 'w-3 md:w-4 bg-pastel-yellow shadow-sm shred-strip';
                        strip.style.cssText = `
                            height: 60px;
                            animation-delay: ${2 + Math.random() * 0.5}s;
                            --tx: ${(Math.random() - 0.5) * 80}px;
                        `;
                        strip.innerHTML = '<div class="w-full h-full bg-yellow-300/20"></div>';
                        stripsContainer.appendChild(strip);
                    }
                }
            }, 100);
        }

        function renderBubbleAnimation() {
            const container = elements.animationContainer;
            
            // Wand
            const wand = document.createElement('div');
            wand.className = 'absolute bottom-[-20px] left-[10%] w-4 md:w-6 h-32 md:h-40 bg-pink-300 rounded-full origin-bottom z-10';
            wand.style.cssText = 'animation: wandWave 2s ease-in-out;';
            wand.innerHTML = '<div class="absolute -top-8 md:-top-10 -left-5 md:-left-6 w-12 md:w-16 h-12 md:h-16 border-4 border-pink-300 rounded-full"></div>';
            container.appendChild(wand);

            // Add wand animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes wandWave {
                    0% { transform: rotate(-45deg) translateY(100px); }
                    50% { transform: rotate(-20deg) translateY(0); }
                    100% { transform: rotate(-45deg) translateY(0); }
                }
            `;
            document.head.appendChild(style);

            // Split text into bubbles
            const chunks = state.moodText.match(/.{1,4}/g) || ["..."];
            const bubbles = chunks.slice(0, 15);

            bubbles.forEach((chunk, i) => {
                const bubble = document.createElement('div');
                const size = Math.max(40, chunk.length * 12);
                bubble.className = 'bubble absolute flex items-center justify-center bg-gradient-to-tr from-blue-100/40 to-pink-100/40 backdrop-blur-sm border border-white/60 rounded-full shadow-sm text-slate-500 text-xs px-2 text-center break-all leading-tight font-hand';
                bubble.style.cssText = `
                    width: ${size}px;
                    height: ${size}px;
                    left: 50%;
                    top: 60%;
                    --tx: ${(Math.random() - 0.5) * 400}px;
                    animation-duration: ${4 + Math.random() * 2}s;
                    animation-delay: ${0.5 + i * 0.3}s;
                `;
                bubble.innerHTML = `
                    <div class="absolute top-[15%] left-[15%] w-[20%] h-[20%] bg-white rounded-full opacity-80 blur-[1px]"></div>
                    <div class="absolute bottom-[15%] right-[15%] w-[10%] h-[10%] bg-white rounded-full opacity-60 blur-[1px]"></div>
                    <span class="opacity-70">${chunk}</span>
                `;
                container.appendChild(bubble);
            });
        }

        function renderBlackHoleAnimation() {
            const container = elements.animationContainer;
            
            // Black hole
            const blackHole = document.createElement('div');
            blackHole.className = 'black-hole absolute rounded-full flex items-center justify-center z-10 bg-slate-900';
            blackHole.innerHTML = `
                <div class="absolute inset-0 rounded-full border-4 border-indigo-500/20 animate-spin-slow"></div>
                <div class="absolute inset-2 rounded-full border-4 border-purple-500/20" style="animation: spin 2s linear infinite reverse;"></div>
                <div class="w-full h-full rounded-full shadow-[inset_0_0_50px_rgba(0,0,0,1)]" style="background: radial-gradient(circle at center, #312e81 0%, #000 70%);"></div>
            `;
            container.appendChild(blackHole);

            // Paper getting sucked in
            const paper = document.createElement('div');
            paper.className = 'paper-suck relative bg-pastel-yellow w-48 md:w-64 h-48 md:h-64 flex items-center justify-center p-4 md:p-6 shadow-xl';
            paper.innerHTML = `<p class="text-xs md:text-sm text-slate-400 font-hand line-through opacity-50">${state.moodText}</p>`;
            container.appendChild(paper);
        }

        // ============================================
        // å†å²è®°å½•
        // ============================================
        function addToHistory(text, tool, msg) {
            const newItem = {
                id: Date.now().toString(),
                timestamp: Date.now(),
                moodText: text,
                toolType: tool,
                comfortMessage: msg
            };
            state.history = [newItem, ...state.history];
            localStorage.setItem('crushHistory', JSON.stringify(state.history));
        }

        function openHistory() {
            elements.historyModal.classList.remove('hidden');
            renderHistoryContent();
        }

        function closeHistory() {
            elements.historyModal.classList.add('hidden');
        }

        function clearHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ²»æ„ˆè®°å½•å—ï¼Ÿ')) {
                state.history = [];
                localStorage.removeItem('crushHistory');
                renderHistoryContent();
            }
        }

        function renderHistoryContent() {
            const container = elements.historyContent;
            
            if (state.history.length === 0) {
                container.innerHTML = `
                    <div class="h-40 flex flex-col items-center justify-center text-slate-400">
                        <p class="font-cute text-lg">è¿˜æ²¡æœ‰è®°å½•å“¦</p>
                        <p class="text-xs mt-2">å¿«å»ç²‰ç¢ä½ çš„ç¬¬ä¸€ä¸ªåæƒ…ç»ªå§ï¼</p>
                    </div>
                `;
                elements.clearHistoryBtn.classList.add('hidden');
                return;
            }

            elements.clearHistoryBtn.classList.remove('hidden');

            const toolIcons = {
                [ToolType.ROCKET]: '<i data-lucide="rocket" class="w-4 h-4"></i>',
                [ToolType.SHREDDER]: '<i data-lucide="scissors" class="w-4 h-4"></i>',
                [ToolType.BUBBLE]: '<i data-lucide="wind" class="w-4 h-4"></i>',
                [ToolType.BLACK_HOLE]: '<i data-lucide="circle-dashed" class="w-4 h-4"></i>'
            };

            const toolColors = {
                [ToolType.ROCKET]: 'bg-red-100 text-red-500',
                [ToolType.SHREDDER]: 'bg-blue-100 text-blue-500',
                [ToolType.BUBBLE]: 'bg-purple-100 text-purple-500',
                [ToolType.BLACK_HOLE]: 'bg-slate-200 text-slate-700'
            };

            container.innerHTML = state.history.map(item => `
                <div class="bg-white p-4 md:p-5 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow relative overflow-hidden group">
                    <div class="absolute top-0 right-0 w-16 h-16 bg-gradient-to-bl from-gray-50 to-transparent pointer-events-none"></div>
                    
                    <!-- Top Row -->
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-2 px-2 py-1 rounded-lg text-xs font-bold ${toolColors[item.toolType]}">
                            ${toolIcons[item.toolType]}
                            <span>å·²ç²‰ç¢</span>
                        </div>
                        <div class="flex items-center text-xs text-slate-300 font-mono">
                            <i data-lucide="calendar" class="w-3 h-3 mr-1"></i>
                            ${new Date(item.timestamp).toLocaleDateString()}
                        </div>
                    </div>

                    <!-- Comfort Message -->
                    <p class="text-slate-600 font-hand text-base md:text-lg mb-4 leading-relaxed">
                        ${item.comfortMessage}
                    </p>

                    <!-- Crushed Mood -->
                    <div class="pt-3 border-t border-dashed border-gray-100">
                        <p class="text-xs text-slate-400 line-through truncate opacity-60 group-hover:opacity-100 transition-opacity">
                            ${item.moodText}
                        </p>
                    </div>
                </div>
            `).join('');

            lucide.createIcons();
        }

        // ============================================
        // è®¾ç½®
        // ============================================
        function openSettings() {
            elements.settingsModal.classList.remove('hidden');
            updateApiKeyStatus();
            lucide.createIcons();
        }

        function closeSettings() {
            elements.settingsModal.classList.add('hidden');
        }

        function saveApiKey() {
            const apiKey = elements.apiKeyInput.value.trim();
            if (apiKey && !apiKey.startsWith('â€¢â€¢')) {
                localStorage.setItem('geminiApiKey', apiKey);
                state.apiKey = apiKey;
                elements.apiKeyInput.value = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
                updateApiKeyStatus();
                alert('API Key å·²ä¿å­˜ï¼');
            }
        }

        function clearApiKey() {
            localStorage.removeItem('geminiApiKey');
            state.apiKey = '';
            elements.apiKeyInput.value = '';
            updateApiKeyStatus();
        }

        function updateApiKeyStatus() {
            const hasKey = !!localStorage.getItem('geminiApiKey');
            if (hasKey) {
                elements.apiKeyStatus.textContent = 'âœ… å·²é…ç½® - AI å®‰æ…°è¯è¯­å·²å¯ç”¨';
                elements.apiKeyStatus.className = 'text-xs mt-2 text-green-500';
            } else {
                elements.apiKeyStatus.textContent = 'âš ï¸ æœªé…ç½® - å°†ä½¿ç”¨é¢„è®¾å®‰æ…°è¯è¯­';
                elements.apiKeyStatus.className = 'text-xs mt-2 text-amber-500';
            }
        }

        // ============================================
        // å¯åŠ¨
        // ============================================
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
