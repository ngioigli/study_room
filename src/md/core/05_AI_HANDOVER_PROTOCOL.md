# AI Developer Handover Protocol (AI 开发交接协议)

**项目名称**: 无人自习室智能门禁与沉浸式助学平台
**交接对象**: 接手的下一位 AI 助手
**最后更新**: 2025-12-18

---

## 🛑 第一章：你的身份与交互准则 (CRITICAL)

**你现在的身份**：
你不仅是代码生成器，更是用户的**高级技术合伙人**与**首席架构师**。

**交互铁律 (必须严格遵守)**：
1.  **拒绝盲从**：如果用户提出的方案在工程上不可靠、不安全或过度设计，你必须**严厉、直接地指出**，并提供替代方案（Critical Thinking）。用户欣赏这种职业操守。
2.  **业务导向**：不要只写代码，要解释代码背后的**商业价值**和**用户体验思考**（例如：为什么要加倒计时？是为了防尾随审计）。
3.  **技术连贯性**：当前技术栈已升级为 **React + TypeScript + Vite**，请保持一致性，除非有重大架构变动需求。

---

## 🛑 第二章：项目上下文 (Project Context)

### 2.1 核心愿景
这是一个 **O2O (Online To Offline)** 项目。
*   **表面上**：解决线下无人自习室的门禁管理（动态二维码）。
*   **实际上**：解决备考族（考研/考公）的**心理焦虑**。
*   **产品调性**：温暖、治愈、不打鸡血、沉浸式陪伴。

### 2.2 核心痛点与解决方案
*   **痛点**：单二维码源导致的高并发冲突；无人值守导致的尾随风险。
*   **方案**：**抢占式原子锁 (Atomic Lock)** + **智能轮询 (Smart Polling)**。通过软件逻辑强制串行化通行，建立审计线索。

---

## 🛑 第三章：技术栈与架构约束 (Tech Stack)

*   **服务端**: Java 8/17 + Spring Boot 2.7+
    *   **ORM**: MyBatis-Plus (必须使用，已配置 `@MapperScan`)
    *   **DB**: MySQL / MariaDB
    *   **部署**: Linux Systemd + Fat Jar
*   **客户端 (硬件模拟)**:
    *   Python 3 + `pyautogui` (截图) + `requests` (上传)
    *   逻辑：死循环截屏 -> JPEG压缩 -> POST上传
*   **前端 (Web)**:
    *   **架构**: 前后端分离，React 前端独立开发
    *   **新版前端**: `cloud-study-room-ui/` 目录，React 18 + TypeScript + Vite 5 + Tailwind CSS
    *   **开发模式**: Vite 开发服务器 (5173)，API 代理到后端 (9090)
    *   **生产部署**: 构建后部署到 `src/main/resources/static/`
    *   **旧版备份**: 原有 HTML 页面保留在 `static/` 目录
    *   **适配**: 必须 Mobile-first (适配手机端)。
    *   **技术栈升级理由** (2026-01-13):
        - 项目复杂度已超出 Vue CDN 模式承载能力
        - 需要更强的状态管理（宠物 AI、音频混音、实时同步）
        - TypeScript 类型安全提升开发效率
        - 前后端分离是答辩加分项

---

## 🛑 第四章：核心业务逻辑快照 (Business Logic Snapshot)

接手前请务必理解以下逻辑，**不要破坏现有机制**：

### 4.1 门禁抢占逻辑 (已上线)
*   **后端**: 维护一个内存变量 `cooldownEndTime`。
*   **前端**:
    *   **空闲态**: 图片高斯模糊 + 遮罩层。每 3s 轮询一次 `/api/qr-status/check`。
    *   **锁定态**:
        *   **如果是本人锁的** (LocalStorage 校验)：图片清晰，无遮罩。
        *   **如果是别人锁的**: 图片模糊，显示“通道占用”。
        *   **共同点**: 停止轮询，启动本地纯 JS 倒计时 (3分钟)。
*   **决策背景**: 曾讨论过 WebSocket，但为了稳定性与低成本，最终选择了**“智能轮询+本地倒计时”**方案。

### 4.2 专注模式 (已上线)
*   **入口**: `focus.html`
*   **功能**: 正向计时器 + 底部 Dock 栏白噪音。
*   **交互**: 极简沉浸，背景呼吸暗化。

---

## 🛑 第五章：当前代码结构 (Codebase Structure)

*   **Controller**:
    *   `LoginController`: 处理登录/登出。
    *   `FileUploadController`: 处理 Python 脚本上传的图片 (无需登录)。
    *   `QrStatusController`: 处理锁定逻辑 (`/lock`) 和状态查询 (`/check`)。
*   **Config**:
    *   `WebConfig`: 配置了拦截器 `LoginInterceptor` (放行了 `/upload/**` 和 `/api/login`)，配置了静态资源映射。
*   **前端页面**:
    *   `login.html`: 云朵背景登录页。
    *   `qrcode.html`: 扫码大厅，含锁定逻辑和留言板。
    *   `focus.html`: 专注计时页。

-